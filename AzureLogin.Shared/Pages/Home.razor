@page "/"
@using AzureLogin.Shared.Services
@using System.Text
@using System.Text.Json
@using Microsoft.Extensions.Options
@inject IAzureOpenAIService AzureOpenAI
@inject IImageToCodeService ImageToCode
@inject IVisionService VisionService
@inject IImageExtractionService ImageExtraction
@inject IAzureVisionService? AzureVision
@inject IAdvancedAIService? AdvancedAI
@inject IDynamicRazorRenderer? RazorRenderer
@inject ISecureStorageService? SecureStorage
@inject IUrlLauncher UrlLauncher
@inject IJSRuntime JS
@inject IOptions<AzureOpenAISettings> AppSettings

<PageTitle>Azure OpenAI</PageTitle>

<style>
    .app-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
        padding: 1rem;
    }
    
    .glass-card {
        background: #ffffff;
        border: 1px solid #e2e4e8;
        transition: box-shadow 0.2s ease;
    }
    
    .glass-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }
    
    /* Drag and drop upload zone styles */
    .upload-zone {
        transition: all 0.2s ease;
    }
    
    .upload-zone.drag-over {
        border-color: #38ef7d !important;
        background: #f0fff4 !important;
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(56, 239, 125, 0.3);
    }
    
    .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .gradient-pink {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .btn-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        transition: all 0.2s ease;
    }
    
    .btn-gradient:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-gradient:disabled {
        opacity: 0.6;
    }
    
    .btn-gradient-pink {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .btn-gradient-pink:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none;
        color: white !important;
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        color: white !important;
    }
    
    .icon-circle {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        margin: 0 auto 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    
    .extraction-mode-btn:hover {
        background: #f0f4ff !important;
        border-color: #667eea !important;
    }
    
    .extraction-mode-btn:active {
        transform: scale(0.98);
        background: #e0e7ff !important;
    }
    
    /* Draggable Splitter Styles */
    .split-container {
        display: flex;
        flex-direction: row;
        height: 100%;
        min-height: 900px;
        gap: 0;
        width: 100%;
    }
    
    .split-pane-left {
        overflow: auto;
        min-width: 280px;
        max-width: 50%;
        height: 100%;
        flex-shrink: 0;
    }
    
    .split-pane-right {
        flex: 1;
        overflow: hidden;
        min-width: 400px;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .split-pane-right > * {
        flex: 1;
        min-height: 0;
    }
    
    .split-pane-right .code-output-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
        overflow: hidden;
    }
    
    .code-view-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
    }
    
    .code-split-view {
        flex: 1;
        display: flex;
        gap: 10px;
        min-height: 0;
        overflow: hidden;
    }
    
    .code-panel, .preview-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        min-width: 0;
        overflow: hidden;
    }
    
    .code-panel-content, .preview-panel-content {
        flex: 1;
        min-height: 0;
        overflow: auto;
        position: relative;
    }
    
    .preview-iframe-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    
    .preview-iframe-container iframe {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* Utility helpers for views to fully fill parents */
    .fill-area { width: 100%; height: 100%; min-height: 0; }
    .stack-fill { display: flex; flex-direction: column; height: 100%; min-height: 0; }
     
     .vertical-splitter {
        width: 8px;
        background: linear-gradient(180deg, #e5e7eb 0%, #d1d5db 50%, #e5e7eb 100%);
        cursor: col-resize;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        border-radius: 4px;
        margin: 0 2px;
        height: 100%;
    }
    
    .vertical-splitter:hover {
        background: linear-gradient(180deg, #667eea 0%, #764ba2 50%, #667eea 100%);
    }
    
    .vertical-splitter:active {
        background: linear-gradient(180deg, #5a67d8 0%, #6b46c1 50%, #5a67d8 100%);
    }
    
    .vertical-splitter::before {
        content: "⋮";
        color: #9ca3af;
        font-size: 14px;
        font-weight: bold;
    }
    
    .vertical-splitter:hover::before {
        color: white;
    }
    
    /* Responsive adjustments */
    @@media (max-width: 992px) {
        .split-container {
            flex-direction: column;
            height: auto;
            min-height: auto;
        }
        
        .split-pane-left {
            width: 100% !important;
            max-width: 100%;
            min-width: auto;
            height: auto;
            min-height: 300px;
        }
        
        .split-pane-right {
            width: 100%;
            min-width: auto;
            height: auto;
            min-height: 400px;
        }
        
        .vertical-splitter {
            display: none;
        }
    }
    
    .form-control-modern {
        border-radius: 8px;
        border: 1px solid #d1d5db;
        padding: 10px 14px;
        transition: all 0.2s ease;
        font-size: 14px;
        background: #fff;
    }
    
    .form-control-modern:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        outline: none;
    }
    
    .response-box {
        background: #f9fafb;
        border-radius: 8px;
        border-left: 3px solid #667eea;
        padding: 16px;
        margin-top: 16px;
    }
    
    .image-result {
        animation: fadeIn 0.3s ease;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .user-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 14px 18px;
        border-radius: 10px;
    }
    
    .code-display {
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid #e2e4e8;
        padding: 16px;
    }
    
    .code-text {
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 1.4rem;
        font-weight: 600;
        color: #374151;
        letter-spacing: 3px;
    }
    
    .section-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: #667eea;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
    }
    
    .generated-image {
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .code-output-panel {
        background: linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        min-height: 650px;
    }
    
    .code-pre {
        background: #1e293b;
        border-radius: 10px;
        color: #e2e8f0;
        font-family: 'SF Mono', 'Fira Code', monospace;
        font-size: 12px;
        line-height: 1.6;
        max-height: 550px;
        overflow: auto;
    }
    
    .analysis-action-btn {
        position: relative;
        overflow: hidden;
    }
    
    .analysis-action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .analysis-action-btn:hover::before {
        left: 100%;
    }
    
    .analysis-action-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5) !important;
    }
    
    .analysis-action-btn:active:not(:disabled) {
        transform: translateY(0);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4) !important;
    }
    
    .analysis-action-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%) !important;
        box-shadow: none !important;
    }
    
    /* Premium Action Button Styles */
    .premium-action-btn {
        position: relative;
        overflow: hidden;
    }
    
    .premium-action-btn .btn-shimmer {
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
        transition: left 0.6s ease;
    }
    
    .premium-action-btn:hover:not(:disabled) .btn-shimmer {
        left: 100%;
    }
    
    .premium-action-btn:hover:not(:disabled) {
        transform: translateY(-3px) scale(1.01);
        box-shadow: 0 10px 35px rgba(102, 126, 234, 0.5), 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    }
    
    .premium-action-btn:active:not(:disabled) {
        transform: translateY(-1px) scale(1);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4) !important;
    }
    
    .premium-action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%) !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
    }
    
    .premium-action-btn.processing {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%) !important;
    }
    
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Analysis Select Styling - Enhanced for visibility */
    .form-select.form-control-modern.analysis-select {
        border: 2px solid #e0e7ff;
        transition: all 0.2s ease;
        font-size: 1rem !important;
        padding: 12px 14px !important;
        line-height: 1.5;
        min-height: 52px;
    }

    .form-select.form-control-modern.analysis-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
    }

    .form-select.form-control-modern.analysis-select optgroup {
        font-weight: 800 !important;
        font-size: 1.05rem !important;
        color: #ffffff !important;
        background: #1f2937 !important;
        padding: 14px 12px !important;
        margin-top: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .form-select.form-control-modern.analysis-select option {
        font-weight: 500;
        font-size: 0.95rem !important;
        color: #1f2937;
        padding: 12px 16px !important;
        line-height: 1.6;
        background: #ffffff;
        border-bottom: 1px solid #f3f4f6;
    }

    /* Make the first option under each group stand out */
    .form-select.form-control-modern.analysis-select optgroup option:first-child {
        background: #111827 !important;
        color: #f9fafb !important;
        font-size: 1.08rem !important;
        font-weight: 800;
        border-top: 1px solid #0f172a;
        border-bottom: 1px solid #1f2937;
    }

    /* Explicit header row to bypass optgroup background limitations */
    .form-select.form-control-modern.analysis-select option.analysis-optgroup-header {
        background: #111827 !important;
        color: #ffffff !important;
        font-weight: 800 !important;
        font-size: 1.08rem !important;
        padding: 14px 12px !important;
        cursor: default;
    }

    .form-select.form-control-modern.analysis-select option:hover {
        background: #f0f4ff !important;
    }

    .form-select.form-control-modern.analysis-select optgroup option:first-child:hover {
        background: #0f172a !important;
        color: #e5e7eb !important;
    }

            .form-select.form-control-modern.analysis-select option:checked {
                background: linear-gradient(135deg, #ede9fe 0%, #fae8ff 100%) !important;
                font-weight: 600;
            }

            /* Premium Left Panel Styles */
            .left-panel-container {
                background: linear-gradient(180deg, #ffffff 0%, #f8fafc 50%, #f1f5f9 100%);
                border-radius: 16px;
                border: 1px solid rgba(102, 126, 234, 0.15);
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.9);
                height: 100%;
                overflow: auto;
                padding: 20px;
            }

            .left-panel-section {
                background: #ffffff;
                border-radius: 14px;
                border: 1px solid #e5e7eb;
                padding: 16px;
                margin-bottom: 16px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
                transition: all 0.2s ease;
            }

            .left-panel-section:hover {
                border-color: rgba(102, 126, 234, 0.3);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
            }

            .section-header {
                display: flex;
                align-items: center;
                gap: 12px;
                margin-bottom: 14px;
                padding-bottom: 12px;
                border-bottom: 1px solid #f1f5f9;
            }

            .section-header-icon {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                width: 38px;
                height: 38px;
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.1rem;
                box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
            }

            .section-header-text {
                flex: 1;
            }

            .section-header-title {
                font-weight: 700;
                font-size: 0.95rem;
                color: #1e293b;
                margin: 0;
                letter-spacing: -0.3px;
            }

            .section-header-subtitle {
                font-size: 0.72rem;
                color: #64748b;
                margin: 0;
                margin-top: 2px;
            }

            .premium-upload-zone {
                border: 2px dashed #c7d2fe;
                border-radius: 14px;
                background: linear-gradient(180deg, #faf5ff 0%, #f5f3ff 50%, #ede9fe 100%);
                cursor: pointer;
                min-height: 280px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
                position: relative;
                overflow: hidden;
                padding: 20px;
            }

            .premium-upload-zone::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%);
                opacity: 0;
                transition: opacity 0.25s ease;
            }

            .premium-upload-zone:hover {
                border-color: #a5b4fc;
                background: linear-gradient(180deg, #f5f3ff 0%, #ede9fe 50%, #e0e7ff 100%);
                transform: translateY(-2px);
                box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
            }

            .premium-upload-zone:hover::before {
                opacity: 1;
            }

            .premium-upload-zone.drag-over {
                border-color: #38ef7d !important;
                background: linear-gradient(180deg, #ecfdf5 0%, #d1fae5 50%, #a7f3d0 100%) !important;
                transform: scale(1.02);
                box-shadow: 0 12px 32px rgba(56, 239, 125, 0.25);
            }

            .upload-zone-icon {
                width: 64px;
                height: 64px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ec4899 100%);
                border-radius: 18px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.8rem;
                margin-bottom: 14px;
                box-shadow: 0 8px 24px rgba(102, 126, 234, 0.35);
                transition: all 0.25s ease;
            }

            .premium-upload-zone:hover .upload-zone-icon {
                transform: scale(1.08);
                box-shadow: 0 12px 32px rgba(102, 126, 234, 0.45);
            }

            .upload-zone-title {
                font-weight: 700;
                font-size: 0.95rem;
                color: #4f46e5;
                margin-bottom: 4px;
                text-align: center;
            }

            .upload-zone-subtitle {
                font-size: 0.78rem;
                color: #64748b;
                text-align: center;
            }

            .uploaded-image-container {
                position: relative;
                width: 100%;
                display: flex;
                justify-content: center;
            }

            .uploaded-image {
                max-width: 100%;
                max-height: 260px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
                border: 3px solid rgba(102, 126, 234, 0.2);
            }

            /* Polished Analysis Picker */
            .analysis-picker {
                border: none;
                border-radius: 14px;
                background: linear-gradient(180deg, #ffffff 0%, #faf5ff 100%);
                box-shadow: 0 4px 16px rgba(102, 126, 234, 0.1);
                overflow: hidden;
            }

            .analysis-group {
                border-top: 1px solid #eef2f6;
                background: #fbfcfd;
            }

            .analysis-group:first-child {
                border-top: none;
            }

            .analysis-group:not(:last-child) {
                box-shadow: inset 0 -1px 0 rgba(226, 232, 240, 0.7);
            }

            .analysis-group-title {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ec4899 100%);
                color: #fff;
                border-radius: 0;
                padding: 12px 16px;
                font-weight: 800;
                font-size: 1.02rem;
                letter-spacing: 0.3px;
                display: flex;
                align-items: center;
                gap: 10px;
                justify-content: space-between;
                box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.12);
            }

                    .analysis-group-title .badge-microsoft {
                        background: rgba(255, 255, 255, 0.18);
                        color: #fff;
                        border-radius: 10px;
                        font-weight: 700;
                        font-size: 0.72rem;
                        padding: 4px 8px;
                        letter-spacing: 0.3px;
                    }

                    .analysis-group-title .status-icon {
                        font-size: 1rem;
                        opacity: 0.9;
                    }

                    .analysis-group-disabled {
                        opacity: 0.55;
                        filter: grayscale(0.25);
                    }

                    .group-collapsed-note {
                        padding: 12px 14px;
                        background: #fef2f2;
                        color: #b91c1c;
                        font-size: 0.87rem;
                        border-top: 1px solid #fee2e2;
                    }
                    .group-collapsed-note .hint-link {
                        color: #b91c1c;
                        font-weight: 600;
                    }

            .analysis-option {
                display: flex;
                align-items: center;
                gap: 12px;
                width: 100%;
                text-align: left;
                padding: 12px 14px;
                border: none;
                background: #ffffff;
                color: #0f172a;
                font-size: 0.95rem;
                font-weight: 600;
                transition: background 0.18s ease, color 0.18s ease, box-shadow 0.18s ease, transform 0.18s ease;
                box-shadow: inset 0 -1px 0 rgba(226, 232, 240, 0.8);
            }

            .analysis-option:hover {
                background: #f6f8fb;
                box-shadow: inset 0 -1px 0 rgba(148, 163, 184, 0.25);
                transform: translateY(-1px);
            }

            .analysis-option:focus-visible {
                outline: 2px solid #8b5cf6;
                outline-offset: -2px;
            }

            .analysis-option.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ec4899 100%);
                color: #fff;
                box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.2), 0 2px 8px rgba(102, 126, 234, 0.3);
            }

            .analysis-option .analysis-icon {
                width: 30px;
                height: 30px;
                border-radius: 8px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #f0f4ff 0%, #fdf4ff 100%);
                color: #667eea;
                font-weight: 700;
                font-size: 0.9rem;
                box-shadow: inset 0 1px 0 rgba(255,255,255,0.8), 0 1px 2px rgba(0,0,0,0.04);
            }

            .analysis-option.active .analysis-icon {
                background: rgba(255, 255, 255, 0.25);
                color: white;
            }

            /* Premium option styling */
            .analysis-option.premium-option {
                background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
                border: 2px solid #fbbf24;
                position: relative;
            }
            
            .analysis-option.premium-option:hover {
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                border-color: #f59e0b;
                box-shadow: 0 4px 12px rgba(251, 191, 36, 0.3);
            }
            
            .analysis-option.premium-option.active {
                background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
                color: #78350f;
                border-color: #d97706;
            }
            
            .analysis-option.premium-option.active .analysis-icon {
                background: rgba(255, 255, 255, 0.4);
                color: #78350f;
            }

            /* Premium Dialog Quality Cards */
            .quality-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            }
            
            .feature-toggle:hover {
                background: #f1f5f9 !important;
                border-color: #cbd5e1 !important;
            }
            
            .feature-toggle:has(input:checked) {
                background: #eef2ff !important;
                border-color: #a5b4fc !important;
            }

            .collapse-toggle {
                border: 1px solid rgba(255,255,255,0.35);
                background: rgba(255,255,255,0.15);
                border-radius: 8px;
                width: 32px;
                height: 32px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                color: #fff;
                transition: background 0.18s ease, transform 0.18s ease;
            }

            .collapse-toggle:hover {
                background: rgba(255,255,255,0.25);
                transform: translateY(-1px);
            }

            .collapse-icon {
                width: 0;
                height: 0;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-top: 8px solid currentColor;
                transition: transform 0.18s ease;
            }

            .collapse-icon.collapsed {
                transform: rotate(-90deg);
            }
     
             /* API Detail Card Animation */
             .api-detail-card {
                 transition: all 0.3s ease;
             }
    
    .api-detail-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
</style>

@* Inline script fallback for clipboard *@
<script suppress-error="BL9992">
    if (!window.copyToClipboard) {
        window.copyToClipboard = function(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "0";
            textArea.style.top = "0";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            var success = false;
            try { success = document.execCommand('copy'); } catch(e) {}
            document.body.removeChild(textArea);
            return success;
        };
    }
</script>

<div class="app-container">
    <div class="container-fluid" style="max-width: 1400px; margin: 0 auto;">
        
        @switch (_state)
        {
            case AppState.NotSignedIn:
                <div class="card glass-card border-0 shadow-lg" style="border-radius: 24px; overflow: hidden;">
                    <div class="card-body text-center py-5 px-4 gradient-primary">
                        <div class="icon-circle">
                            🤖
                        </div>
                        <h1 class="mb-3 text-white fw-bold" style="font-size: 2.2rem;">Azure OpenAI</h1>
                        <p class="mb-4 px-3" style="color: rgba(255,255,255,0.9); font-size: 1.1rem;">
                            Unlock the power of AI with your Microsoft account
                        </p>
                        
                        @if (!string.IsNullOrEmpty(_error))
                        {
                            <div class="alert mb-4 mx-auto" style="background: rgba(255,255,255,0.95); border: none; border-radius: 12px; max-width: 450px; color: #c53030;">
                                <div class="mb-2"><strong>⚠️ @(_loginTimedOut ? "Login Timed Out" : "Sign In Failed")</strong></div>
                                <p class="mb-2" style="font-size: 0.95rem;">@_error</p>
                                @if (_loginTimedOut)
                                {
                                    <p class="mb-0" style="font-size: 0.85rem; color: #666;">
                                        You can try again or check your Azure settings.
                                    </p>
                                }
                            </div>
                            
                            <div class="d-flex justify-content-center gap-3 mb-4 flex-wrap">
                                <button class="btn btn-light px-4 py-2 fw-bold" 
                                        style="border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);" 
                                        @onclick="StartSignIn">
                                    <span style="color: #667eea;">🔄 Try Again</span>
                                </button>
                                <button class="btn btn-outline-light px-4 py-2 fw-semibold" 
                                        style="border-radius: 25px;" 
                                        @onclick="ShowServiceSettingsFromLogin">
                                    <span>⚙️ Check Settings</span>
                                </button>
                            </div>
                        }
                        else
                        {
                            <button class="btn btn-light btn-lg px-5 py-3 fw-bold" 
                                    style="border-radius: 50px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); font-size: 1.1rem;" 
                                    @onclick="StartSignIn">
                                <span style="color: #667eea;">🔐 Sign In with Microsoft</span>
                            </button>
                        }
                        
                        <p class="mt-4 mb-0" style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                            Secure authentication via Azure AD
                        </p>
                        
                        @* Settings shortcut *@
                        <button class="btn btn-link mt-2" style="color: rgba(255,255,255,0.6); text-decoration: none; font-size: 0.85rem;" 
                                @onclick="ShowServiceSettingsFromLogin">
                            ⚙️ Configure Service Settings
                        </button>
                    </div>
                </div>
                break;
                
            case AppState.SigningIn:
                <div class="card glass-card border-0 shadow-lg" style="border-radius: 24px;">
                    <div class="card-body py-5 px-4">
                        <div class="text-center mb-4">
                            <div style="font-size: 48px; margin-bottom: 16px;">🔑</div>
                            <h3 class="fw-bold" style="color: #333;">Sign in to Azure</h3>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(_userCode))
                        {
                            <div class="code-display mb-4">
                                <p class="section-title mb-3">Your sign-in code</p>
                                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                                    <code class="code-text user-select-all" id="deviceCode" style="font-size: 1.5rem; letter-spacing: 2px; font-weight: bold;">@_userCode</code>
                                    <button class="btn btn-gradient px-4 py-2" style="border-radius: 10px;" @onclick="CopyCodeManual">
                                        @(_copied ? "✓ Copied!" : "📋 Copy Code")
                                    </button>
                                </div>
                            </div>
                            
                            <button class="btn btn-gradient w-100 py-3 fw-semibold mb-4" 
                                    style="border-radius: 14px; font-size: 1.1rem;" 
                                    @onclick="OpenLoginPopup">
                                🔗 Open Sign-In Window
                            </button>
                            
                            <div class="mb-4 p-3" style="background: #f8f9fa; border-radius: 12px;">
                                <p class="section-title">How to sign in</p>
                                <ol class="mb-0 ps-3" style="color: #666; line-height: 1.8;">
                                    <li>Copy the code above</li>
                                    <li>Click "Open Sign-In Window"</li>
                                    <li>Paste the code and sign in with your Microsoft account</li>
                                </ol>
                            </div>
                            
                            <div class="text-center py-3" style="border-top: 1px solid #eee;">
                                <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                                    <div class="spinner-border spinner-border-sm" style="color: #667eea;"></div>
                                    <span style="color: #888;">Waiting for authentication...</span>
                                </div>
                                
                                @* Timeout countdown *@
                                <div class="mb-3 p-2" style="background: @(_remainingSeconds <= 30 ? "#fff3cd" : "#f0f4ff"); border-radius: 8px;">
                                    <span style="color: @(_remainingSeconds <= 30 ? "#856404" : "#667eea"); font-weight: 500;">
                                        ⏱️ Time remaining: @TimeSpan.FromSeconds(_remainingSeconds).ToString(@"m\:ss")
                                    </span>
                                    @if (_remainingSeconds <= 30)
                                    {
                                        <br/>
                                        <small style="color: #856404;">Login will timeout soon. Press Cancel or Esc to exit.</small>
                                    }
                                </div>
                                
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-outline-secondary" style="border-radius: 10px;" @onclick="Cancel">
                                        ❌ Cancel (Esc)
                                    </button>
                                    <button class="btn btn-outline-primary" style="border-radius: 10px;" @onclick="ShowServiceSettingsFromLogin">
                                        ⚙️ Settings
                                    </button>
                                </div>
                                <small class="d-block mt-2" style="color: #aaa;">Press Esc key to cancel and return to settings</small>
                            </div>
                        }
                        else
                        {
                            @* Loading state while preparing sign-in *@
                            <div class="text-center py-4">
                                <div style="position: relative; width: 80px; height: 80px; margin: 0 auto 20px;">
                                    @* Outer spinning ring *@
                                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 4px solid #e5e7eb; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                    @* Inner icon *@
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px;">🔐</div>
                                </div>
                                
                                <h4 class="fw-bold mb-3" style="color: #374151;">Connecting to Azure...</h4>
                                
                                @* Progress steps *@
                                <div class="text-start mx-auto mb-4" style="max-width: 300px;">
                                    <div class="d-flex align-items-center gap-3 mb-2" style="color: #10b981;">
                                        <span style="width: 24px; height: 24px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">✓</span>
                                        <span style="font-size: 0.9rem;">Configuration loaded</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-3 mb-2" style="color: @(_signInStep >= 2 ? "#10b981" : "#667eea");">
                                        @if (_signInStep >= 2)
                                        {
                                            <span style="width: 24px; height: 24px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px;">✓</span>
                                        }
                                        else
                                        {
                                            <span style="width: 24px; height: 24px; border: 2px solid #667eea; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <span class="spinner-border spinner-border-sm" style="width: 14px; height: 14px; border-width: 2px; color: #667eea;"></span>
                                            </span>
                                        }
                                        <span style="font-size: 0.9rem;">Contacting Azure AD...</span>
                                    </div>
                                    <div class="d-flex align-items-center gap-3" style="color: @(_signInStep >= 3 ? "#10b981" : "#9ca3af");">
                                        <span style="width: 24px; height: 24px; border: 2px solid @(_signInStep >= 3 ? "#10b981" : "#d1d5db"); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: @(_signInStep >= 3 ? "#10b981" : "#d1d5db"); font-size: 12px;">3</span>
                                        <span style="font-size: 0.9rem;">Generating sign-in code</span>
                                    </div>
                                </div>
                                
                                <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 16px;">
                                    This may take a few seconds depending on your network connection
                                </p>
                                
                                @* Elapsed time indicator *@
                                <div class="mb-3 p-2" style="background: #f3f4f6; border-radius: 8px; display: inline-block;">
                                    <span style="color: #6b7280; font-size: 0.85rem;">
                                        ⏱️ Elapsed: @TimeSpan.FromSeconds(_signInElapsedSeconds).ToString(@"m\:ss")
                                    </span>
                                </div>
                                
                                <div class="mt-3">
                                    <button class="btn btn-outline-secondary" style="border-radius: 10px; padding: 8px 20px;" @onclick="Cancel">
                                        ❌ Cancel
                                    </button>
                                </div>
                                <small class="d-block mt-2" style="color: #9ca3af;">Press Esc key to cancel</small>
                            </div>
                        }
                    </div>
                </div>
                break;
                
            case AppState.SignedIn:
                <div class="card glass-card border-0 shadow-sm mb-3" style="border-radius: 12px; overflow: hidden;">
                    <div class="user-badge">
                        <div class="d-flex justify-content-between align-items-center position-relative">
                            <div class="d-flex align-items-center gap-3">
                                <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    👤
                                </div>
                                <div>
                                    <h5 class="mb-0 text-white fw-bold">@_userName</h5>
                                    <small style="color: rgba(255,255,255,0.85);">Connected to @AzureOpenAI.DeploymentName</small>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-light btn-sm fw-semibold" style="border-radius: 10px; padding: 8px 16px;" @onclick="ShowServiceSettings" title="Service Settings">
                                    ⚙️ Settings
                                </button>
                                <button class="btn btn-light btn-sm fw-semibold" style="border-radius: 10px; padding: 8px 16px;" @onclick="SignOut">
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                @* Premium Toolbar Navigation *@
                <TabToolbar @bind-ActiveTab="_activeTab" />
                
                @if (_activeTab == "chat")
                {
                    <div class="card glass-card border-0 shadow-sm" style="border-radius: 12px;">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <span style="font-size: 20px;">💬</span>
                                <h5 class="mb-0 fw-semibold" style="color: #374151;">Chat with GPT-4o</h5>
                            </div>
                            
                            <textarea class="form-control form-control-modern mb-3" rows="4" @bind="_message" 
                                      placeholder="Ask me anything... I'm here to help!" disabled="@_sending"></textarea>
                            
                            <button class="btn btn-gradient w-100 py-2 fw-medium" style="border-radius: 8px;" 
                                    @onclick="SendMessage" 
                                    disabled="@(_sending || string.IsNullOrWhiteSpace(_message))">
                                @if (_sending)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Processing...</span>
                                }
                                else
                                {
                                    <span>Send Message</span>
                                }
                            </button>
                            
                            @if (!string.IsNullOrEmpty(_response))
                            {
                                <div class="response-box">
                                    <p class="section-title">Response</p>
                                    <div style="white-space: pre-wrap; color: #333; line-height: 1.7;">@_response</div>
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(_chatError))
                            {
                                <div class="alert mt-4 mb-0" style="background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; border-radius: 12px;">
                                    <strong>⚠️ Error:</strong> @_chatError
                                </div>
                            }
                        </div>
                    </div>
                }
                else if (_activeTab == "image")
                {
                    <div class="card glass-card border-0 shadow-sm" style="border-radius: 12px;">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <span style="font-size: 22px;">🎨</span>
                                <h5 class="mb-0 fw-semibold" style="color: #374151;">Image Studio</h5>
                                <span class="badge ms-auto" style="background: #6b7280; font-weight: 500; padding: 6px 12px; font-size: 0.75rem;">gpt-image-1.5</span>
                            </div>
                            
                            @* Two Pane Layout *@
                            <div class="row g-3">
                                @* Left Pane - Input/Upload *@
                                <div class="col-lg-6">
                                    <div class="h-100 p-4" style="background: #f9fafb; border-radius: 10px; border: 1px solid #e5e7eb;">
                                        <h6 class="fw-semibold mb-3" style="color: #4b5563;">
                                            <span class="me-2">📝</span>Create New Image
                                        </h6>
                                        
                                        <textarea class="form-control form-control-modern mb-3" rows="5" @bind="_imagePrompt" 
                                                  placeholder="Describe the image you want to create in detail... Be creative and specific!" 
                                                  disabled="@_generatingImage"
                                                  style="resize: none;"></textarea>
                                        
                                        <div class="mb-3">
                                            <label class="section-title">Image Size</label>
                                            <select class="form-select form-control-modern" @bind="_imageSize">
                                                <option value="1024x1024">📐 Square (1024×1024)</option>
                                                <option value="1792x1024">🖼️ Landscape (1792×1024)</option>
                                                <option value="1024x1792">📱 Portrait (1024×1792)</option>
                                            </select>
                                        </div>
                                        
                                        <button class="btn btn-gradient w-100 py-2 fw-medium mb-3" 
                                                style="border-radius: 8px;" 
                                                @onclick="GenerateImage" 
                                                disabled="@(_generatingImage || string.IsNullOrWhiteSpace(_imagePrompt))">
                                            @if (_generatingImage)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2"></span>
                                                <span>Creating...</span>
                                            }
                                            else
                                            {
                                                <span>Generate Image</span>
                                            }
                                        </button>
                                        
                                        <hr style="border-color: #e5e7eb; margin: 1rem 0;" />
                                        
                                        <h6 class="fw-semibold mb-3" style="color: #4b5563;">
                                            <span class="me-2">📤</span>Upload Reference Image
                                        </h6>
                                        
                                        <div class="upload-zone p-3 text-center" 
                                             style="border: 2px dashed #d1d5db; border-radius: 10px; background: #fafafa; cursor: pointer;"
                                             @onclick="TriggerFileUpload">
                                            @if (string.IsNullOrEmpty(_uploadedImageUrl))
                                            {
                                                <div style="color: #6b7280;">
                                                    <span style="font-size: 36px; display: block; margin-bottom: 8px;">🖼️</span>
                                                    <p class="mb-1 fw-medium">Click to upload an image</p>
                                                    <p class="mb-0 small text-muted">PNG, JPG up to 10MB</p>
                                                </div>
                                            }
                                            else
                                            {
                                                <img src="@_uploadedImageUrl" alt="Uploaded" 
                                                     style="max-width: 100%; max-height: 200px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);" />
                                                <p class="mt-2 mb-0 small text-muted">Click to change image</p>
                                            }
                                        </div>
                                        
                                        <InputFile id="imageUpload" accept="image/*" style="display: none;" OnChange="HandleFileUploadNew" />
                                        
                                        @if (!string.IsNullOrEmpty(_uploadedImageUrl))
                                        {
                                            <button class="btn btn-outline-danger w-100 mt-3" style="border-radius: 10px;" @onclick="ClearUploadedImage">
                                                🗑️ Remove Uploaded Image
                                            </button>
                                        }
                                    </div>
                                </div>
                                
                                @* Right Pane - Preview/Output *@
                                <div class="col-lg-6">
                                    <div class="h-100 p-4" style="background: #f9fafb; border-radius: 10px; border: 1px solid #e5e7eb;">
                                        <h6 class="fw-semibold mb-3" style="color: #4b5563;">
                                            <span class="me-2">🖼️</span>Generated Result
                                        </h6>
                                        
                                        @if (_generatingImage)
                                        {
                                            <div class="text-center py-5" style="min-height: 350px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: #6b7280;"></div>
                                                <p class="fw-medium" style="color: #4b5563;">Creating your image...</p>
                                                <p class="small text-muted">This may take a moment</p>
                                            </div>
                                        }
                                        else if (!string.IsNullOrEmpty(_generatedImageUrl))
                                        {
                                            <div class="image-result">
                                                <div class="text-center p-3" style="background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                                                    <img src="@_generatedImageUrl" alt="Generated Image" class="generated-image" 
                                                         style="max-width: 100%; max-height: 500px; width: auto; height: auto;" />
                                                </div>
                                                
                                                <div class="d-flex gap-2 mt-3">
                                                    <button class="btn btn-gradient flex-fill py-2 fw-medium" style="border-radius: 8px;" @onclick="DownloadImage">
                                                        💾 Download
                                                    </button>
                                                    <button class="btn btn-outline-secondary flex-fill py-2 fw-medium" style="border-radius: 8px;" @onclick="ClearGeneratedImage">
                                                        🔄 New
                                                    </button>
                                                </div>
                                                
                                                @if (!string.IsNullOrEmpty(_revisedPrompt))
                                                {
                                                    <div class="mt-3 p-3" style="background: white; border-radius: 8px; border-left: 3px solid #6b7280;">
                                                        <p class="section-title mb-1">AI Enhanced Prompt</p>
                                                        <p class="mb-0" style="color: #4b5563; font-size: 0.85rem; font-style: italic;">@_revisedPrompt</p>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-center py-5" style="min-height: 350px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                <div style="width: 80px; height: 80px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                                                    <span style="font-size: 32px;">🎨</span>
                                                </div>
                                                <p class="fw-medium mb-2" style="color: #6b7280;">No image generated yet</p>
                                                <p class="small text-muted px-4">Enter a description and click "Generate Image"</p>
                                            </div>
                                        }
                                        
                                        @if (!string.IsNullOrEmpty(_imageError))
                                        {
                                            <div class="alert mt-3 mb-0" style="background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; border-radius: 12px;">
                                                <strong>⚠️ Error:</strong> @_imageError
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (_activeTab == "code")
                {
                    <div class="card glass-card border-0 shadow-sm" style="border-radius: 12px; height: calc(100vh - 220px); min-height: 800px;">
                        <div class="card-body p-3" style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
                            @* Premium Header Banner - Compact *@
                            <div class="vision-header-banner" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ec4899 100%); color: white; padding: 12px 16px; border-radius: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25);">
                                <div class="d-flex align-items-center gap-3">
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 10px 12px; backdrop-filter: blur(10px);">
                                        <span style="font-size: 1.5rem;">🧠</span>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.1rem; font-weight: 700; letter-spacing: -0.5px;">Vision Analysis Studio</div>
                                        <div style="font-size: 0.75rem; opacity: 0.9;">Powered by Azure OpenAI GPT-4o & Azure AI Vision 4.0</div>
                                    </div>
                                </div>
                                <button type="button" class="btn" style="background: rgba(255,255,255,0.95); color: #667eea; border: none; border-radius: 10px; padding: 8px 16px; font-weight: 700; font-size: 0.8rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 6px;" @onclick="ShowApiCoverage">
                                    <span style="font-size: 1rem;">📊</span>
                                    <span>64 APIs</span>
                                    <span class="badge" style="background: linear-gradient(135deg, #10b981, #059669); color: white; font-size: 0.65rem; padding: 2px 6px; margin-left: 4px;">95%</span>
                                </button>
                            </div>
                            
                            @* Section Title with Gradient *@
                            <div class="d-flex align-items-center gap-3 mb-3" style="flex-shrink: 0;">
                                <div style="display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #f0f4ff 0%, #fdf4ff 100%); padding: 8px 14px; border-radius: 10px; border: 1px solid #e0e7ff;">
                                    <span style="font-size: 1.4rem;">🖼️</span>
                                    <span style="font-size: 1.1rem; color: #6366f1;">→</span>
                                    <span style="font-size: 1.4rem;">💻</span>
                                </div>
                                <div style="flex: 1;">
                                    <h5 class="mb-0 fw-bold" style="background: linear-gradient(135deg, #4f46e5, #7c3aed, #db2777); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.15rem;">Image to Code & AI Analysis</h5>
                                    <div style="font-size: 0.7rem; color: #6b7280; margin-top: 2px;">Upload any UI screenshot • Generate production code • Extract assets</div>
                                </div>
                                <div class="d-flex gap-2">
                                    <span class="badge" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); font-weight: 600; padding: 6px 10px; font-size: 0.7rem; display: flex; align-items: center; gap: 4px;">
                                        <span>🤖</span> GPT-4o
                                    </span>
                                    <span class="badge" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); font-weight: 600; padding: 6px 10px; font-size: 0.7rem; display: flex; align-items: center; gap: 4px;">
                                        <span>👁️</span> Vision
                                    </span>
                                </div>
                            </div>
                            
                            <div class="split-container" id="splitContainer" style="flex: 1;">
                                @* Left Pane - Upload & Analysis Options *@
                                <div class="split-pane-left" id="leftPane" style="width: 35%;">
                                    <div class="left-panel-container">
                                        @* Upload Section *@
                                        <div class="left-panel-section">
                                            <div class="section-header">
                                                <div class="section-header-icon">📤</div>
                                                <div class="section-header-text">
                                                    <div class="section-header-title">Upload UI Design</div>
                                                    <div class="section-header-subtitle">Drop or click to add your screenshot</div>
                                                </div>
                                            </div>
                                            
                                            <div class="premium-upload-zone @(_isDragOver ? "drag-over" : "")" 
                                                 @onclick="TriggerCodeImageUpload"
                                                 @ondragenter="HandleDragEnter"
                                                 @ondragenter:preventDefault
                                                 @ondragleave="HandleDragLeave"
                                                 @ondragleave:preventDefault
                                                 @ondragover="HandleDragOver"
                                                 @ondragover:preventDefault
                                                 @ondrop="HandleDrop"
                                                 @ondrop:preventDefault>
                                                @if (string.IsNullOrEmpty(_codeImageUrl))
                                                {
                                                    <div class="upload-zone-icon">
                                                        @(_isDragOver ? "📥" : "🎨")
                                                    </div>
                                                    <div class="upload-zone-title">@(_isDragOver ? "Drop image here!" : "Click or drag & drop")</div>
                                                    <div class="upload-zone-subtitle">PNG, JPG, WebP, MP4 up to 20MB</div>
                                                }
                                                else
                                                {
                                                    <div class="uploaded-image-container">
                                                        <img src="@_codeImageUrl" alt="Uploaded UI" class="uploaded-image" />
                                                    </div>
                                                }
                                            </div>
                                            
                                            <InputFile id="codeImageUpload" accept="image/*,video/*" style="display: none;" OnChange="HandleCodeImageUploadNew" />
                                        
                                            @if (!string.IsNullOrEmpty(_codeImageUrl))
                                            {
                                                <button class="btn btn-outline-danger w-100 mt-3" style="border-radius: 10px; font-weight: 600;" @onclick="ClearCodeImage">
                                                    🗑️ Remove Image
                                                </button>
                                            }
                                        </div>

                                        @* Generate button section *@
                                        <div class="left-panel-section" style="border: 2px solid #e0e7ff; background: linear-gradient(180deg, #faf5ff 0%, #f5f3ff 100%);">
                                            <button class="btn w-100 premium-action-btn @(_isAnalyzing || _isConvertingToCode ? "processing" : "")" 
                                                    style="background: @(string.IsNullOrEmpty(_codeImageUrl) ? "linear-gradient(135deg, #9ca3af 0%, #6b7280 100%)" : "linear-gradient(135deg, #667eea 0%, #764ba2 40%, #ec4899 100%)"); color: white; border: none; border-radius: 16px; padding: 24px 28px; box-shadow: @(string.IsNullOrEmpty(_codeImageUrl) ? "0 4px 12px rgba(107, 114, 128, 0.3)" : "0 8px 32px rgba(102, 126, 234, 0.5), 0 0 0 4px rgba(102, 126, 234, 0.15)"); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 1.2rem; position: relative; overflow: hidden; min-height: 90px; opacity: @(string.IsNullOrEmpty(_codeImageUrl) ? "0.7" : "1"); cursor: @(string.IsNullOrEmpty(_codeImageUrl) ? "not-allowed" : "pointer");" 
                                                    @onclick="RunAnalysis" 
                                                    disabled="@(string.IsNullOrEmpty(_codeImageUrl) || _isAnalyzing || _isConvertingToCode)">
                                                <div class="btn-shimmer" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent); transition: left 0.6s ease;"></div>
                                                @if (_isAnalyzing || _isConvertingToCode)
                                                {
                                                    <div class="d-flex align-items-center justify-content-center gap-4">
                                                        <div class="processing-spinner" style="width: 36px; height: 36px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                                                        <div style="text-align: left;">
                                                            <div style="font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px;">Processing with AI...</div>
                                                            <div style="font-size: 0.9rem; opacity: 0.9;">@GetServiceName() is analyzing your image</div>
                                                        </div>
                                                    </div>
                                                }
                                                else if (string.IsNullOrEmpty(_codeImageUrl))
                                                {
                                                    <div class="d-flex align-items-center justify-content-center gap-4">
                                                        <div style="background: rgba(255,255,255,0.25); border-radius: 14px; padding: 14px 16px; backdrop-filter: blur(8px);">
                                                            <span style="font-size: 2rem;">📤</span>
                                                        </div>
                                                        <div style="text-align: left; flex: 1;">
                                                            <div style="font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">Upload an Image First</div>
                                                            <div style="font-size: 0.95rem; opacity: 0.95; margin-top: 2px;">
                                                                Drop or select an image above to get started
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="d-flex align-items-center justify-content-center gap-4">
                                                        <div style="background: rgba(255,255,255,0.25); border-radius: 14px; padding: 14px 16px; backdrop-filter: blur(8px);">
                                                            <span style="font-size: 2rem;">@GetAnalysisButtonIcon()</span>
                                                        </div>
                                                        <div style="text-align: left; flex: 1;">
                                                            <div style="font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">@GetAnalysisButtonText()</div>
                                                            <div style="font-size: 0.95rem; opacity: 0.95; margin-top: 2px;">
                                                                @GetServiceName() • <span style="font-weight: 600;">@_targetFramework</span>
                                                            </div>
                                                        </div>
                                                        <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 12px 16px; display: flex; align-items: center; gap: 6px;">
                                                            <span style="font-size: 1.5rem;">▶</span>
                                                            <span style="font-weight: 700; font-size: 1rem;">GO</span>
                                                        </div>
                                                    </div>
                                                }
                                            </button>
                                            @if (!string.IsNullOrEmpty(_codeImageUrl))
                                            {
                                                <div class="text-center mt-3" style="font-size: 0.8rem; color: #6b7280;">
                                                    <kbd style="background: #e5e7eb; padding: 3px 8px; border-radius: 5px; font-family: monospace; font-size: 0.75rem; font-weight: 600;">⌘</kbd> + 
                                                    <kbd style="background: #e5e7eb; padding: 3px 8px; border-radius: 5px; font-family: monospace; font-size: 0.75rem; font-weight: 600;">Enter</kbd> 
                                                    to generate
                                                </div>
                                            }
                                        </div>
                                        
                                        @* Analysis Type Selection - Enhanced with API Details *@
                                        <div class="left-panel-section">
                                            <div class="section-header">
                                                <div class="section-header-icon">🎯</div>
                                                <div class="section-header-text">
                                                    <div class="section-header-title">Analysis Type</div>
                                                    <div class="section-header-subtitle">Select what to analyze or generate</div>
                                                </div>
                                                <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.72rem; padding: 5px 10px; font-weight: 600;">64 APIs</span>
                                            </div>
                                            <div class="analysis-picker">
                                                <div class="analysis-group @(IsGroupEnabled("codeGen") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("codeGen")' aria-label="Toggle Code Generation" aria-expanded="@(!IsGroupCollapsed("codeGen"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("codeGen") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>💻 CODE GENERATION — GPT-4o Vision</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("codeGen")" @onchange='e => ToggleGroup("codeGen", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("codeGen"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("codeGen"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "code" ? "active" : "" )" @onclick='() => SelectAnalysis("code")'><span class="analysis-icon">CG</span>Generate Code → HTML/CSS/React/Vue/Blazor</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "codeWithViewModel" ? "active" : "" )" @onclick='() => SelectAnalysis("codeWithViewModel")'><span class="analysis-icon">VM</span>Code + ViewModel → Complete with data binding</button>
                                                        <button type="button" class="analysis-option premium-option @( _selectedAnalysis == "premiumCode" ? "active" : "" )" @onclick="OpenPremiumConversionDialog">
                                                            <span class="analysis-icon" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #78350f;">⭐</span>
                                                            <span>Premium Engine → Multi-pass pixel-perfect conversion</span>
                                                            <span class="badge ms-auto" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: #78350f; font-size: 0.65rem;">BEST</span>
                                                        </button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                                <div class="analysis-group @(IsGroupEnabled("imageExtraction") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("imageExtraction")' aria-label="Toggle Image Extraction" aria-expanded="@(!IsGroupCollapsed("imageExtraction"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("imageExtraction") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>🖼️ IMAGE EXTRACTION — AI + SkiaSharp</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("imageExtraction")" @onchange='e => ToggleGroup("imageExtraction", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("imageExtraction"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("imageExtraction"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "extractImages" ? "active" : "" )" @onclick='() => SelectAnalysis("extractImages")'><span class="analysis-icon">EX</span>Extract All → Detect & crop all images</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "extractIcons" ? "active" : "" )" @onclick='() => SelectAnalysis("extractIcons")'><span class="analysis-icon">IC</span>Icons Only → Small graphics & symbols</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "extractLogos" ? "active" : "" )" @onclick='() => SelectAnalysis("extractLogos")'><span class="analysis-icon">LG</span>Logos/Brands → Brand elements</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "extractPhotos" ? "active" : "" )" @onclick='() => SelectAnalysis("extractPhotos")'><span class="analysis-icon">PH</span>Photos Only → Photographs & images</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "extractAvatars" ? "active" : "" )" @onclick='() => SelectAnalysis("extractAvatars")'><span class="analysis-icon">AV</span>Avatars → Profile pictures & people</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "extractCharts" ? "active" : "" )" @onclick='() => SelectAnalysis("extractCharts")'><span class="analysis-icon">CH</span>Charts → Graphs & diagrams</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "extractBackgrounds" ? "active" : "" )" @onclick='() => SelectAnalysis("extractBackgrounds")'><span class="analysis-icon">BG</span>Backgrounds → Background images</button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                                <div class="analysis-group @(IsGroupEnabled("textOcr") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("textOcr")' aria-label="Toggle Text and OCR" aria-expanded="@(!IsGroupCollapsed("textOcr"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("textOcr") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>📝 TEXT & OCR — Vision + GPT-4o</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("textOcr")" @onchange='e => ToggleGroup("textOcr", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("textOcr"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("textOcr"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "text" ? "active" : "" )" @onclick='() => SelectAnalysis("text")'><span class="analysis-icon">TX</span>Extract Text → OCR all visible text</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "handwriting" ? "active" : "" )" @onclick='() => SelectAnalysis("handwriting")'><span class="analysis-icon">HW</span>Handwriting → Transcribe handwritten text</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "table" ? "active" : "" )" @onclick='() => SelectAnalysis("table")'><span class="analysis-icon">TB</span>Table Data → Extract rows & columns</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "math" ? "active" : "" )" @onclick='() => SelectAnalysis("math")'><span class="analysis-icon">MX</span>Math Equations → Convert to LaTeX</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "denseCaptions" ? "active" : "" )" @onclick='() => SelectAnalysis("denseCaptions")'><span class="analysis-icon">DC</span>Dense Captions → Multiple region descriptions</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "singleCaption" ? "active" : "" )" @onclick='() => SelectAnalysis("singleCaption")'><span class="analysis-icon">SC</span>Single Caption → One sentence description</button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                                <div class="analysis-group @(IsGroupEnabled("docIntel") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("docIntel")' aria-label="Toggle Document Intelligence" aria-expanded="@(!IsGroupCollapsed("docIntel"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("docIntel") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>📄 DOCUMENT INTELLIGENCE — Azure AI</span>
                                                             <span class="badge badge-microsoft">Microsoft</span>
                                                             @{ var docIntelStatus = GetServiceStatus("docIntel"); }
                                                             <span class="status-icon" title="@docIntelStatus.title">@docIntelStatus.icon</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("docIntel")" @onchange='e => ToggleGroup("docIntel", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("docIntel"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("docIntel"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "document" ? "active" : "" )" @onclick='() => SelectAnalysis("document")'><span class="analysis-icon">DI</span>Parse Document → Extract structured data</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "invoice" ? "active" : "" )" @onclick='() => SelectAnalysis("invoice")'><span class="analysis-icon">IN</span>Invoice → Vendor, items, totals</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "receipt" ? "active" : "" )" @onclick='() => SelectAnalysis("receipt")'><span class="analysis-icon">RC</span>Receipt → Merchant, items, total</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "idDocument" ? "active" : "" )" @onclick='() => SelectAnalysis("idDocument")'><span class="analysis-icon">ID</span>ID Document → Name, DOB, ID number</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "businessCard" ? "active" : "" )" @onclick='() => SelectAnalysis("businessCard")'><span class="analysis-icon">BC</span>Business Card → Contact info</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "chart" ? "active" : "" )" @onclick='() => SelectAnalysis("chart")'><span class="analysis-icon">CD</span>Chart Data → Extract graph values</button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                                <div class="analysis-group @(IsGroupEnabled("customVision") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("customVision")' aria-label="Toggle Custom Vision" aria-expanded="@(!IsGroupCollapsed("customVision"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("customVision") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>🤖 CUSTOM VISION — Advanced AI</span>
                                                             <span class="badge badge-microsoft">Microsoft</span>
                                                             @{ var customVisionStatus = GetServiceStatus("customVision"); }
                                                             <span class="status-icon" title="@customVisionStatus.title">@customVisionStatus.icon</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("customVision")" @onchange='e => ToggleGroup("customVision", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("customVision"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("customVision"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "customVisionClassify" ? "active" : "" )" @onclick='() => SelectAnalysis("customVisionClassify")'><span class="analysis-icon">CL</span>Custom Classify → Project-trained labels</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "customVisionDetect" ? "active" : "" )" @onclick='() => SelectAnalysis("customVisionDetect")'><span class="analysis-icon">DT</span>Custom Detect → Project-trained objects</button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                                <div class="analysis-group @(IsGroupEnabled("video") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("video")' aria-label="Toggle Video Analysis" aria-expanded="@(!IsGroupCollapsed("video"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("video") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>🎬 VIDEO ANALYSIS — Advanced AI</span>
                                                             <span class="badge badge-microsoft">Microsoft</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("video")" @onchange='e => ToggleGroup("video", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("video"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("video"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "videoFrames" ? "active" : "" )" @onclick='() => SelectAnalysis("videoFrames")'><span class="analysis-icon">VF</span>Extract Frames → Sample video timeline</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "videoAnalyze" ? "active" : "" )" @onclick='() => SelectAnalysis("videoAnalyze")'><span class="analysis-icon">VA</span>Analyze Video → Insights & transcript</button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                                <div class="analysis-group @(IsGroupEnabled("design") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("design")' aria-label="Toggle Design Analysis" aria-expanded="@(!IsGroupCollapsed("design"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("design") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>🎨 DESIGN ANALYSIS — GPT-4o Vision</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("design")" @onchange='e => ToggleGroup("design", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("design"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("design"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "describe" ? "active" : "" )" @onclick='() => SelectAnalysis("describe")'><span class="analysis-icon">DS</span>Describe → Full UI description</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "colors" ? "active" : "" )" @onclick='() => SelectAnalysis("colors")'><span class="analysis-icon">CL</span>Colors → Extract color palette</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "typography" ? "active" : "" )" @onclick='() => SelectAnalysis("typography")'><span class="analysis-icon">TY</span>Typography → Fonts & text styles</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "layout" ? "active" : "" )" @onclick='() => SelectAnalysis("layout")'><span class="analysis-icon">LY</span>Layout → Grid, spacing, structure</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "components" ? "active" : "" )" @onclick='() => SelectAnalysis("components")'><span class="analysis-icon">CP</span>Components → UI elements & hierarchy</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "icons" ? "active" : "" )" @onclick='() => SelectAnalysis("icons")'><span class="analysis-icon">IC</span>Icons → Identify icon library matches</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "smartCrops" ? "active" : "" )" @onclick='() => SelectAnalysis("smartCrops")'><span class="analysis-icon">CR</span>Smart Crops → AI crop suggestions</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "tags" ? "active" : "" )" @onclick='() => SelectAnalysis("tags")'><span class="analysis-icon">TG</span>Tags → Content categorization</button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                                <div class="analysis-group @(IsGroupEnabled("advanced") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("advanced")' aria-label="Toggle Advanced Analysis" aria-expanded="@(!IsGroupCollapsed("advanced"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("advanced") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>🔍 ADVANCED ANALYSIS — GPT-4o + Vision</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("advanced")" @onchange='e => ToggleGroup("advanced", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("advanced"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("advanced"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "accessibility" ? "active" : "" )" @onclick='() => SelectAnalysis("accessibility")'><span class="analysis-icon">AC</span>Accessibility → WCAG audit & issues</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "improvements" ? "active" : "" )" @onclick='() => SelectAnalysis("improvements")'><span class="analysis-icon">UX</span>Improvements → UX suggestions</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "compare" ? "active" : "" )" @onclick='() => SelectAnalysis("compare")'><span class="analysis-icon">C2</span>Compare 2 → Diff two images</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "compareMultiple" ? "active" : "" )" @onclick='() => SelectAnalysis("compareMultiple")'><span class="analysis-icon">CM</span>Compare Multiple → Multi-image diff</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "imageDiff" ? "active" : "" )" @onclick='() => SelectAnalysis("imageDiff")'><span class="analysis-icon">DF</span>Image Diff → Highlight changes</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "askQuestion" ? "active" : "" )" @onclick='() => SelectAnalysis("askQuestion")'><span class="analysis-icon">Q?</span>Ask Question → Custom image Q&A</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "spatialQuestion" ? "active" : "" )" @onclick='() => SelectAnalysis("spatialQuestion")'><span class="analysis-icon">SP</span>Spatial Q&A → "What's left of X?"</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "comprehensive" ? "active" : "" )" @onclick='() => SelectAnalysis("comprehensive")'><span class="analysis-icon">FA</span>Full Analysis → Complete UI breakdown</button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                                <div class="analysis-group @(IsGroupEnabled("imageProcessing") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("imageProcessing")' aria-label="Toggle Image Processing" aria-expanded="@(!IsGroupCollapsed("imageProcessing"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("imageProcessing") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>🖼️ IMAGE PROCESSING — Azure + DALL-E</span>
                                                             <span class="badge badge-microsoft">Microsoft</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("imageProcessing")" @onchange='e => ToggleGroup("imageProcessing", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("imageProcessing"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("imageProcessing"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "removeBackground" ? "active" : "" )" @onclick='() => SelectAnalysis("removeBackground")'><span class="analysis-icon">RB</span>Remove Background → Transparent PNG</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "upscale" ? "active" : "" )" @onclick='() => SelectAnalysis("upscale")'><span class="analysis-icon">UP</span>Upscale → 2x/4x resolution</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "styleTransfer" ? "active" : "" )" @onclick='() => SelectAnalysis("styleTransfer")'><span class="analysis-icon">ST</span>Style Transfer → Apply artistic style</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "segment" ? "active" : "" )" @onclick='() => SelectAnalysis("segment")'><span class="analysis-icon">SG</span>Segment → Split into regions</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "depthMap" ? "active" : "" )" @onclick='() => SelectAnalysis("depthMap")'><span class="analysis-icon">DM</span>Depth Map → 3D depth estimation</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "editImage" ? "active" : "" )" @onclick='() => SelectAnalysis("editImage")'><span class="analysis-icon">ED</span>Edit (DALL-E) → Modify image regions</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "imageVariations" ? "active" : "" )" @onclick='() => SelectAnalysis("imageVariations")'><span class="analysis-icon">VR</span>Variations (DALL-E) → Similar images</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "generateImage" ? "active" : "" )" @onclick='() => SelectAnalysis("generateImage")'><span class="analysis-icon">GI</span>Generate (DALL-E) → Create from text</button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                                <div class="analysis-group @(IsGroupEnabled("azureVision") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("azureVision")' aria-label="Toggle Azure Vision" aria-expanded="@(!IsGroupCollapsed("azureVision"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("azureVision") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>👁️ AZURE VISION 4.0 — Computer Vision</span>
                                                             <span class="badge badge-microsoft">Microsoft</span>
                                                             @{ var azureVisionStatus = GetServiceStatus("azureVision"); }
                                                             <span class="status-icon" title="@azureVisionStatus.title">@azureVisionStatus.icon</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("azureVision")" @onchange='e => ToggleGroup("azureVision", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("azureVision"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("azureVision"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "visionAnalyze" ? "active" : "" )" @onclick='() => SelectAnalysis("visionAnalyze")'><span class="analysis-icon">VA</span>Analyze (Objects + Captions) → Quick vision pass</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "visionCaption" ? "active" : "" )" @onclick='() => SelectAnalysis("visionCaption")'><span class="analysis-icon">CP</span>Caption → Single description</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "visionDenseCaptions" ? "active" : "" )" @onclick='() => SelectAnalysis("visionDenseCaptions")'><span class="analysis-icon">DC</span>Dense Captions → Region captions</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "visionTags" ? "active" : "" )" @onclick='() => SelectAnalysis("visionTags")'><span class="analysis-icon">TG</span>Tags → Content labels</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "visionSmartCrops" ? "active" : "" )" @onclick='() => SelectAnalysis("visionSmartCrops")'><span class="analysis-icon">SC</span>Smart Crops → Suggested crops</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "visionRead" ? "active" : "" )" @onclick='() => SelectAnalysis("visionRead")'><span class="analysis-icon">OR</span>OCR (Vision) → Printed/handwriting</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "detectObjects" ? "active" : "" )" @onclick='() => SelectAnalysis("detectObjects")'><span class="analysis-icon">OB</span>Objects → Detect with bounding boxes</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "detectFaces" ? "active" : "" )" @onclick='() => SelectAnalysis("detectFaces")'><span class="analysis-icon">FC</span>Faces → Age, gender, emotion</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "detectPeople" ? "active" : "" )" @onclick='() => SelectAnalysis("detectPeople")'><span class="analysis-icon">PE</span>People → Person detection</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "detectBrands" ? "active" : "" )" @onclick='() => SelectAnalysis("detectBrands")'><span class="analysis-icon">BR</span>Brands → Logo recognition</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "imageType" ? "active" : "" )" @onclick='() => SelectAnalysis("imageType")'><span class="analysis-icon">IT</span>Image Type → Photo/clipart/drawing</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "adultContent" ? "active" : "" )" @onclick='() => SelectAnalysis("adultContent")'><span class="analysis-icon">SA</span>Content Check → Adult/racy/gore</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "imageCategory" ? "active" : "" )" @onclick='() => SelectAnalysis("imageCategory")'><span class="analysis-icon">CT</span>Category → Scene classification</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "analyzeComprehensive" ? "active" : "" )" @onclick='() => SelectAnalysis("analyzeComprehensive")'><span class="analysis-icon">VF</span>Vision Full → All features combined</button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                                <div class="analysis-group @(IsGroupEnabled("chat") ? string.Empty : "analysis-group-disabled")">
                                                    <div class="analysis-group-title">
                                                        <div class="d-flex align-items-center gap-2">
                                                            <button type="button" class="collapse-toggle" @onclick='() => ToggleGroupCollapse("chat")' aria-label="Toggle Chat" aria-expanded="@(!IsGroupCollapsed("chat"))">
                                                                <span class="collapse-icon @(IsGroupCollapsed("chat") ? "collapsed" : string.Empty)"></span>
                                                            </button>
                                                            <span>🤖 CHAT & CUSTOM — GPT-4o</span>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="form-check form-switch m-0">
                                                                <input class="form-check-input" type="checkbox" role="switch" checked="@IsGroupEnabled("chat")" @onchange='e => ToggleGroup("chat", e.Value)' />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    @if (IsGroupCollapsed("chat"))
                                                    {
                                                        <div class="group-collapsed-note">Collapsed — expand to choose an option.</div>
                                                    }
                                                    else if (IsGroupEnabled("chat"))
                                                    {
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "chat" ? "active" : "" )" @onclick='() => SelectAnalysis("chat")'><span class="analysis-icon">CH</span>Chat → Conversation with AI</button>
                                                        <button type="button" class="analysis-option @( _selectedAnalysis == "customPrompt" ? "active" : "" )" @onclick='() => SelectAnalysis("customPrompt")'><span class="analysis-icon">CP</span>Custom Prompt → Your own question</button>
                                                    }
                                                    else
                                                    {
                                                        <div class="group-collapsed-note">Group excluded</div>
                                                    }
                                                </div>
                                            </div>
                                            
                                            @* API Details Card - Enhanced *@
                                            <div class="api-detail-card mt-3 p-3" style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); border-radius: 12px; border: 2px solid #e0e7ff;">
                                                <div class="d-flex align-items-start gap-3">
                                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 12px; display: flex; align-items: center; justify-content: center;">
                                                        <span style="font-size: 1.6rem;">@GetAnalysisButtonIcon()</span>
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <div class="fw-bold" style="color: #4c1d95; font-size: 1.05rem; margin-bottom: 4px;">@GetAnalysisDisplayName()</div>
                                                        <div style="color: #6b7280; font-size: 0.85rem; line-height: 1.45;">@GetAnalysisDescription()</div>
                                                        <div class="mt-2 d-flex flex-wrap gap-2">
                                                            <span class="badge" style="background: @GetServiceBadgeColor(); font-size: 0.75rem; padding: 5px 10px; font-weight: 600;">@GetServiceName()</span>
                                                            @if (IsAzureVisionRequired())
                                                            {
                                                                <span class="badge" style="background: @(AzureVision?.IsConfigured == true ? "#10b981" : "#ef4444"); font-size: 0.75rem; padding: 5px 10px; font-weight: 600;">
                                                                    @(AzureVision?.IsConfigured == true ? "✓ Vision Ready" : "⚠ Vision Required")
                                                                </span>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        @* Image Extraction Options *@
                                        @if (_selectedAnalysis == "extractImages")
                                        {
                                            <div class="left-panel-section">
                                                <div class="section-header">
                                                    <div class="section-header-icon">🎯</div>
                                                    <div class="section-header-text">
                                                        <div class="section-header-title">Extraction Mode</div>
                                                        <div class="section-header-subtitle">Configure image extraction settings</div>
                                                    </div>
                                                    <button type="button" class="btn btn-sm" 
                                                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; padding: 4px 12px; font-size: 0.72rem; font-weight: 600;"
                                                            @onclick="ShowExtractionModeInfo">
                                                        ℹ️ Info
                                                    </button>
                                                </div>
                                                @{
                                                    var azureVisionAvailable = AzureVision?.IsConfigured ?? false;
                                                    var visionStatus = azureVisionAvailable ? "✅" : "❌ NA";
                                                }
                                                <select class="form-select form-control-modern form-select-sm mb-2" @bind="_cropMode">
                                                    <optgroup label="☁️ Azure AI Vision 4.0">
                                                        <option value="AzureVision">🎯 Azure Vision (Azure AI Vision API) @visionStatus</option>
                                                        <option value="AzureVisionComprehensive">🔮 Comprehensive (Azure AI Vision API) @visionStatus</option>
                                                        <option value="AzureVisionPeople">👤 People/Avatars (Azure AI Vision API) @visionStatus</option>
                                                    </optgroup>
                                                    <optgroup label="🤖 Azure OpenAI GPT-4o">
                                                        <option value="SmartDetect">🔬 Smart Detect (GPT-4o + SkiaSharp) ✅</option>
                                                        <option value="AIRegions">🤖 AI Regions (GPT-4o) ✅</option>
                                                    </optgroup>
                                                    <optgroup label="⚡ Hybrid">
                                                        <option value="HybridPixelPerfect">⚡ Hybrid Best (Vision + GPT-4o) @visionStatus</option>
                                                    </optgroup>
                                                    <optgroup label="🖼️ Local (SkiaSharp)">
                                                        <option value="SmartUICards">🃏 UI Cards ✅</option>
                                                        <option value="ContourDetection">📐 Contours ✅</option>
                                                        <option value="FloodFillRegions">🌊 Flood Fill ✅</option>
                                                        <option value="Components">🧩 Components ✅</option>
                                                        <option value="Grid">📊 Grid ✅</option>
                                                        <option value="Sections">📑 Sections ✅</option>
                                                    </optgroup>
                                                </select>
                                                @if (!azureVisionAvailable)
                                                {
                                                    <div class="small" style="color: #dc3545; margin-top: 4px;">
                                                        ⚠️ Azure Vision not configured. Set <code>VisionEndpoint</code> and <code>VisionKey</code> in appsettings.json
                                                    </div>
                                                }
                                                
                                                @if (_cropMode == "Grid")
                                                {
                                                    <div class="row g-2 mb-2">
                                                        <div class="col-6">
                                                            <label class="small text-muted">Rows</label>
                                                            <input type="number" class="form-control form-control-sm" @bind="_gridRows" min="1" max="10" />
                                                        </div>
                                                        <div class="col-6">
                                                            <label class="small text-muted">Columns</label>
                                                            <input type="number" class="form-control form-control-sm" @bind="_gridColumns" min="1" max="10" />
                                                        </div>
                                                    </div>
                                                }
                                                
                                                @if (_cropMode == "Components")
                                                {
                                                    <div class="mb-2">
                                                        <label class="small text-muted">Min Component Size (px)</label>
                                                        <input type="number" class="form-control form-control-sm" @bind="_minComponentSize" min="5" max="200" />
                                                    </div>
                                                }
                                                
                                                @if (_cropMode == "SmartDetect" || _cropMode == "AIRegions")
                                                {
                                                    <label class="section-title mb-1 mt-2">🔍 Extraction Type</label>
                                                    <select class="form-select form-control-modern form-select-sm mb-2" @bind="_extractionType">
                                                        <option value="all">📦 All Images & Graphics</option>
                                                        <option value="icons">🎯 Icons Only</option>
                                                        <option value="logos">🏷️ Logos & Branding</option>
                                                        <option value="photos">📷 Photos Only</option>
                                                        <option value="illustrations">🎨 Illustrations</option>
                                                        <option value="charts">📊 Charts & Diagrams</option>
                                                        <option value="backgrounds">🖼️ Background Images</option>
                                                        <option value="avatars">👤 Avatars & Profile Images</option>
                                                    </select>
                                                }
                                                
                                                <label class="section-title mb-1 mt-2">📐 Size Filter</label>
                                                <select class="form-select form-control-modern form-select-sm mb-2" @bind="_extractionSizeFilter">
                                                    <option value="all">All Sizes</option>
                                                    <option value="small">Small (≤64px)</option>
                                                    <option value="medium">Medium (65-256px)</option>
                                                    <option value="large">Large (>256px)</option>
                                                    <option value="custom">Custom Size Range</option>
                                                </select>
                                                
                                                @if (_extractionSizeFilter == "custom")
                                                {
                                                    <div class="row g-2 mb-2">
                                                        <div class="col-6">
                                                            <label class="small text-muted">Min (px)</label>
                                                            <input type="number" class="form-control form-control-sm" @bind="_extractionMinSize" min="1" placeholder="16" />
                                                        </div>
                                                        <div class="col-6">
                                                            <label class="small text-muted">Max (px)</label>
                                                            <input type="number" class="form-control form-control-sm" @bind="_extractionMaxSize" min="1" placeholder="1000" />
                                                        </div>
                                                    </div>
                                                }
                                                
                                                <label class="section-title mb-1 mt-2">⚙️ Options</label>
                                                @if (_cropMode == "SmartDetect")
                                                {
                                                    <div class="form-check mb-1">
                                                        <input class="form-check-input" type="checkbox" id="refineEdges" @bind="_refineWithEdgeDetection" />
                                                        <label class="form-check-label small" for="refineEdges">Refine bounds with edge detection</label>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="small text-muted">Edge Threshold</label>
                                                        <input type="range" class="form-range" @bind="_edgeDetectionThreshold" min="10" max="100" />
                                                        <small class="text-muted">@_edgeDetectionThreshold</small>
                                                    </div>
                                                }
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" id="addPadding" @bind="_extractionAddPadding" />
                                                    <label class="form-check-label small" for="addPadding">Add padding (2px)</label>
                                                </div>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" id="includeCoords" @bind="_extractionIncludeCoordinates" />
                                                    <label class="form-check-label small" for="includeCoords">Show coordinates</label>
                                                </div>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" id="detectOnly" @bind="_extractionDetectOnly" />
                                                    <label class="form-check-label small" for="detectOnly">Detect only (no crop)</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="highConfidence" @bind="_extractionHighConfidenceOnly" />
                                                    <label class="form-check-label small" for="highConfidence">High confidence (≥80%)</label>
                                                </div>
                                            </div>
                                        }
                                        
                                        @if (_selectedAnalysis == "code" || _selectedAnalysis == "codeWithViewModel")
                                        {
                                            <div class="left-panel-section">
                                                <div class="section-header">
                                                    <div class="section-header-icon">🎯</div>
                                                    <div class="section-header-text">
                                                        <div class="section-header-title">Target Framework</div>
                                                        <div class="section-header-subtitle">Choose output format for code generation</div>
                                                    </div>
                                                </div>
                                                <select class="form-select form-control-modern" @bind="_targetFramework" style="font-size: 1rem; padding: 12px 14px; font-weight: 500; border: 2px solid #e0e7ff;">
                                                    <option value="HTML/CSS">🌐 HTML/CSS — Vanilla web</option>
                                                    <option value="Tailwind CSS">🎨 Tailwind CSS — Utility-first</option>
                                                    <option value="React">⚛️ React — JSX Component</option>
                                                    <option value="Vue">💚 Vue.js — SFC Component</option>
                                                    <option value="Blazor Razor">🔷 Blazor Razor — .razor file</option>
                                                    <option value="Razor Pages">📄 Razor Pages — .cshtml file</option>
                                                    <option value="SwiftUI">🍎 SwiftUI — iOS/macOS</option>
                                                    <option value="MAUI XAML">📱 .NET MAUI — Cross-platform</option>
                                                    <option value="Angular">🅰️ Angular — TypeScript</option>
                                                </select>
                                            </div>
                                        }
                                        
                                    </div>
                                </div>
                                
                                @* Draggable Vertical Splitter *@
                                <div class="vertical-splitter" id="splitter" @onmousedown="StartSplitterDrag"></div>
                            
                                @* Right Pane - Results - Full Height *@
                                <div class="split-pane-right" id="rightPane">
                                    @if (_selectedAnalysis == "code")
                                    {
                                        @* Code Generation Output with Inline Preview *@
                                        <div class="code-output-panel p-2">
                                            @* Header - Compact *@
                                            <div class="d-flex align-items-center justify-content-between mb-2" style="flex-shrink: 0;">
                                                <div class="d-flex align-items-center gap-2">
                                                    <h6 class="fw-bold mb-0" style="color: #667eea; font-size: 0.95rem;">
                                                        <span class="me-1">💻</span>Generated Code
                                                    </h6>
                                                    @if (!string.IsNullOrEmpty(_codeLanguage))
                                                    {
                                                        <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.65rem; padding: 3px 7px;">@_codeLanguage.ToUpper()</span>
                                                    }
                                                </div>
                                                <div class="d-flex gap-2 align-items-center">
                                                    @if (!string.IsNullOrEmpty(_generatedCode))
                                                    {
                                                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px; padding: 4px 10px; font-size: 0.7rem; font-weight: 600;" @onclick="CopyCodeToClipboard">
                                                            @(_codeCopied ? "✓ Copied!" : "📋 Copy")
                                                        </button>
                                                        @if (CanShowPreview())
                                                        {
                                                            <button type="button" class="btn btn-sm" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 6px; padding: 4px 10px; font-size: 0.7rem; font-weight: 600;" @onclick="DownloadPreviewHtml">
                                                                📥 Download
                                                            </button>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                            
                                            @* View Mode Tabs - Compact *@
                                            @if (!string.IsNullOrEmpty(_generatedCode) && CanShowPreview())
                                            {
                                                <div class="d-flex gap-2 mb-2" style="flex-shrink: 0; background: #f1f5f9; padding: 6px; border-radius: 8px;">
                                                    <button class="btn btn-sm @(_codeViewMode == "code" ? "" : "btn-outline-secondary")" 
                                                            style="@(_codeViewMode == "code" ? "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;" : "") border-radius: 6px; padding: 6px 14px; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 4px;"
                                                            @onclick="SetCodeViewMode">
                                                        <span>💻</span> Code
                                                    </button>
                                                    <button class="btn btn-sm @(_codeViewMode == "preview" ? "" : "btn-outline-secondary")" 
                                                            style="@(_codeViewMode == "preview" ? "background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;" : "") border-radius: 6px; padding: 6px 14px; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 4px;"
                                                            @onclick="SetPreviewViewMode">
                                                        <span>👁️</span> Preview
                                                    </button>
                                                    <button class="btn btn-sm @(_codeViewMode == "split" ? "" : "btn-outline-secondary")" 
                                                            style="@(_codeViewMode == "split" ? "background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;" : "") border-radius: 6px; padding: 6px 14px; font-weight: 700; font-size: 0.8rem; display: flex; align-items: center; gap: 4px;"
                                                            @onclick="SetSplitViewMode">
                                                        <span>◧</span> Split
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-auto" 
                                                            style="border-radius: 6px; padding: 6px 10px; font-weight: 600; font-size: 0.8rem;"
                                                            @onclick="OpenPreviewPopup" title="Open in new window">
                                                        🔗
                                                    </button>
                                                </div>
                                            }

                                            @* Content Area - Fills Remaining Space *@
                                            <div class="code-view-container">
                                            @if (_isConvertingToCode)
                                            {
                                                <div class="text-center" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                    <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: #667eea;"></div>
                                                    <p class="fw-semibold" style="color: #667eea;">Generating @_targetFramework code...</p>
                                                    @if (!string.IsNullOrEmpty(_premiumConversionProgress))
                                                    {
                                                        <p class="small fw-semibold" style="color: #764ba2;">@_premiumConversionProgress</p>
                                                        @if (_premiumConversionProgressPercent > 0)
                                                        {
                                                            <div class="progress mt-2" style="width: 200px; height: 6px; background: #e2e8f0; border-radius: 3px;">
                                                                <div class="progress-bar" role="progressbar" style="width: @(_premiumConversionProgressPercent)%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 3px;"></div>
                                                            </div>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <p class="small text-muted">GPT-4o Vision is analyzing your UI</p>
                                                    }
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(_generatedCode))
                                            {
                                                @if (_codeViewMode == "code" || !CanShowPreview())
                                                {
                                                    @* Code Only View - Full Height *@
                                                    <div style="flex: 1; display: flex; flex-direction: column; border-radius: 10px; border: 2px solid #667eea; overflow: hidden; min-height: 0;">
                                                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; font-weight: 600; font-size: 0.8rem; flex-shrink: 0; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);">
                                                            💻 Generated Code — @_targetFramework
                                                        </div>
                                                        <div style="flex: 1; overflow: auto; min-height: 0; background: #1e293b;">
                                                            <pre class="code-pre" style="margin: 0; padding: 12px; white-space: pre-wrap; min-height: 100%; font-size: 12px; line-height: 1.5; background: #1e293b; color: #e2e8f0;">@_generatedCode</pre>
                                                        </div>
                                                    </div>
                                                }
                                                else if (_codeViewMode == "preview")
                                                {
                                                    @* Preview Only View - Full Height *@
                                                    <div style="flex: 1; display: flex; flex-direction: column; border-radius: 10px; border: 2px solid #10b981; overflow: hidden; min-height: 0;">
                                                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
                                                            <span style="font-weight: 600; font-size: 0.85rem;">👁️ @GetPreviewTitle()</span>
                                                            <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 5px; padding: 3px 10px; font-size: 0.75rem;" @onclick="RefreshPreview">🔄 Refresh</button>
                                                        </div>
                                                        <div class="stack-fill" style="flex: 1; background: white; position: relative; overflow: hidden;">
                                                            @if (CanShowPreview())
                                                            {
                                                                @* Universal Preview - Works for both Razor and HTML frameworks *@
                                                                <DynamicRazorPreview 
                                                                    RazorMarkup="@_generatedCode" 
                                                                    Framework="@_targetFramework"
                                                                    ShowWarnings="true"
                                                                    ContainerStyle="width: 100%; height: 100%; min-height: 0;" />
                                                            }
                                                            else
                                                            {
                                                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #888;">
                                                                    <p>Preview not available for @_targetFramework</p>
                                                                </div>
                                                            }
                                                        </div>
                                                    </div>
                                                }
                                                else if (_codeViewMode == "split")
                                                {
                                                    @* Split View - Code + Preview - Full Height *@
                                                    <div style="flex: 1; display: flex; gap: 10px; min-height: 0;">
                                                        @* Code Panel - Full Height *@
                                                        <div style="flex: 1; display: flex; flex-direction: column; border-radius: 10px; border: 2px solid #667eea; overflow: hidden; min-width: 0; min-height: 0;">
                                                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; font-weight: 600; font-size: 0.8rem; flex-shrink: 0; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);">
                                                                💻 Code
                                                            </div>
                                                            <div style="flex: 1; overflow: auto; min-height: 0; background: #1e293b;">
                                                                <pre class="code-pre" style="margin: 0; padding: 10px; white-space: pre-wrap; min-height: 100%; font-size: 11px; line-height: 1.4; background: #1e293b; color: #e2e8f0;">@_generatedCode</pre>
                                                            </div>
                                                        </div>
                                                        @* Preview Panel - Full Height *@
                                                        <div style="flex: 1; display: flex; flex-direction: column; border-radius: 10px; border: 2px solid #10b981; overflow: hidden; min-width: 0; min-height: 0;">
                                                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 12px; font-weight: 600; font-size: 0.8rem; flex-shrink: 0;">
                                                                👁️ @GetPreviewTitle()
                                                            </div>
                                                            <div class="stack-fill" style="flex: 1; background: white; position: relative; overflow: hidden;">
                                                                @if (CanShowPreview())
                                                                {
                                                                    @* Universal Preview - Works for both Razor and HTML frameworks *@
                                                                    <DynamicRazorPreview 
                                                                        RazorMarkup="@_generatedCode" 
                                                                        Framework="@_targetFramework"
                                                                        ShowWarnings="false"
                                                                        ContainerStyle="width: 100%; height: 100%; min-height: 0;" />
                                                                }
                                                                else
                                                                {
                                                                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #888;">
                                                                        <p>Preview not available for @_targetFramework</p>
                                                                    </div>
                                                                }
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="text-center" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);">
                                                        <span style="font-size: 36px;">💻</span>
                                                    </div>
                                                    <p class="mt-2 fw-bold" style="color: #667eea; font-size: 1rem;">Ready to Generate Code</p>
                                                    <p class="text-muted small" style="max-width: 280px;">Upload a UI screenshot and click Generate</p>
                                                </div>
                                            }
                                            </div>
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "codeWithViewModel")
                                    {
                                        @* Code + ViewModel Generation with OCR *@
                                        <div class="p-3" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; display: flex; flex-direction: column; height: 100%;">
                                            @* Tabs *@
                                            <ul class="nav nav-tabs mb-3" style="border-bottom: 2px solid #e0e0e0; flex-shrink: 0;">
                                                <li class="nav-item">
                                                    <button class="nav-link @(_viewModelTab == "extracted" ? "active" : "")" style="@(_viewModelTab == "extracted" ? "color: #667eea; border-color: #667eea #667eea #fff; font-weight: 600;" : "color: #666;")" @onclick='() => _viewModelTab = "extracted"'>
                                                        📜 Extracted Text
                                                    </button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link @(_viewModelTab == "viewmodel" ? "active" : "")" style="@(_viewModelTab == "viewmodel" ? "color: #667eea; border-color: #667eea #667eea #fff; font-weight: 600;" : "color: #666;")" @onclick='() => _viewModelTab = "viewmodel"'>
                                                        📋 ViewModel
                                                    </button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link @(_viewModelTab == "razor" ? "active" : "")" style="@(_viewModelTab == "razor" ? "color: #667eea; border-color: #667eea #667eea #fff; font-weight: 600;" : "color: #666;")" @onclick='() => _viewModelTab = "razor"'>
                                                        🔷 Razor Page
                                                    </button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link @(_viewModelTab == "preview" ? "active" : "")" style="@(_viewModelTab == "preview" ? "color: #667eea; border-color: #667eea #667eea #fff; font-weight: 600;" : "color: #666;")" @onclick='() => _viewModelTab = "preview"'>
                                                        👁️ Preview
                                                    </button>
                                                </li>
                                            </ul>
                                            
                                            @if (_isConvertingToCode)
                                            {
                                                <div class="text-center py-5">
                                                    <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: #667eea;"></div>
                                                    <p class="fw-semibold" style="color: #667eea;">Extracting text and generating code...</p>
                                                    <p class="small text-muted">This may take a moment</p>
                                                </div>
                                            }
                                            else if (_viewModelTab == "extracted")
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="fw-bold mb-0">📜 Extracted Text/Data</h6>
                                                    @if (!string.IsNullOrEmpty(_extractedTextJson))
                                                    {
                                                        <button class="btn btn-sm btn-outline-secondary" @onclick="CopyExtractedText">📋 Copy</button>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(_extractedTextJson))
                                                {
                                                    <div style="max-height: 400px; overflow: auto; border-radius: 8px; background: #f8f9fa; padding: 12px;">
                                                        <pre style="margin: 0; font-size: 12px; white-space: pre-wrap;">@_extractedTextJson</pre>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-center py-5" style="color: #888;">
                                                        <span style="font-size: 40px; opacity: 0.5;">📜</span>
                                                        <p class="mt-2">Upload an image and click "Generate" to extract text</p>
                                                    </div>
                                                }
                                            }
                                            else if (_viewModelTab == "viewmodel")
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="fw-bold mb-0">📋 Generated ViewModel</h6>
                                                    @if (!string.IsNullOrEmpty(_generatedViewModel))
                                                    {
                                                        <button class="btn btn-sm btn-outline-secondary" @onclick="CopyViewModel">📋 Copy</button>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(_generatedViewModel))
                                                {
                                                    <div style="max-height: 400px; overflow: auto; border-radius: 8px;">
                                                        <pre style="margin: 0; padding: 12px; background: #1e1e1e; color: #d4d4d4; border-radius: 8px; font-size: 11px; white-space: pre-wrap;">@_generatedViewModel</pre>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-center py-5" style="color: #888;">
                                                        <span style="font-size: 40px; opacity: 0.5;">📋</span>
                                                        <p class="mt-2">ViewModel will appear here after generation</p>
                                                    </div>
                                                }
                                            }
                                            else if (_viewModelTab == "razor")
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="fw-bold mb-0">🔷 Generated Razor Page</h6>
                                                    @if (!string.IsNullOrEmpty(_generatedRazorWithParams))
                                                    {
                                                        <button class="btn btn-sm btn-outline-secondary" @onclick="CopyRazorCode">📋 Copy</button>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(_generatedRazorWithParams))
                                                {
                                                    <div style="max-height: 400px; overflow: auto; border-radius: 8px;">
                                                        <pre style="margin: 0; padding: 12px; background: #1e1e1e; color: #d4d4d4; border-radius: 8px; font-size: 11px; white-space: pre-wrap;">@_generatedRazorWithParams</pre>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-center py-5" style="color: #888;">
                                                        <span style="font-size: 40px; opacity: 0.5;">🔷</span>
                                                        <p class="mt-2">Razor page will appear here after generation</p>
                                                    </div>
                                                }
                                            }
                                            else if (_viewModelTab == "preview")
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="fw-bold mb-0">👁️ Live Preview</h6>
                                                    @if (!string.IsNullOrEmpty(_generatedRazorWithParams))
                                                    {
                                                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px;" @onclick="OpenViewModelPreview">🔗 Open in New Window</button>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(_generatedRazorWithParams))
                                                {
                                                    <div style="max-height: 400px; overflow: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: #fff;">
                                                        <DynamicRazorPreview 
                                                            RazorMarkup="@_generatedRazorWithParams" 
                                                            Framework="@_targetFramework"
                                                            ShowWarnings="true"
                                                            ContainerStyle="min-height: 350px;" />
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-center py-5" style="color: #888;">
                                                        <span style="font-size: 40px; opacity: 0.5;">👁️</span>
                                                        <p class="mt-2">Preview will appear here after generation</p>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "colors" && _colorAnalysis != null)
                                    {
                                        @* Color Palette Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">🎨 Extracted Color Palette</h6>
                                            <div class="row g-3">
                                                @if (!string.IsNullOrEmpty(_colorAnalysis.PrimaryColor))
                                                {
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 text-center" style="background: @_colorAnalysis.PrimaryColor; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                                            <small class="d-block fw-bold">Primary</small>
                                                            <code style="color: white;">@_colorAnalysis.PrimaryColor</code>
                                                        </div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(_colorAnalysis.SecondaryColor))
                                                {
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 text-center" style="background: @_colorAnalysis.SecondaryColor; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                                            <small class="d-block fw-bold">Secondary</small>
                                                            <code style="color: white;">@_colorAnalysis.SecondaryColor</code>
                                                        </div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(_colorAnalysis.AccentColor))
                                                {
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 text-center" style="background: @_colorAnalysis.AccentColor; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                                            <small class="d-block fw-bold">Accent</small>
                                                            <code style="color: white;">@_colorAnalysis.AccentColor</code>
                                                        </div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(_colorAnalysis.BackgroundColor))
                                                {
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 text-center border" style="background: @_colorAnalysis.BackgroundColor;">
                                                            <small class="d-block fw-bold">Background</small>
                                                            <code>@_colorAnalysis.BackgroundColor</code>
                                                        </div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(_colorAnalysis.TextColor))
                                                {
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 text-center border" style="background: #f5f5f5;">
                                                            <small class="d-block fw-bold" style="color: @_colorAnalysis.TextColor;">Text</small>
                                                            <code style="color: @_colorAnalysis.TextColor;">@_colorAnalysis.TextColor</code>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                            @if (!string.IsNullOrEmpty(_colorAnalysis.ColorScheme))
                                            {
                                                <div class="mt-3 p-2 rounded" style="background: #f5f5f5;">
                                                    <small><strong>Color Scheme:</strong> @_colorAnalysis.ColorScheme</small>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(_colorAnalysis.Content))
                                            {
                                                <details class="mt-3">
                                                    <summary class="btn btn-sm btn-outline-secondary">View Raw JSON</summary>
                                                    <pre class="mt-2 p-2 rounded" style="background: #f5f5f5; font-size: 11px; max-height: 200px; overflow: auto;">@_colorAnalysis.Content</pre>
                                                </details>
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "typography" && _typographyAnalysis != null)
                                    {
                                        @* Typography Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">🔤 Typography Analysis</h6>
                                            <div class="row g-3">
                                                @if (!string.IsNullOrEmpty(_typographyAnalysis.PrimaryFont))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #f8f9fa;"><small class="text-muted d-block">Primary Font</small><strong style="font-size: 1.1rem;">@_typographyAnalysis.PrimaryFont</strong></div></div>
                                                }
                                                @if (!string.IsNullOrEmpty(_typographyAnalysis.HeadingFont))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #f8f9fa;"><small class="text-muted d-block">Heading Font</small><strong>@_typographyAnalysis.HeadingFont</strong></div></div>
                                                }
                                                @if (!string.IsNullOrEmpty(_typographyAnalysis.BodyFont))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #f8f9fa;"><small class="text-muted d-block">Body Font</small><strong>@_typographyAnalysis.BodyFont</strong></div></div>
                                                }
                                                @if (!string.IsNullOrEmpty(_typographyAnalysis.LineHeight))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #f8f9fa;"><small class="text-muted d-block">Line Height</small><strong>@_typographyAnalysis.LineHeight</strong></div></div>
                                                }
                                            </div>
                                            @if (_typographyAnalysis.FontSizes?.Any() == true)
                                            {
                                                <div class="mt-3">
                                                    <small class="text-muted d-block mb-2">Font Sizes</small>
                                                    <div class="d-flex flex-wrap gap-2">
                                                        @foreach (var size in _typographyAnalysis.FontSizes)
                                                        {
                                                            <span class="badge bg-secondary">@size.Key: @size.Value</span>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "layout" && _layoutAnalysis != null)
                                    {
                                        @* Layout Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">📐 Layout Analysis</h6>
                                            <div class="row g-3">
                                                @if (!string.IsNullOrEmpty(_layoutAnalysis.LayoutType))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #e3f2fd;"><small class="text-muted d-block">Layout Type</small><strong style="color: #1976d2;">@_layoutAnalysis.LayoutType</strong></div></div>
                                                }
                                                @if (!string.IsNullOrEmpty(_layoutAnalysis.ContainerWidth))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #e3f2fd;"><small class="text-muted d-block">Container Width</small><strong>@_layoutAnalysis.ContainerWidth</strong></div></div>
                                                }
                                                @if (_layoutAnalysis.Columns.HasValue)
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #e3f2fd;"><small class="text-muted d-block">Grid Columns</small><strong>@_layoutAnalysis.Columns</strong></div></div>
                                                }
                                                @if (!string.IsNullOrEmpty(_layoutAnalysis.Gap))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #e3f2fd;"><small class="text-muted d-block">Gap</small><strong>@_layoutAnalysis.Gap</strong></div></div>
                                                }
                                            </div>
                                            @if (_layoutAnalysis.Sections?.Any() == true)
                                            {
                                                <div class="mt-3">
                                                    <small class="text-muted d-block mb-2">Sections</small>
                                                    @foreach (var sec in _layoutAnalysis.Sections)
                                                    {
                                                        <div class="p-2 mb-2 rounded" style="background: #f5f5f5;">
                                                            <strong>@(sec.Name)</strong> <span class="badge bg-info">@(sec.Type)</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "components" && _componentsAnalysis != null)
                                    {
                                        @* Components Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">🧩 UI Components</h6>
                                            @if (!string.IsNullOrEmpty(_componentsAnalysis.LayoutType))
                                            {
                                                <div class="mb-3 p-2 rounded" style="background: #fff3e0;"><strong>Layout:</strong> @_componentsAnalysis.LayoutType</div>
                                            }
                                            @if (_componentsAnalysis.Sections?.Any() == true)
                                            {
                                                <div class="mb-3"><strong>Sections:</strong> @string.Join(", ", _componentsAnalysis.Sections)</div>
                                            }
                                            @if (_componentsAnalysis.Components?.Any() == true)
                                            {
                                                @foreach (var comp in _componentsAnalysis.Components)
                                                {
                                                    <div class="p-2 mb-2 rounded border">
                                                        <span class="badge" style="background: #667eea;">@comp.Type</span>
                                                        @if (!string.IsNullOrEmpty(comp.Name)) { <strong class="ms-2">@comp.Name</strong> }
                                                        @if (!string.IsNullOrEmpty(comp.Text)) { <span class="text-muted ms-2">"@comp.Text"</span> }
                                                    </div>
                                                }
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "icons" && _iconsAnalysis != null)
                                    {
                                        @* Icons Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">🎯 Identified Icons</h6>
                                            @if (!string.IsNullOrEmpty(_iconsAnalysis.IconStyle))
                                            {
                                                <div class="mb-2"><strong>Style:</strong> @_iconsAnalysis.IconStyle</div>
                                            }
                                            @if (!string.IsNullOrEmpty(_iconsAnalysis.SuggestedLibrary))
                                            {
                                                <div class="mb-3 p-2 rounded" style="background: #e8f5e9;"><strong>Suggested Library:</strong> <span style="color: #2e7d32;">@_iconsAnalysis.SuggestedLibrary</span></div>
                                            }
                                            @if (_iconsAnalysis.Icons?.Any() == true)
                                            {
                                                <div class="d-flex flex-wrap gap-2">
                                                    @foreach (var icon in _iconsAnalysis.Icons)
                                                    {
                                                        <div class="p-2 rounded border text-center" style="min-width: 80px;">
                                                            <div class="fw-bold">@icon.SuggestedName</div>
                                                            <small class="text-muted">@icon.Location</small>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "accessibility" && _accessibilityAnalysis != null)
                                    {
                                        @* Accessibility Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">♿ Accessibility Audit</h6>
                                            @if (!string.IsNullOrEmpty(_accessibilityAnalysis.OverallScore))
                                            {
                                                var scoreColor = _accessibilityAnalysis.OverallScore == "Good" ? "#4caf50" : _accessibilityAnalysis.OverallScore == "Poor" ? "#f44336" : "#ff9800";
                                                <div class="mb-3 p-3 rounded text-center" style="background: @scoreColor; color: white;">
                                                    <h5 class="mb-0">@_accessibilityAnalysis.OverallScore</h5>
                                                </div>
                                            }
                                            <div class="row g-2 mb-3">
                                                <div class="col-4"><div class="p-2 rounded text-center" style="background: @(_accessibilityAnalysis.HasSufficientTextSize == true ? "#e8f5e9" : "#ffebee");">Text Size: @(_accessibilityAnalysis.HasSufficientTextSize == true ? "✓" : "✗")</div></div>
                                                <div class="col-4"><div class="p-2 rounded text-center" style="background: @(_accessibilityAnalysis.HasClearHierarchy == true ? "#e8f5e9" : "#ffebee");">Hierarchy: @(_accessibilityAnalysis.HasClearHierarchy == true ? "✓" : "✗")</div></div>
                                                <div class="col-4"><div class="p-2 rounded text-center" style="background: @(_accessibilityAnalysis.HasTouchTargets == true ? "#e8f5e9" : "#ffebee");">Touch Targets: @(_accessibilityAnalysis.HasTouchTargets == true ? "✓" : "✗")</div></div>
                                            </div>
                                            @if (_accessibilityAnalysis.Issues?.Any() == true)
                                            {
                                                <h6>Issues Found:</h6>
                                                @foreach (var issue in _accessibilityAnalysis.Issues)
                                                {
                                                    var severityColor = issue.Severity == "critical" ? "#f44336" : issue.Severity == "major" ? "#ff9800" : "#2196f3";
                                                    <div class="p-2 mb-2 rounded border-start border-4" style="border-color: @severityColor !important; background: #fafafa;">
                                                        <span class="badge" style="background: @severityColor;">@issue.Severity</span>
                                                        <span class="ms-2">@issue.Description</span>
                                                        @if (!string.IsNullOrEmpty(issue.Recommendation))
                                                        {
                                                            <div class="small text-muted mt-1">💡 @issue.Recommendation</div>
                                                        }
                                                    </div>
                                                }
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "comprehensive" && _comprehensiveAnalysis != null)
                                    {
                                        @* Comprehensive Analysis Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">🔬 Comprehensive Analysis</h6>
                                            @if (!string.IsNullOrEmpty(_comprehensiveAnalysis.OverallStyle))
                                            {
                                                <div class="mb-3 p-2 rounded" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                                    <strong>Design Style:</strong> @_comprehensiveAnalysis.OverallStyle
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(_comprehensiveAnalysis.Description))
                                            {
                                                <div class="mb-3"><strong>Description:</strong><p class="mb-0 mt-1">@_comprehensiveAnalysis.Description</p></div>
                                            }
                                            @if (_comprehensiveAnalysis.DesignPatterns?.Any() == true)
                                            {
                                                <div class="mb-3"><strong>Design Patterns:</strong><div class="d-flex flex-wrap gap-1 mt-1">@foreach (var p in _comprehensiveAnalysis.DesignPatterns) { <span class="badge bg-secondary">@p</span> }</div></div>
                                            }
                                            @if (_comprehensiveAnalysis.SuggestedFrameworks?.Any() == true)
                                            {
                                                <div class="mb-3"><strong>Suggested Frameworks:</strong><div class="d-flex flex-wrap gap-1 mt-1">@foreach (var f in _comprehensiveAnalysis.SuggestedFrameworks) { <span class="badge bg-info">@f</span> }</div></div>
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "extractImages" && _extractedImagesResult != null)
                                    {
                                        @* Extracted Images Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="fw-bold mb-0" style="color: #333;">
                                                    🖼️ @GetExtractionResultTitle()
                                                    <span class="badge bg-primary ms-2">@(_extractedImagesResult.TotalImagesFound) found</span>
                                                </h6>
                                                @if (_extractedImagesResult.Images?.Any() == true && !_extractionDetectOnly)
                                                {
                                                    <button class="btn btn-sm" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 8px;"
                                                            @onclick="DownloadAllExtractedImages">
                                                        📥 Download All
                                                    </button>
                                                }
                                            </div>
                                            
                                            @if (!string.IsNullOrEmpty(_extractedImagesResult.AnalysisSummary))
                                            {
                                                <div class="alert alert-info py-2 mb-3" style="border-radius: 10px; font-size: 0.85rem;">
                                                    @_extractedImagesResult.AnalysisSummary
                                                </div>
                                            }
                                            
                                            @* Show image with region overlay for detect-only mode *@
                                            @if (_extractionDetectOnly && !string.IsNullOrEmpty(_codeImageBase64) && _extractedImagesResult.Images?.Any() == true)
                                            {
                                                <div class="mb-3 position-relative" style="border: 2px solid #ddd; border-radius: 12px; overflow: hidden;">
                                                    <div style="position: relative; display: inline-block; width: 100%;">
                                                        <img src="@_codeImageUrl" alt="Source image with regions" 
                                                             style="width: 100%; height: auto; display: block;" />
                                                        @{
                                                            int regionIndex = 0;
                                                            var colors = new[] { "#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", "#ffeaa7", "#dfe6e9", "#fd79a8", "#a29bfe" };
                                                        }
                                                        @foreach (var img in _extractedImagesResult.Images!)
                                                        {
                                                            if (img.BoundingBox != null)
                                                            {
                                                                var color = colors[regionIndex % colors.Length];
                                                                <div style="position: absolute; 
                                                                            left: @(img.BoundingBox.NormalizedX * 100)%; 
                                                                            top: @(img.BoundingBox.NormalizedY * 100)%; 
                                                                            width: @(img.BoundingBox.NormalizedWidth * 100)%; 
                                                                            height: @(img.BoundingBox.NormalizedHeight * 100)%;
                                                                            border: 3px solid @color;
                                                                            background: @(color)22;
                                                                            border-radius: 4px;
                                                                            box-sizing: border-box;
                                                                            pointer-events: none;">
                                                                    <span style="position: absolute; top: -1px; left: -1px; background: @color; color: white; font-size: 10px; padding: 1px 4px; border-radius: 0 0 4px 0; font-weight: bold;">@(regionIndex + 1)</span>
                                                                </div>
                                                                regionIndex++;
                                                            }
                                                        }
                                                    </div>
                                                </div>
                                                <div class="mb-2" style="font-size: 0.75rem; color: #666;">
                                                    <strong>Regions Legend:</strong> Hover over regions above or see details below
                                                </div>
                                            }
                                            
                                            @if (_extractedImagesResult.Images?.Any() == true)
                                            {
                                                <div class="row g-3">
                                                    @{
                                                        int cardIndex = 0;
                                                        var cardColors = new[] { "#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", "#ffeaa7", "#dfe6e9", "#fd79a8", "#a29bfe" };
                                                    }
                                                    @foreach (var img in _extractedImagesResult.Images)
                                                    {
                                                        var cardColor = cardColors[cardIndex % cardColors.Length];
                                                        <div class="col-6 col-md-4 col-lg-3">
                                                            <div class="card h-100 shadow-sm" style="border-radius: 12px; overflow: hidden; border-left: 4px solid @cardColor;">
                                                                <div style="height: 120px; background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); display: flex; align-items: center; justify-content: center; padding: 8px; position: relative;">
                                                                    @if (!string.IsNullOrEmpty(img.Base64Data))
                                                                    {
                                                                        <img src="data:image/png;base64,@img.Base64Data" 
                                                                             style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;" 
                                                                             alt="@img.Description" />
                                                                    }
                                                                    else if (_extractionDetectOnly && img.BoundingBox != null)
                                                                    {
                                                                        <div class="text-center w-100" style="color: #666;">
                                                                            <div style="font-size: 28px; font-weight: bold; color: @cardColor;">@(cardIndex + 1)</div>
                                                                            <div style="font-size: 0.7rem; margin-top: 4px;">
                                                                                @img.BoundingBox.Width×@img.BoundingBox.Height px
                                                                            </div>
                                                                            <div style="font-size: 0.65rem; color: #888;">
                                                                                Position: (@img.BoundingBox.X, @img.BoundingBox.Y)
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>
                                                                <div class="card-body p-2">
                                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                                        <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.65rem;">@img.ImageType</span>
                                                                        <span class="badge bg-success" style="font-size: 0.6rem;">@img.Confidence%</span>
                                                                    </div>
                                                                    <small class="d-block text-truncate mb-1" title="@img.Description" style="font-size: 0.75rem; color: #555;">
                                                                        @(img.Description?.Length > 40 ? img.Description[..40] + "..." : img.Description)
                                                                    </small>
                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                        <small class="text-muted" style="font-size: 0.65rem;">@(img.Width)×@(img.Height)px</small>
                                                                        @if (!_extractionDetectOnly && !string.IsNullOrEmpty(img.Base64Data))
                                                                        {
                                                                            <button class="btn btn-sm p-1" style="font-size: 0.65rem; background: #e3f2fd; border: none; border-radius: 6px;" 
                                                                                    @onclick="() => DownloadExtractedImage(img)">
                                                                                📥
                                                                            </button>
                                                                        }
                                                                        @if (_extractionDetectOnly && img.BoundingBox != null)
                                                                        {
                                                                            <button class="btn btn-sm p-1" style="font-size: 0.65rem; background: #e8f5e9; border: none; border-radius: 6px;" 
                                                                                    @onclick="() => CropAndDownloadRegion(img.BoundingBox!)">
                                                                                ✂️ Crop
                                                                            </button>
                                                                        }
                                                                    </div>
                                                                    @if (_extractionIncludeCoordinates && img.BoundingBox != null)
                                                                    {
                                                                        <div class="mt-1 p-1" style="background: #f8f9fa; border-radius: 4px; font-size: 0.6rem; font-family: monospace; color: #666;">
                                                                            x:@img.BoundingBox.X y:@img.BoundingBox.Y w:@img.BoundingBox.Width h:@img.BoundingBox.Height
                                                                        </div>
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                        cardIndex++;
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-center py-5" style="color: #888;">
                                                    <span style="font-size: 48px; opacity: 0.5;">🖼️</span>
                                                    <p class="mt-2">No images found matching your criteria</p>
                                                    <small class="text-muted">Try adjusting the extraction type or size filter</small>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        @* Generic Text Result Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; display: flex; flex-direction: column;">
                                            <h6 class="fw-bold mb-3" style="color: #333; flex-shrink: 0;">📋 Analysis Result</h6>
                                            @if (_isAnalyzing)
                                            {
                                                <div class="text-center py-5" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                    <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: #667eea;"></div>
                                                    <p>Analyzing your design...</p>
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(_analysisResult))
                                            {
                                                <div style="flex: 1; min-height: 0; overflow: auto; display: flex;">
                                                    <pre style="white-space: pre-wrap; font-family: inherit; margin: 0; width: 100%; min-height: 100%;">@_analysisResult</pre>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-center py-5" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888;">
                                                    <span style="font-size: 40px; opacity: 0.5;">🔍</span>
                                                    <p class="mt-2">Upload an image and select an analysis type</p>
                                                </div>
                                            }
                                        </div>
                                    }
                                    
                                    @if (!string.IsNullOrEmpty(_codeError))
                                    {
                                        <div class="alert mt-3 mb-0" style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 1px solid #ff6b6b; border-radius: 12px;">
                                            <strong>⚠️ Error:</strong> @_codeError
                                        </div>
                                    }
                                </div> @* End split-pane-right *@
                            </div> @* End split-container *@
                        </div>
                    </div>
                }
                break;
        }
        
        <p class="text-center mt-4 mb-0" style="color: #999; font-size: 0.85rem;">
            Powered by Azure OpenAI Service
        </p>
    </div>
</div>

@* Service Info Modal Component *@
<ServiceInfoModal @bind-IsVisible="_showServiceInfoModal" 
                  AzureVisionAvailable="@(AzureVision?.IsConfigured ?? false)" 
                  CurrentMode="@_cropMode" />

@* Service Settings Dialog Component *@
<ServiceSettingsDialog @bind-IsVisible="_showServiceSettingsDialog"
                       Settings="_serviceSettings"
                       SecureStorage="SecureStorage"
                       OnSave="HandleServiceSettingsSaved" />

@* Premium Conversion Options Dialog *@
@if (_showPremiumConversionDialog)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 800px; margin: 1.75rem auto;">
            <div class="modal-content" style="border-radius: 24px; border: none; box-shadow: 0 25px 80px rgba(0,0,0,0.35); overflow: hidden;">
                @* Header with gradient *@
                <div class="modal-header border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ec4899 100%); padding: 28px 32px;">
                    <div class="d-flex align-items-center gap-3">
                        <div style="background: rgba(255,255,255,0.2); border-radius: 16px; padding: 14px 16px; backdrop-filter: blur(10px);">
                            <span style="font-size: 2rem;">⭐</span>
                        </div>
                        <div>
                            <h4 class="modal-title mb-1" style="color: white; font-weight: 800; font-size: 1.5rem; letter-spacing: -0.02em;">Premium Conversion Engine</h4>
                            <p class="mb-0" style="color: rgba(255,255,255,0.9); font-size: 0.9rem;">Multi-pass AI analysis for pixel-perfect code generation</p>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" style="opacity: 0.8;" @onclick="ClosePremiumConversionDialog"></button>
                </div>
                
                <div class="modal-body" style="padding: 28px 32px; max-height: calc(85vh - 180px); overflow-y: auto; background: #fafbfc;">
                    @* Quality Level Selection - Card Style *@
                    <div class="mb-4">
                        <label class="form-label fw-bold d-flex align-items-center gap-2 mb-3" style="color: #1e293b; font-size: 1rem;">
                            <span style="font-size: 1.3rem;">🎯</span> Conversion Quality
                        </label>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="quality-card @(_premiumOptions.Quality == ConversionQuality.Draft ? "selected" : "")" 
                                     style="cursor: pointer; padding: 20px; border-radius: 16px; border: 2px solid @(_premiumOptions.Quality == ConversionQuality.Draft ? "#667eea" : "#e2e8f0"); background: @(_premiumOptions.Quality == ConversionQuality.Draft ? "linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%)" : "white"); transition: all 0.2s ease; height: 100%;"
                                     @onclick='() => _premiumOptions.Quality = ConversionQuality.Draft'>
                                    <div class="text-center">
                                        <div style="font-size: 2rem; margin-bottom: 8px;">⚡</div>
                                        <div class="fw-bold" style="font-size: 1.1rem; color: #1e293b;">Draft</div>
                                        <div class="text-muted" style="font-size: 0.8rem;">Fast, 1 pass</div>
                                        <div class="mt-2" style="font-size: 0.75rem; color: #64748b;">~10 seconds</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="quality-card @(_premiumOptions.Quality == ConversionQuality.Standard ? "selected" : "")" 
                                     style="cursor: pointer; padding: 20px; border-radius: 16px; border: 2px solid @(_premiumOptions.Quality == ConversionQuality.Standard ? "#667eea" : "#e2e8f0"); background: @(_premiumOptions.Quality == ConversionQuality.Standard ? "linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%)" : "white"); transition: all 0.2s ease; height: 100%;"
                                     @onclick='() => _premiumOptions.Quality = ConversionQuality.Standard'>
                                    <div class="text-center">
                                        <div style="font-size: 2rem; margin-bottom: 8px;">✨</div>
                                        <div class="fw-bold" style="font-size: 1.1rem; color: #1e293b;">Standard</div>
                                        <div class="text-muted" style="font-size: 0.8rem;">3 analysis passes</div>
                                        <div class="mt-2" style="font-size: 0.75rem; color: #64748b;">~30 seconds</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="quality-card @(_premiumOptions.Quality == ConversionQuality.Premium ? "selected" : "")" 
                                     style="cursor: pointer; padding: 20px; border-radius: 16px; border: 2px solid @(_premiumOptions.Quality == ConversionQuality.Premium ? "#f59e0b" : "#fde68a"); background: @(_premiumOptions.Quality == ConversionQuality.Premium ? "linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)" : "linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%)"); transition: all 0.2s ease; height: 100%; position: relative;"
                                     @onclick='() => _premiumOptions.Quality = ConversionQuality.Premium'>
                                    <div class="position-absolute" style="top: -8px; right: 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-size: 0.65rem; font-weight: 700; padding: 3px 10px; border-radius: 10px;">BEST</div>
                                    <div class="text-center">
                                        <div style="font-size: 2rem; margin-bottom: 8px;">⭐</div>
                                        <div class="fw-bold" style="font-size: 1.1rem; color: #92400e;">Premium</div>
                                        <div style="font-size: 0.8rem; color: #a16207;">6 passes + refinement</div>
                                        <div class="mt-2" style="font-size: 0.75rem; color: #b45309;">~60 seconds</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted mt-2 d-block" style="font-size: 0.8rem;">Premium includes structure analysis, component detection, design tokens, asset extraction, and iterative refinement.</small>
                    </div>
                    
                    @* Two-column layout for Framework and CSS *@
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold d-flex align-items-center gap-2" style="color: #1e293b;">
                                <span style="font-size: 1.2rem;">🛠️</span> Target Framework
                            </label>
                            <select class="form-select" style="font-size: 0.95rem; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; background-color: white;" @bind="_premiumOptions.Framework">
                                <option value="HTML/CSS">🌐 HTML/CSS — Vanilla web</option>
                                <option value="Tailwind CSS">🎨 Tailwind CSS — Utility-first</option>
                                <option value="React">⚛️ React — Functional component</option>
                                <option value="Vue">💚 Vue.js — Composition API</option>
                                <option value="Blazor Razor">🔷 Blazor Razor — .razor</option>
                                <option value="Razor Pages">📄 Razor Pages — .cshtml</option>
                                <option value="Angular">🅰️ Angular — TypeScript</option>
                                <option value="SwiftUI">🍎 SwiftUI — iOS/macOS</option>
                                <option value="MAUI XAML">📱 .NET MAUI — XAML</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold d-flex align-items-center gap-2" style="color: #1e293b;">
                                <span style="font-size: 1.2rem;">🎨</span> CSS Framework
                            </label>
                            <select class="form-select" style="font-size: 0.95rem; padding: 14px 16px; border: 2px solid #e2e8f0; border-radius: 12px; background-color: white;" @bind="_premiumOptions.CssFramework">
                                <option value="">None — Pure CSS</option>
                                <option value="Bootstrap">Bootstrap 5</option>
                                <option value="Tailwind">Tailwind CSS</option>
                                <option value="Bulma">Bulma</option>
                                <option value="Foundation">Foundation</option>
                            </select>
                        </div>
                    </div>
                    
                    @* Feature Toggles - Compact Grid *@
                    <div class="mb-4">
                        <label class="form-label fw-bold d-flex align-items-center gap-2 mb-3" style="color: #1e293b;">
                            <span style="font-size: 1.2rem;">⚙️</span> Features & Options
                        </label>
                        <div class="row g-2">
                            <div class="col-6 col-lg-4">
                                <label class="feature-toggle d-flex align-items-center gap-2 p-3" style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.15s ease;">
                                    <input class="form-check-input m-0" type="checkbox" @bind="_premiumOptions.GenerateResponsive" style="width: 18px; height: 18px;">
                                    <span style="font-size: 0.85rem;">📱 Responsive</span>
                                </label>
                            </div>
                            <div class="col-6 col-lg-4">
                                <label class="feature-toggle d-flex align-items-center gap-2 p-3" style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.15s ease;">
                                    <input class="form-check-input m-0" type="checkbox" @bind="_premiumOptions.UseDesignTokens" style="width: 18px; height: 18px;">
                                    <span style="font-size: 0.85rem;">🎨 Design Tokens</span>
                                </label>
                            </div>
                            <div class="col-6 col-lg-4">
                                <label class="feature-toggle d-flex align-items-center gap-2 p-3" style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.15s ease;">
                                    <input class="form-check-input m-0" type="checkbox" @bind="_premiumOptions.IncludeAccessibility" style="width: 18px; height: 18px;">
                                    <span style="font-size: 0.85rem;">♿ Accessibility</span>
                                </label>
                            </div>
                            <div class="col-6 col-lg-4">
                                <label class="feature-toggle d-flex align-items-center gap-2 p-3" style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.15s ease;">
                                    <input class="form-check-input m-0" type="checkbox" @bind="_premiumOptions.IncludeInteractiveStates" style="width: 18px; height: 18px;">
                                    <span style="font-size: 0.85rem;">🖱️ Hover States</span>
                                </label>
                            </div>
                            <div class="col-6 col-lg-4">
                                <label class="feature-toggle d-flex align-items-center gap-2 p-3" style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.15s ease;">
                                    <input class="form-check-input m-0" type="checkbox" @bind="_premiumOptions.IncludeAnimations" style="width: 18px; height: 18px;">
                                    <span style="font-size: 0.85rem;">✨ Animations</span>
                                </label>
                            </div>
                            <div class="col-6 col-lg-4">
                                <label class="feature-toggle d-flex align-items-center gap-2 p-3" style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; cursor: pointer; transition: all 0.15s ease;">
                                    <input class="form-check-input m-0" type="checkbox" @bind="_premiumOptions.ExtractAssets" style="width: 18px; height: 18px;">
                                    <span style="font-size: 0.85rem;">🖼️ Extract Assets</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    @* Custom Instructions *@
                    <div class="mb-4">
                        <label class="form-label fw-bold d-flex align-items-center gap-2" style="color: #1e293b;">
                            <span style="font-size: 1.2rem;">💬</span> Custom Instructions <span class="text-muted fw-normal" style="font-size: 0.8rem;">(optional)</span>
                        </label>
                        <textarea class="form-control" rows="2" placeholder="e.g., 'Use flexbox for layout', 'Include dark mode', 'Match brand colors #xxx'..." 
                                  style="border: 2px solid #e2e8f0; border-radius: 12px; resize: none; font-size: 0.9rem; background: white;"
                                  @bind="_premiumOptions.CustomInstructions"></textarea>
                    </div>
                    
                    @* Advanced Options - Inline *@
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <button type="button" class="btn btn-sm btn-link p-0 text-decoration-none" style="color: #6366f1; font-size: 0.85rem;" @onclick="() => _showAdvancedPremiumOptions = !_showAdvancedPremiumOptions">
                            <span class="me-1">@(_showAdvancedPremiumOptions ? "▼" : "▶")</span> Advanced Options
                        </button>
                        @if (_showAdvancedPremiumOptions)
                        {
                            <div class="d-flex align-items-center gap-2">
                                <label class="text-muted" style="font-size: 0.8rem; white-space: nowrap;">Refinement passes:</label>
                                <input type="number" class="form-control form-control-sm" min="0" max="5" @bind="_premiumOptions.MaxRefinementIterations" 
                                       style="width: 60px; border-radius: 8px; font-size: 0.85rem;">
                            </div>
                        }
                    </div>
                    
                    @* What you'll get section - Compact *@
                    <div class="p-3" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border: 1px solid #bae6fd;">
                        <div class="d-flex flex-wrap align-items-center gap-3">
                            <span class="fw-bold" style="color: #0369a1; font-size: 0.85rem;">📦 Output:</span>
                            <span class="badge" style="background: #dcfce7; color: #166534; font-size: 0.75rem;">✓ Code</span>
                            @if (_premiumOptions.UseDesignTokens)
                            {
                                <span class="badge" style="background: #dcfce7; color: #166534; font-size: 0.75rem;">✓ CSS Variables</span>
                            }
                            @if (_premiumOptions.Quality != ConversionQuality.Draft)
                            {
                                <span class="badge" style="background: #dcfce7; color: #166534; font-size: 0.75rem;">✓ Component Tree</span>
                                <span class="badge" style="background: #dcfce7; color: #166534; font-size: 0.75rem;">✓ Design Tokens</span>
                            }
                            @if (_premiumOptions.ExtractAssets && _premiumOptions.Quality == ConversionQuality.Premium)
                            {
                                <span class="badge" style="background: #dcfce7; color: #166534; font-size: 0.75rem;">✓ Assets</span>
                            }
                            <span class="badge" style="background: #dcfce7; color: #166534; font-size: 0.75rem;">✓ Fidelity Score</span>
                        </div>
                    </div>
                </div>
                
                @* Footer *@
                <div class="modal-footer border-0" style="padding: 20px 32px 28px; background: white;">
                    <button type="button" class="btn btn-outline-secondary px-4 py-2" style="border-radius: 12px; font-weight: 600;" @onclick="ClosePremiumConversionDialog">Cancel</button>
                    <button type="button" class="btn px-5 py-2" 
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ec4899 100%); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4); transition: all 0.2s ease;"
                            @onclick="StartPremiumConversion"
                            disabled="@(string.IsNullOrEmpty(_codeImageUrl))">
                        <span class="me-2">⭐</span>
                        Generate with Premium Engine
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    enum AppState { NotSignedIn, SigningIn, SignedIn }
    
    private AppState _state = AppState.NotSignedIn;
    private string _error = "";
    private string _userCode = "";
    private string _verificationUrl = "";
    private string _userName = "";
    private string _message = "";
    private string _response = "";
    private string _chatError = "";
    private bool _sending = false;
    private bool _copied = false;
    
    // Login timeout and cancellation
    private CancellationTokenSource? _loginCancellation;
    private const int LoginTimeoutSeconds = 120; // 2 minutes timeout
    private bool _loginTimedOut = false;
    private int _remainingSeconds = 0;
    private System.Timers.Timer? _countdownTimer;
    private DotNetObjectReference<Home>? _dotNetRef;
    
    // Sign-in progress tracking
    private int _signInStep = 1; // 1=loading config, 2=contacting Azure, 3=generating code
    private int _signInElapsedSeconds = 0;
    private System.Timers.Timer? _signInElapsedTimer;
    
    [JSInvokable]
    public void CancelLoginFromJs()
    {
        InvokeAsync(() =>
        {
            if (_state == AppState.SigningIn)
            {
                Cancel();
                StateHasChanged();
            }
        });
    }
    
    // Tab navigation
    private string _activeTab = "chat";
    
    // Image generation
    private string _imagePrompt = "";
    private string _imageSize = "1024x1024";
    private string _generatedImageUrl = "";
    private string _revisedPrompt = "";
    private string _imageError = "";
    private bool _generatingImage = false;
    
    // Image upload
    private string _uploadedImageUrl = "";
    private string _uploadedImageName = "";
    private byte[]? _uploadedImageBytes = null;
    
    // Image to Code
    private string _codeImageUrl = "";
    private string _codeImageBase64 = "";
    private string _codeImageMimeType = "image/png";
    private string _targetFramework = "HTML/CSS";
    private string _generatedCode = "";
    private string _codeLanguage = "";
    private string _codeError = "";
    private bool _isConvertingToCode = false;
    private bool _codeCopied = false;
    private bool _isDragOver = false;
    
    // Vision Analysis Features
    private string _selectedAnalysis = "code"; // code, codeWithViewModel, extractImages, extractIcons, extractLogos, describe, colors, typography, layout, components, icons, accessibility, comprehensive
    private readonly Dictionary<string, bool> _analysisGroupEnabled = new(StringComparer.OrdinalIgnoreCase)
    {
        {"codeGen", true},
        {"imageExtraction", true},
        {"textOcr", true},
        {"docIntel", true},
        {"customVision", true},
        {"video", true},
        {"design", true},
        {"advanced", true},
        {"imageProcessing", true},
        {"azureVision", true},
        {"chat", true}
    };
    private readonly Dictionary<string, bool> _analysisGroupCollapsed = new(StringComparer.OrdinalIgnoreCase)
    {
        {"codeGen", false},
        {"imageExtraction", false},
        {"textOcr", false},
        {"docIntel", false},
        {"customVision", false},
        {"video", false},
        {"design", false},
        {"advanced", false},
        {"imageProcessing", false},
        {"azureVision", false},
        {"chat", false}
    };
    private readonly List<string> _analysisOrder = new()
    {
        "code","codeWithViewModel","extractImages","extractIcons","extractLogos","extractPhotos","extractAvatars","extractCharts","extractBackgrounds",
        "text","handwriting","table","math","denseCaptions","singleCaption","document","invoice","receipt","idDocument","businessCard","chart",
        "customVisionClassify","customVisionDetect","videoFrames","videoAnalyze","describe","colors","typography","layout","components","icons","smartCrops","tags",
        "accessibility","improvements","compare","compareMultiple","imageDiff","askQuestion","spatialQuestion","comprehensive",
        "removeBackground","upscale","styleTransfer","segment","depthMap","editImage","imageVariations","generateImage",
        "visionAnalyze","visionCaption","visionDenseCaptions","visionTags","visionSmartCrops","visionRead","detectObjects","detectFaces","detectPeople","detectBrands","imageType","adultContent","imageCategory","analyzeComprehensive",
        "chat","customPrompt"
    };
    private const string AnalysisGroupSettingsKey = "AnalysisGroupVisibility";
    private string _analysisResult = "";
    private bool _isAnalyzing = false;
    private string? _processedImageBase64 = null; // For image processing results (background removal, upscale, etc.)
    private ComprehensiveUIAnalysis? _comprehensiveAnalysis = null;
    private ColorPaletteResult? _colorAnalysis = null;
    private TypographyResult? _typographyAnalysis = null;
    private LayoutResult? _layoutAnalysis = null;
    private UIComponentsResult? _componentsAnalysis = null;
    private IconsResult? _iconsAnalysis = null;
    private AccessibilityResult? _accessibilityAnalysis = null;
    private ImageExtractionResult? _extractedImagesResult = null;
    private ImageRegionResult? _imageRegionsResult = null;
    
    // Image Extraction Options
    private string _extractionType = "all"; // all, icons, logos, photos, illustrations, charts, backgrounds, avatars
    private string _extractionSizeFilter = "all"; // all, small, medium, large, custom
    private int _extractionMinSize = 16;
    private int _extractionMaxSize = 1000;
    private bool _extractionAddPadding = true;
    private bool _extractionIncludeCoordinates = true;
    private bool _extractionDetectOnly = false;
    private bool _extractionHighConfidenceOnly = false;
    
    // New Crop Mode Options
    private string _cropMode = "AzureVision"; // AzureVision, SmartUICards, ContourDetection, FloodFillRegions, SmartDetect, Grid, Sections, Components, AIRegions
    private bool _showServiceInfoModal;
    private bool _showServiceSettingsDialog;
    private AzureOpenAISettings _serviceSettings = new();
    private int _gridRows = 2;
    private int _gridColumns = 2;
    private int _minComponentSize = 20;
    private bool _refineWithEdgeDetection = true;
    private int _edgeDetectionThreshold = 30;
    
    // Premium Conversion Engine Options
    private bool _showPremiumConversionDialog;
    private bool _showAdvancedPremiumOptions;
    private PremiumConversionOptions _premiumOptions = new()
    {
        Framework = "HTML/CSS",
        Quality = ConversionQuality.Premium,
        GenerateResponsive = true,
        UseDesignTokens = true,
        IncludeAccessibility = true,
        IncludeInteractiveStates = true,
        IncludeAnimations = true,
        ExtractAssets = true,
        MaxRefinementIterations = 2
    };
    private PremiumConversionResult? _premiumConversionResult;
    private string _premiumConversionProgress = "";
    private int _premiumConversionProgressPercent;
    
    // ViewModel Generation with OCR
    private string _viewModelTab = "extracted"; // extracted, viewmodel, razor, preview
    private string _extractedTextJson = "";
    private string _generatedViewModel = "";
    private string _generatedRazorWithParams = "";
    private string _viewModelPreviewHtml = "";

    // Code Preview Mode
    private string _codeViewMode = "code"; // code, preview, split
    
    // Dynamic Razor Preview (for popup/download features)
    private string _razorPreviewHtml = "";
    private RenderResult? _lastRazorRenderResult;
    
    // HTML Preview content for srcdoc binding
        private string _htmlPreviewContent = "<html><body style='font-family:sans-serif;padding:20px;color:#888;text-align:center;'><h2>👁️ Preview Area</h2><p>Generate HTML or Tailwind CSS code to see preview</p></body></html>";

        private bool IsGroupCollapsed(string key) => _analysisGroupCollapsed.TryGetValue(key, out var collapsed) ? collapsed : false;

        private void ToggleGroupCollapse(string key)
        {
            _analysisGroupCollapsed[key] = IsGroupCollapsed(key) == false;
            StateHasChanged();
        }

        private bool IsGroupEnabled(string key) => _analysisGroupEnabled.TryGetValue(key, out var enabled) ? enabled : true;

        private bool IsGroupHealthy(string key) => key switch
        {
            "azureVision" => AzureVision?.IsConfigured == true || (!string.IsNullOrEmpty(_serviceSettings.VisionEndpoint) && !string.IsNullOrEmpty(_serviceSettings.VisionKey)),
            "docIntel" => !string.IsNullOrEmpty(_serviceSettings.DocumentIntelligenceEndpoint) && !string.IsNullOrEmpty(_serviceSettings.DocumentIntelligenceKey),
            "customVision" => !string.IsNullOrEmpty(_serviceSettings.CustomVisionEndpoint) && !string.IsNullOrEmpty(_serviceSettings.CustomVisionKey),
            _ => true
        };

        private (string icon, string title) GetServiceStatus(string key)
        {
            var healthy = IsGroupHealthy(key);
            return healthy
                ? ("🟢", "Service connected")
                : ("⚪️", "Service not configured or unreachable");
        }

        private string GetGroupKeyForAnalysis(string analysis) => analysis switch
        {
            "code" or "codeWithViewModel" => "codeGen",
            "extractImages" or "extractIcons" or "extractLogos" or "extractPhotos" or "extractAvatars" or "extractCharts" or "extractBackgrounds" => "imageExtraction",
            "text" or "handwriting" or "table" or "math" or "denseCaptions" or "singleCaption" => "textOcr",
            "document" or "invoice" or "receipt" or "idDocument" or "businessCard" or "chart" => "docIntel",
            "customVisionClassify" or "customVisionDetect" => "customVision",
            "videoFrames" or "videoAnalyze" => "video",
            "describe" or "colors" or "typography" or "layout" or "components" or "icons" or "smartCrops" or "tags" => "design",
            "accessibility" or "improvements" or "compare" or "compareMultiple" or "imageDiff" or "askQuestion" or "spatialQuestion" or "comprehensive" => "advanced",
            "removeBackground" or "upscale" or "styleTransfer" or "segment" or "depthMap" or "editImage" or "imageVariations" or "generateImage" => "imageProcessing",
            "visionAnalyze" or "visionCaption" or "visionDenseCaptions" or "visionTags" or "visionSmartCrops" or "visionRead" or "detectObjects" or "detectFaces" or "detectPeople" or "detectBrands" or "imageType" or "adultContent" or "imageCategory" or "analyzeComprehensive" => "azureVision",
            "chat" or "customPrompt" => "chat",
            _ => "advanced"
        };

        private string? GetFirstEnabledAnalysis()
        {
            foreach (var key in _analysisOrder)
            {
                if (IsGroupEnabled(GetGroupKeyForAnalysis(key)))
                    return key;
            }
            return null;
        }

        private async Task LoadGroupSettingsAsync()
        {
            try
            {
                var saved = await JS.InvokeAsync<string>("localStorage.getItem", AnalysisGroupSettingsKey);
                if (!string.IsNullOrEmpty(saved))
                {
                    var loaded = JsonSerializer.Deserialize<Dictionary<string, bool>>(saved);
                    if (loaded != null)
                    {
                        foreach (var kvp in loaded)
                        {
                            _analysisGroupEnabled[kvp.Key] = kvp.Value;
                        }
                    }
                }
            }
            catch { /* ignore persistence failures */ }
        }

        private async Task SaveGroupSettingsAsync()
        {
            try
            {
                var json = JsonSerializer.Serialize(_analysisGroupEnabled);
                await JS.InvokeVoidAsync("localStorage.setItem", AnalysisGroupSettingsKey, json);
            }
            catch { /* ignore persistence failures */ }
        }

        private async Task ToggleGroup(string key, object? value)
        {
            if (!bool.TryParse(Convert.ToString(value), out var enabled))
            {
                enabled = true;
            }

            _analysisGroupEnabled[key] = enabled;

            if (!enabled && GetGroupKeyForAnalysis(_selectedAnalysis) == key)
            {
                _selectedAnalysis = GetFirstEnabledAnalysis() ?? _selectedAnalysis;
            }

            await SaveGroupSettingsAsync();
            StateHasChanged();
        }

        private void SelectAnalysis(string value)
        {
            var group = GetGroupKeyForAnalysis(value);
            if (!IsGroupEnabled(group))
            {
                // Pick first enabled analysis if target group is disabled
                _selectedAnalysis = GetFirstEnabledAnalysis() ?? _selectedAnalysis;
                return;
            }

            _selectedAnalysis = value;
        }
     
         private async Task StartSignIn()
         {
             _error = "";
             _state = AppState.SigningIn;
        _userCode = "";
        _verificationUrl = "";
        _copied = false;
        _loginTimedOut = false;
        _remainingSeconds = LoginTimeoutSeconds;
        
        // Reset sign-in progress
        _signInStep = 1;
        _signInElapsedSeconds = 0;
        
        // Start elapsed time timer for the loading state
        _signInElapsedTimer?.Stop();
        _signInElapsedTimer?.Dispose();
        _signInElapsedTimer = new System.Timers.Timer(1000);
        _signInElapsedTimer.Elapsed += async (s, e) =>
        {
            _signInElapsedSeconds++;
            await InvokeAsync(StateHasChanged);
        };
        _signInElapsedTimer.Start();
        
        // Setup escape key handler
        _dotNetRef?.Dispose();
        _dotNetRef = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("setupLoginEscapeHandler", _dotNetRef);
        
        // Create cancellation token for timeout
        _loginCancellation?.Cancel();
        _loginCancellation?.Dispose();
        _loginCancellation = new CancellationTokenSource();
        
        // Start countdown timer
        _countdownTimer?.Stop();
        _countdownTimer?.Dispose();
        _countdownTimer = new System.Timers.Timer(1000);
        _countdownTimer.Elapsed += async (s, e) =>
        {
            _remainingSeconds--;
            if (_remainingSeconds <= 0)
            {
                _countdownTimer?.Stop();
                _loginCancellation?.Cancel();
            }
            await InvokeAsync(StateHasChanged);
        };
        _countdownTimer.Start();
        
        StateHasChanged();
        
        try
        {
            // Step 2: Contacting Azure AD
            _signInStep = 2;
            StateHasChanged();
            
            var authTask = AzureOpenAI.GetAuthenticationStatusAsync();
            
            // Poll for the device code with cancellation check
            for (int i = 0; i < 100 && string.IsNullOrEmpty(AzureOpenAI.UserCode); i++)
            {
                if (_loginCancellation?.Token.IsCancellationRequested == true)
                {
                    throw new OperationCanceledException("Login was cancelled or timed out");
                }
                await Task.Delay(100);
                
                // Update to step 3 after a couple seconds
                if (i == 20)
                {
                    _signInStep = 3;
                    StateHasChanged();
                }
            }
            
            // Stop elapsed timer once we have the code
            _signInElapsedTimer?.Stop();
            _signInElapsedTimer?.Dispose();
            _signInElapsedTimer = null;
            
            if (!string.IsNullOrEmpty(AzureOpenAI.UserCode))
            {
                _userCode = AzureOpenAI.UserCode;
                _verificationUrl = AzureOpenAI.VerificationUrl ?? "https://microsoft.com/devicelogin";
                StateHasChanged();
                
                // Copy to clipboard only - user must click button to open browser
                await Task.Delay(300);
                await CopyToClipboard(_userCode);
            }
            
            // Wait for auth with timeout
            var timeoutTask = Task.Delay(TimeSpan.FromSeconds(LoginTimeoutSeconds), _loginCancellation!.Token);
            var completedTask = await Task.WhenAny(authTask, timeoutTask);
            
            if (completedTask == timeoutTask || _loginCancellation.Token.IsCancellationRequested)
            {
                _loginTimedOut = true;
                _error = "Login timed out. Please try again or check your settings.";
                _state = AppState.NotSignedIn;
                AzureOpenAI.SignOut();
            }
            else
            {
                var status = await authTask;
                
                if (status.IsAuthenticated)
                {
                    _userName = status.UserName ?? "User";
                    _state = AppState.SignedIn;
                }
                else
                {
                    _error = status.ErrorMessage ?? "Sign in failed";
                    _state = AppState.NotSignedIn;
                }
            }
        }
        catch (OperationCanceledException)
        {
            _loginTimedOut = true;
            _error = "Login was cancelled or timed out. Please try again.";
            _state = AppState.NotSignedIn;
            AzureOpenAI.SignOut();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            _state = AppState.NotSignedIn;
        }
        finally
        {
            _countdownTimer?.Stop();
            _countdownTimer?.Dispose();
            _countdownTimer = null;
            
            _signInElapsedTimer?.Stop();
            _signInElapsedTimer?.Dispose();
            _signInElapsedTimer = null;
            
            // Cleanup escape handler
            try
            {
                await JS.InvokeVoidAsync("removeLoginEscapeHandler");
                _dotNetRef?.Dispose();
                _dotNetRef = null;
            }
            catch { /* Ignore JS errors during cleanup */ }
        }
        
        StateHasChanged();
    }
    
    private async Task CopyToClipboard(string text)
    {
        if (string.IsNullOrEmpty(text)) return;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            _copied = true;
            StateHasChanged();
        }
        catch
        {
            try
            {
                var escapedText = JsonSerializer.Serialize(text);
                await JS.InvokeVoidAsync("eval", $@"
                    (function() {{
                        var textArea = document.createElement('textarea');
                        textArea.value = {escapedText};
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                    }})();
                ");
                _copied = true;
            }
            catch
            {
                _copied = false;
            }
            StateHasChanged();
        }
    }
    
    private async Task CopyCodeManual()
    {
        await CopyToClipboard(_userCode);
    }
    
    private async Task OpenLoginPopup()
    {
        try
        {
            // Use the IUrlLauncher service which creates a proper popup with the device code
            await UrlLauncher.OpenUrlAsync(_verificationUrl, _userCode);
        }
        catch (Exception ex)
        {
            _error = $"Failed to open login window: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private string GetLoginUrl()
    {
        if (string.IsNullOrEmpty(_verificationUrl)) return "#";
        return _verificationUrl;
    }
    
    private async Task CancelAsync()
    {
        // Remove escape key handler
        await JS.InvokeVoidAsync("removeLoginEscapeHandler");
        _dotNetRef?.Dispose();
        _dotNetRef = null;
        
        // Cancel ongoing login
        _loginCancellation?.Cancel();
        _loginCancellation?.Dispose();
        _loginCancellation = null;
        
        // Stop countdown timer
        _countdownTimer?.Stop();
        _countdownTimer?.Dispose();
        _countdownTimer = null;
        
        AzureOpenAI.SignOut();
        _state = AppState.NotSignedIn;
        _userCode = "";
        _verificationUrl = "";
        _loginTimedOut = false;
        _remainingSeconds = 0;
    }
    
    private void Cancel()
    {
        _ = CancelAsync();
    }
    
    private void SignOut()
    {
        AzureOpenAI.SignOut();
        _userName = "";
        _message = "";
        _response = "";
        _imagePrompt = "";
        _generatedImageUrl = "";
        _revisedPrompt = "";
        _imageError = "";
        _codeImageUrl = "";
        _generatedCode = "";
        _codeError = "";
        _activeTab = "chat";
        _state = AppState.NotSignedIn;
    }
    
    // Tab switching is handled by TabToolbar via @bind-ActiveTab.
    
    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_message)) return;
        
        _sending = true;
        _response = "";
        _chatError = "";
        StateHasChanged();
        
        try
        {
            _response = await AzureOpenAI.GetChatCompletionAsync(_message, "You are a helpful assistant. Be concise.");
        }
        catch (Exception ex)
        {
            _chatError = ex.Message;
        }
        
        _sending = false;
        StateHasChanged();
    }
    
    private async Task GenerateImage()
    {
        if (string.IsNullOrWhiteSpace(_imagePrompt)) return;
        
        _generatingImage = true;
        _generatedImageUrl = "";
        _revisedPrompt = "";
        _imageError = "";
        StateHasChanged();
        
        try
        {
            var result = await AzureOpenAI.GenerateImageAsync(_imagePrompt, _imageSize);
            
            if (result.Success)
            {
                _generatedImageUrl = result.ImageUrl ?? "";
                _revisedPrompt = result.RevisedPrompt ?? "";
            }
            else
            {
                _imageError = result.ErrorMessage ?? "Image generation failed";
            }
        }
        catch (Exception ex)
        {
            _imageError = ex.Message;
        }
        
        _generatingImage = false;
        StateHasChanged();
    }
    
    private async Task DownloadImage()
    {
        if (string.IsNullOrEmpty(_generatedImageUrl)) return;
        
        try
        {
            var fileName = $"generated-image-{DateTime.Now:yyyyMMdd-HHmmss}.png";
            var escapedUrl = JsonSerializer.Serialize(_generatedImageUrl);
            
            await JS.InvokeVoidAsync("eval", $@"
                (async function() {{
                    var imageUrl = {escapedUrl};
                    var fileName = '{fileName}';
                    
                    try {{
                        if (imageUrl.startsWith('data:')) {{
                            var link = document.createElement('a');
                            link.href = imageUrl;
                            link.download = fileName;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }} else {{
                            var response = await fetch(imageUrl);
                            var blob = await response.blob();
                            var url = URL.createObjectURL(blob);
                            var link = document.createElement('a');
                            link.href = url;
                            link.download = fileName;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }}
                    }} catch (e) {{
                        window.open(imageUrl, '_blank');
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            _imageError = $"Download failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task DownloadExtractedImage(ExtractedImage img)
    {
        if (string.IsNullOrEmpty(img.Base64Data)) return;
        
        try
        {
            var fileName = !string.IsNullOrEmpty(img.SuggestedFilename) 
                ? img.SuggestedFilename 
                : $"extracted-{img.ImageType ?? "image"}-{DateTime.Now:yyyyMMdd-HHmmss}.png";
            
            var dataUrl = $"data:image/png;base64,{img.Base64Data}";
            var escapedDataUrl = JsonSerializer.Serialize(dataUrl);
            
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    var link = document.createElement('a');
                    link.href = {escapedDataUrl};
                    link.download = '{fileName}';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }})();
            ");
        }
        catch (Exception ex)
        {
            _codeError = $"Download failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task DownloadAllExtractedImages()
    {
        if (_extractedImagesResult?.Images == null || !_extractedImagesResult.Images.Any()) return;
        
        try
        {
            var timestamp = DateTime.Now.ToString("yyyyMMdd-HHmmss");
            var index = 0;
            
            foreach (var img in _extractedImagesResult.Images.Where(i => !string.IsNullOrEmpty(i.Base64Data)))
            {
                index++;
                var fileName = !string.IsNullOrEmpty(img.SuggestedFilename) 
                    ? img.SuggestedFilename 
                    : $"extracted-{img.ImageType ?? "image"}-{index:D3}.png";
                
                var dataUrl = $"data:image/png;base64,{img.Base64Data}";
                var escapedDataUrl = JsonSerializer.Serialize(dataUrl);
                
                await JS.InvokeVoidAsync("eval", $@"
                    (function() {{
                        var link = document.createElement('a');
                        link.href = {escapedDataUrl};
                        link.download = '{fileName}';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }})();
                ");
                
                // Small delay between downloads to prevent browser blocking
                await Task.Delay(200);
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Download failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task TriggerFileUpload()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('imageUpload').click()");
    }
    

    private async Task HandleFileUploadNew(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file != null)
            {
                // Read file into memory (max 10MB)
                var maxSize = 10 * 1024 * 1024;
                using var stream = file.OpenReadStream(maxSize);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var bytes = ms.ToArray();
                
                // Convert to base64 data URL
                var base64 = Convert.ToBase64String(bytes);
                var mimeType = file.ContentType;
                _uploadedImageUrl = $"data:{mimeType};base64,{base64}";
                _uploadedImageName = file.Name;
                _uploadedImageBytes = bytes;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _imageError = $"Upload failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private void ClearUploadedImage()
    {
        _uploadedImageUrl = "";
        _uploadedImageName = "";
        _uploadedImageBytes = null;
        StateHasChanged();
    }
    
    private void ClearGeneratedImage()
    {
        _generatedImageUrl = "";
        _revisedPrompt = "";
        _imageError = "";
        StateHasChanged();
    }
    
    // Image to Code Methods
    private async Task TriggerCodeImageUpload()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('codeImageUpload').click()");
    }
     
    private async Task HandleCodeImageUploadNew(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file != null)
            {
                // Read file into memory (max 20MB)
                var maxSize = 20 * 1024 * 1024;
                using var stream = file.OpenReadStream(maxSize);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var bytes = ms.ToArray();

                // Convert to base64 data URL
                var base64 = Convert.ToBase64String(bytes);
                var mimeType = file.ContentType ?? "image/png";
                _codeImageUrl = $"data:{mimeType};base64,{base64}";
                _codeImageBase64 = base64;
                _codeImageMimeType = mimeType;
                _codeError = "";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Upload failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private void ClearCodeImage()
    {
        _codeImageUrl = "";
        _codeImageBase64 = "";
        _generatedCode = "";
        _codeError = "";
        _codeCopied = false;
        StateHasChanged();
    }
    
    #region Drag and Drop Handlers
    
    private void HandleDragEnter(DragEventArgs e)
    {
        _isDragOver = true;
        StateHasChanged();
    }
    
    private void HandleDragLeave(DragEventArgs e)
    {
        _isDragOver = false;
        StateHasChanged();
    }
    
    private void HandleDragOver(DragEventArgs e)
    {
        _isDragOver = true;
    }
    
    private async Task HandleDrop(DragEventArgs e)
    {
        _isDragOver = false;
        StateHasChanged();
        
        try
        {
            // Use JavaScript to read the dropped file and return base64
            var result = await JS.InvokeAsync<DropResult>("readDroppedFile");
            if (result != null && !string.IsNullOrEmpty(result.Base64))
            {
                _codeImageBase64 = result.Base64;
                _codeImageMimeType = result.MimeType ?? "image/png";
                _codeImageUrl = $"data:{_codeImageMimeType};base64,{_codeImageBase64}";
                _codeError = "";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Drop failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private class DropResult
    {
        public string? Base64 { get; set; }
        public string? MimeType { get; set; }
        public string? FileName { get; set; }
    }
    
    #endregion
    
    private async Task ConvertImageToCode()
    {
        if (string.IsNullOrEmpty(_codeImageBase64)) return;
        
        _isConvertingToCode = true;
        _generatedCode = "";
        _codeError = "";
        _codeCopied = false;
        StateHasChanged();
        
        try
        {
            // Use ImageToCodeService which uses gpt-4o vision model
            var result = await ImageToCode.GenerateCodeFromBase64Async(
                _codeImageBase64, 
                _codeImageMimeType, 
                _targetFramework
            );
            
            if (result.Success)
            {
                _generatedCode = result.Code ?? "";
                _codeLanguage = result.Language ?? GetLanguageHint(_targetFramework);
                
                // Auto-switch to split view for previewable frameworks
                if (CanShowPreview())
                {
                    _codeViewMode = "split";
                }
            }
            else
            {
                _codeError = $"Conversion failed: {result.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Conversion failed: {ex.Message}";
        }
        
        _isConvertingToCode = false;
        StateHasChanged();
        
        // Load preview if HTML-based framework or Razor framework
        if (!string.IsNullOrEmpty(_generatedCode) && CanShowPreview())
        {
            if (IsHtmlFramework())
            {
                await LoadPreviewIframeAsync();
            }
            else if (IsRazorFramework())
            {
                await LoadRazorPreviewAsync();
            }
        }
    }
    
    private async Task RunAnalysis()
    {
        if (string.IsNullOrEmpty(_codeImageBase64)) return;
        
        // If code generation is selected, use existing method
        if (_selectedAnalysis == "code")
        {
            await ConvertImageToCode();
            return;
        }
        
        // If code with ViewModel is selected, use special method
        if (_selectedAnalysis == "codeWithViewModel")
        {
            await GenerateCodeWithViewModel();
            return;
        }
        
        _isAnalyzing = true;
        _analysisResult = "";
        _codeError = "";
        ClearAnalysisResults();
        StateHasChanged();
        
        try
        {
            switch (_selectedAnalysis)
            {
                case "extractImages":
                    await RunImageExtractionAsync();
                    break;

                case "describe":
                    var descResult = await VisionService.DescribeImageAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = descResult.Success ? descResult.Content ?? "" : $"Error: {descResult.ErrorMessage}";
                    break;

                case "colors":
                    _colorAnalysis = await VisionService.ExtractColorPaletteAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_colorAnalysis.Success) _codeError = _colorAnalysis.ErrorMessage ?? "Failed to extract colors";
                    break;

                case "typography":
                    _typographyAnalysis = await VisionService.ExtractTypographyAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_typographyAnalysis.Success) _codeError = _typographyAnalysis.ErrorMessage ?? "Failed to extract typography";
                    break;

                case "layout":
                    _layoutAnalysis = await VisionService.ExtractLayoutAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_layoutAnalysis.Success) _codeError = _layoutAnalysis.ErrorMessage ?? "Failed to analyze layout";
                    break;

                case "components":
                    _componentsAnalysis = await VisionService.ExtractUIComponentsAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_componentsAnalysis.Success) _codeError = _componentsAnalysis.ErrorMessage ?? "Failed to extract components";
                    break;

                case "icons":
                    _iconsAnalysis = await VisionService.IdentifyIconsAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_iconsAnalysis.Success) _codeError = _iconsAnalysis.ErrorMessage ?? "Failed to identify icons";
                    break;

                case "accessibility":
                    _accessibilityAnalysis = await VisionService.AnalyzeAccessibilityAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_accessibilityAnalysis.Success) _codeError = _accessibilityAnalysis.ErrorMessage ?? "Failed to analyze accessibility";
                    break;

                case "improvements":
                    var impResult = await VisionService.SuggestImprovementsAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = impResult.Success ? impResult.Content ?? "" : $"Error: {impResult.ErrorMessage}";
                    break;

                case "text":
                    var textResult = await VisionService.ExtractTextAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = textResult.Success ? textResult.Content ?? "" : $"Error: {textResult.ErrorMessage}";
                    break;

                case "comprehensive":
                    _comprehensiveAnalysis = await VisionService.AnalyzeUIAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_comprehensiveAnalysis.Success) _codeError = _comprehensiveAnalysis.ErrorMessage ?? "Failed to perform comprehensive analysis";
                    break;

                // ===== NEW ANALYSIS TYPES =====

                // Azure Vision 4.0 - Caption, Dense Captions, Tags, Smart Crops, OCR
                 case "visionCaption":
                     if (AzureVision != null && AzureVision.IsConfigured)
                     {
                         var captionResult = await AzureVision.GetImageCaptionAsync(Convert.FromBase64String(_codeImageBase64));
                         _analysisResult = captionResult.Success
                             ? $"Caption: {captionResult.Caption}\nConfidence: {captionResult.Confidence:P0}"
                             : $"Error: {captionResult.ErrorMessage}";
                     }
                     else
                     {
                         _codeError = "Azure Vision service not configured";
                     }
                     break;

                 case "visionAnalyze":
                     if (AzureVision != null && AzureVision.IsConfigured)
                     {
                         var analyzeResult = await AzureVision.AnalyzeImageAsync(Convert.FromBase64String(_codeImageBase64));
                         _analysisResult = analyzeResult.Success
                             ? FormatObjectDetectionResult(analyzeResult)
                             : $"Error: {analyzeResult.ErrorMessage}";
                     }
                     else
                     {
                         _codeError = "Azure Vision service not configured";
                     }
                     break;

                case "visionDenseCaptions":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var denseResult = await AzureVision.GetDenseCaptionsAsync(Convert.FromBase64String(_codeImageBase64));
                        if (denseResult.Success && denseResult.Regions != null)
                        {
                            var sbDense = new StringBuilder();
                            sbDense.AppendLine($"Dense captions: {denseResult.Regions.Count}");
                            foreach (var r in denseResult.Regions)
                            {
                                sbDense.AppendLine($"• {r.Caption} ({r.Confidence:P0}) at [{r.X},{r.Y}] {r.Width}×{r.Height}");
                            }
                            _analysisResult = sbDense.ToString();
                        }
                        else
                        {
                            _analysisResult = $"Error: {denseResult.ErrorMessage ?? "No regions returned"}";
                        }
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                case "visionTags":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var tagsResult = await AzureVision.GetImageTagsAsync(Convert.FromBase64String(_codeImageBase64));
                        if (tagsResult.Success && tagsResult.Tags != null)
                        {
                            _analysisResult = "Tags:\n" + string.Join("\n", tagsResult.Tags.Select(t => $"• {t.Name} ({t.Confidence:P0})"));
                        }
                        else
                        {
                            _analysisResult = $"Error: {tagsResult.ErrorMessage ?? "No tags returned"}";
                        }
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                case "visionSmartCrops":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var cropsResult = await AzureVision.GetSmartCropsAsync(Convert.FromBase64String(_codeImageBase64), 1.0, 1.6);
                        if (cropsResult.Success && cropsResult.Crops != null)
                        {
                            var sbCrops = new StringBuilder();
                            sbCrops.AppendLine($"Smart crops: {cropsResult.Crops.Count}");
                            foreach (var c in cropsResult.Crops)
                            {
                                sbCrops.AppendLine($"• [{c.X},{c.Y}] {c.Width}×{c.Height} (AR {c.AspectRatio:F2})");
                            }
                            _analysisResult = sbCrops.ToString();
                        }
                        else
                        {
                            _analysisResult = $"Error: {cropsResult.ErrorMessage ?? "No crops returned"}";
                        }
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                case "visionRead":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var readResult = await AzureVision.DetectTextAsync(Convert.FromBase64String(_codeImageBase64));
                        if (readResult.Success)
                        {
                            _analysisResult = !string.IsNullOrEmpty(readResult.FullText)
                                ? readResult.FullText!
                                : (readResult.TextRegions != null
                                    ? string.Join("\n", readResult.TextRegions.Select(t => $"[{t.X},{t.Y}] {t.Width}×{t.Height}: {t.Text}"))
                                    : "No text found");
                        }
                        else
                        {
                            _analysisResult = $"Error: {readResult.ErrorMessage}";
                        }
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                // Text & OCR
                case "handwriting":
                    var handwritingResult = await VisionService.ReadHandwritingAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = handwritingResult.Success ? $"Handwriting Text:\n{handwritingResult.RecognizedText}\n\nConfidence: {handwritingResult.Confidence:P0}" : $"Error: {handwritingResult.ErrorMessage}";
                    break;

                case "table":
                    var tableResult = await VisionService.ExtractTableAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = tableResult.Success ? FormatTableResult(tableResult) : $"Error: {tableResult.ErrorMessage}";
                    break;

                case "math":
                    var mathResult = await VisionService.ParseMathEquationAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = mathResult.Success ? $"LaTeX: {mathResult.Latex}\n\nPlain Text: {mathResult.PlainText}" : $"Error: {mathResult.ErrorMessage}";
                    break;

                // Document Analysis
                case "document":
                    var docResult = await VisionService.ParseDocumentAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = docResult.Success ? $"Document Type: {docResult.DocumentType}\n\nFields:\n{FormatDocumentFields(docResult)}" : $"Error: {docResult.ErrorMessage}";
                    break;

                case "invoice":
                    if (AdvancedAI != null)
                    {
                        var invoiceResult = await AdvancedAI.AnalyzeInvoiceAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = invoiceResult.Success ? FormatInvoiceResult(invoiceResult) : $"Error: {invoiceResult.ErrorMessage}";
                    }
                    else
                    {
                        _analysisResult = "Document Intelligence service not configured";
                    }
                    break;

                case "receipt":
                    if (AdvancedAI != null)
                    {
                        var receiptResult = await AdvancedAI.AnalyzeReceiptAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = receiptResult.Success ? FormatReceiptResult(receiptResult) : $"Error: {receiptResult.ErrorMessage}";
                    }
                    else
                    {
                        _analysisResult = "Document Intelligence service not configured";
                    }
                    break;

                case "chart":
                    var chartResult = await VisionService.ExtractChartDataAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = chartResult.Success ? FormatChartResult(chartResult) : $"Error: {chartResult.ErrorMessage}";
                    break;

                case "customVisionClassify":
                    if (AdvancedAI != null)
                    {
                        var classifyResult = await AdvancedAI.ClassifyImageAsync(Convert.FromBase64String(_codeImageBase64));
                        if (classifyResult.Success && classifyResult.Predictions != null)
                        {
                            _analysisResult = "Custom Vision — Classification:\n" + string.Join("\n", classifyResult.Predictions.Select(p => $"• {p.TagName} ({p.Probability:P0})"));
                        }
                        else
                        {
                            _analysisResult = $"Error: {classifyResult.ErrorMessage ?? "No predictions returned"}";
                        }
                    }
                    else
                    {
                        _analysisResult = "Custom Vision not configured";
                    }
                    break;

                case "customVisionDetect":
                    if (AdvancedAI != null)
                    {
                        var detectResult = await AdvancedAI.DetectObjectsCustomAsync(Convert.FromBase64String(_codeImageBase64));
                        if (detectResult.Success && detectResult.Detections != null)
                        {
                            var sbDetect = new StringBuilder();
                            sbDetect.AppendLine($"Custom Vision — Detected {detectResult.Detections.Count} objects:");
                            foreach (var d in detectResult.Detections)
                            {
                                sbDetect.AppendLine($"• {d.TagName} ({d.Probability:P0}) at [{d.X},{d.Y}] {d.Width}×{d.Height}");
                            }
                            _analysisResult = sbDetect.ToString();
                        }
                        else
                        {
                            _analysisResult = $"Error: {detectResult.ErrorMessage ?? "No detections returned"}";
                        }
                    }
                    else
                    {
                        _analysisResult = "Custom Vision not configured";
                    }
                    break;

                case "videoFrames":
                    if (!IsVideoUpload())
                    {
                        _codeError = "Upload a video (e.g., MP4/MOV) to extract frames.";
                        break;
                    }
                    if (AdvancedAI != null)
                    {
                        var framesResult = await AdvancedAI.ExtractVideoFramesAsync(Convert.FromBase64String(_codeImageBase64), 1);
                        if (framesResult.Success)
                        {
                            var previewFrame = framesResult.Frames?.FirstOrDefault()?.Base64Image;
                            _processedImageBase64 = previewFrame ?? _processedImageBase64;
                            _analysisResult = $"Extracted {framesResult.TotalFrames} frames over {framesResult.DurationSeconds:F1}s (interval 1s).";
                        }
                        else
                        {
                            _analysisResult = $"Error: {framesResult.ErrorMessage}";
                        }
                    }
                    else
                    {
                        _analysisResult = "Video Indexer not configured";
                    }
                    break;

                case "videoAnalyze":
                    if (!IsVideoUpload())
                    {
                        _codeError = "Upload a video (e.g., MP4/MOV) to analyze.";
                        break;
                    }
                    if (AdvancedAI != null)
                    {
                        var videoResult = await AdvancedAI.AnalyzeVideoAsync(Convert.FromBase64String(_codeImageBase64));
                        if (videoResult.Success)
                        {
                            var sbVideo = new StringBuilder();
                            sbVideo.AppendLine($"Duration: {videoResult.DurationSeconds:F1}s");
                            if (videoResult.Labels?.Any() == true)
                                sbVideo.AppendLine("Labels: " + string.Join(", ", videoResult.Labels.Select(l => $"{l.Name} ({l.Confidence:P0})")));
                            if (videoResult.Faces?.Any() == true)
                                sbVideo.AppendLine($"Faces: {videoResult.Faces.Count}");
                            if (!string.IsNullOrEmpty(videoResult.Transcript))
                            {
                                var transcript = videoResult.Transcript.Length > 500 ? videoResult.Transcript[..500] + "..." : videoResult.Transcript;
                                sbVideo.AppendLine("Transcript (excerpt): " + transcript);
                            }
                            _analysisResult = sbVideo.ToString();
                        }
                        else
                        {
                            _analysisResult = $"Error: {videoResult.ErrorMessage}";
                        }
                    }
                    else
                    {
                        _analysisResult = "Video Indexer not configured";
                    }
                    break;

                // Advanced Analysis
                case "compare":
                    _analysisResult = "Please use the Compare Images feature with two images loaded.";
                    break;

                case "askQuestion":
                    _analysisResult = "Enter your question about the image in the prompt field and click Analyze.";
                    break;

                // Image Processing (Azure Vision)
                case "removeBackground":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var bgResult = await AzureVision.RemoveBackgroundAsync(Convert.FromBase64String(_codeImageBase64));
                        if (bgResult.Success && bgResult.Base64Image != null)
                        {
                            _analysisResult = "Background removed successfully!";
                            _processedImageBase64 = bgResult.Base64Image;
                        }
                        else
                        {
                            _codeError = bgResult.ErrorMessage ?? "Failed to remove background";
                        }
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                case "upscale":
                    if (AdvancedAI != null)
                    {
                        var upscaleResult = await AdvancedAI.UpscaleImageAsync(Convert.FromBase64String(_codeImageBase64), 2);
                        if (upscaleResult.Success && upscaleResult.Base64Image != null)
                        {
                            _analysisResult = $"Image upscaled from {upscaleResult.OriginalWidth}x{upscaleResult.OriginalHeight} to {upscaleResult.NewWidth}x{upscaleResult.NewHeight}";
                            _processedImageBase64 = upscaleResult.Base64Image;
                        }
                        else
                        {
                            _codeError = upscaleResult.ErrorMessage ?? "Failed to upscale image";
                        }
                    }
                    break;

                case "styleTransfer":
                    if (AdvancedAI != null)
                    {
                        var styleResult = await AdvancedAI.ApplyStyleTransferAsync(Convert.FromBase64String(_codeImageBase64), "sepia");
                        if (styleResult.Success && styleResult.Base64Image != null)
                        {
                            _analysisResult = $"Style '{styleResult.AppliedStyle}' applied successfully!";
                            _processedImageBase64 = styleResult.Base64Image;
                        }
                        else
                        {
                            _codeError = styleResult.ErrorMessage ?? "Failed to apply style";
                        }
                    }
                    break;

                case "segment":
                    if (AdvancedAI != null)
                    {
                        var segmentResult = await AdvancedAI.SegmentImageAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = segmentResult.Success ? $"Found {segmentResult.Segments?.Count ?? 0} segments" : $"Error: {segmentResult.ErrorMessage}";
                    }
                    break;

                case "depthMap":
                    if (AdvancedAI != null)
                    {
                        var depthResult = await AdvancedAI.EstimateDepthAsync(Convert.FromBase64String(_codeImageBase64));
                        if (depthResult.Success && depthResult.Base64DepthMap != null)
                        {
                            _analysisResult = depthResult.Description ?? "Depth map generated";
                            _processedImageBase64 = depthResult.Base64DepthMap;
                        }
                        else
                        {
                            _codeError = depthResult.ErrorMessage ?? "Failed to estimate depth";
                        }
                    }
                    break;

                // Detection (Azure Vision)
                case "detectObjects":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var objResult = await AzureVision.DetectObjectsAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = objResult.Success ? FormatObjectDetectionResult(objResult) : $"Error: {objResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                case "detectFaces":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var faceResult = await AzureVision.DetectFacesAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = faceResult.Success ? FormatFaceDetectionResult(faceResult) : $"Error: {faceResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                case "detectPeople":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var peopleResult = await AzureVision.DetectPeopleAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = peopleResult.Success ? $"Detected {peopleResult.Regions?.Count ?? 0} people in the image" : $"Error: {peopleResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                 case "detectBrands":
                     if (AzureVision != null && AzureVision.IsConfigured)
                     {
                         var brandResult = await AzureVision.DetectBrandsAsync(Convert.FromBase64String(_codeImageBase64));
                         _analysisResult = brandResult.Success ? FormatBrandDetectionResult(brandResult) : $"Error: {brandResult.ErrorMessage}";
                     }
                     else
                     {
                         _codeError = "Azure Vision service not configured";
                     }
                     break;

                 case "imageCategory":
                     if (AzureVision != null && AzureVision.IsConfigured)
                     {
                         var categoryResult = await AzureVision.GetImageCategoryAsync(Convert.FromBase64String(_codeImageBase64));
                         if (categoryResult.Success && categoryResult.Categories != null)
                         {
                             var sbCat = new StringBuilder();
                             sbCat.AppendLine($"Primary: {categoryResult.PrimaryCategory}");
                             foreach (var c in categoryResult.Categories)
                             {
                                 sbCat.AppendLine($"• {c.Name} ({c.Confidence:P0})");
                             }
                             _analysisResult = sbCat.ToString();
                         }
                         else
                         {
                             _analysisResult = $"Error: {categoryResult.ErrorMessage ?? "No categories returned"}";
                         }
                     }
                     else
                     {
                         _codeError = "Azure Vision service not configured";
                     }
                     break;

                 case "analyzeComprehensive":
                     if (AzureVision != null && AzureVision.IsConfigured)
                     {
                         var fullResult = await AzureVision.AnalyzeComprehensiveAsync(Convert.FromBase64String(_codeImageBase64));
                         _analysisResult = fullResult.Success
                             ? FormatObjectDetectionResult(fullResult)
                             : $"Error: {fullResult.ErrorMessage}";
                     }
                     else
                     {
                         _codeError = "Azure Vision service not configured";
                     }
                     break;

                case "imageType":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var typeResult = await AzureVision.GetImageTypeAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = typeResult.Success ? $"Image Type: {typeResult.ImageType}\nClipArt: {typeResult.IsClipArt}\nLine Drawing: {typeResult.IsLineDrawing}" : $"Error: {typeResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                case "adultContent":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var adultResult = await AzureVision.DetectAdultContentAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = adultResult.Success ? $"Adult Content: {adultResult.IsAdultContent} ({adultResult.AdultScore:P0})\nRacy Content: {adultResult.IsRacyContent} ({adultResult.RacyScore:P0})\nGory Content: {adultResult.IsGoryContent} ({adultResult.GoreScore:P0})" : $"Error: {adultResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                case "extractIcons":
                case "extractLogos":
                    await RunImageExtractionAsync();
                    break;
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Analysis failed: {ex.Message}";
        }
        
        _isAnalyzing = false;
        StateHasChanged();
    }
    
    private async Task RunImageExtractionAsync()
    {
        var imageBytes = Convert.FromBase64String(_codeImageBase64);
        
        // Build extraction options
        var options = new ExtractionOptions
        {
            Mode = _cropMode switch
            {
                "AzureVision" => CropMode.AzureVision,
                "AzureVisionComprehensive" => CropMode.AzureVisionComprehensive,
                "AzureVisionPeople" => CropMode.AzureVisionPeople,
                "HybridPixelPerfect" => CropMode.HybridPixelPerfect,
                "SmartUICards" => CropMode.SmartUICards,
                "ContourDetection" => CropMode.ContourDetection,
                "FloodFillRegions" => CropMode.FloodFillRegions,
                "SmartDetect" => CropMode.SmartDetect,
                "Grid" => CropMode.Grid,
                "Sections" => CropMode.Sections,
                "Components" => CropMode.Components,
                "AIRegions" => CropMode.AIRegions,
                _ => CropMode.AzureVision
            },
            GridRows = _gridRows,
            GridColumns = _gridColumns,
            MinComponentSize = _minComponentSize,
            RefineWithEdgeDetection = _refineWithEdgeDetection,
            EdgeDetectionThreshold = _edgeDetectionThreshold,
            Padding = _extractionAddPadding ? 2 : 0,
            DetectOnly = _extractionDetectOnly,
            ExtractionType = _extractionType
        };
        
        // Handle detect-only mode for AI-based modes
        if (_extractionDetectOnly && (_cropMode == "SmartDetect" || _cropMode == "AIRegions"))
        {
            _imageRegionsResult = await ImageExtraction.IdentifyImageRegionsAsync(imageBytes, _codeImageMimeType);
            if (!_imageRegionsResult.Success)
            {
                _codeError = _imageRegionsResult.ErrorMessage ?? "Failed to identify image regions";
                return;
            }
            
            // Convert regions to extraction result for display
            _extractedImagesResult = new ImageExtractionResult
            {
                Success = true,
                TotalImagesFound = _imageRegionsResult.Regions?.Count ?? 0,
                AnalysisSummary = $"Detected {_imageRegionsResult.Regions?.Count ?? 0} regions (no cropping)",
                Images = _imageRegionsResult.Regions?.Select(r => new ExtractedImage
                {
                    Description = r.Description,
                    ImageType = r.ImageType,
                    BoundingBox = r.BoundingBox,
                    Confidence = r.Confidence,
                    SuggestedFilename = r.SuggestedFilename,
                    Width = r.BoundingBox?.Width ?? 0,
                    Height = r.BoundingBox?.Height ?? 0
                }).ToList()
            };
            return;
        }
        
        // Run extraction based on crop mode
        switch (_cropMode)
        {
            case "Grid":
                _extractedImagesResult = await ImageExtraction.ExtractGridAsync(imageBytes, _codeImageMimeType, _gridRows, _gridColumns);
                break;
                
            case "Sections":
                _extractedImagesResult = await ImageExtraction.ExtractSectionsAsync(imageBytes, _codeImageMimeType);
                break;
                
            case "Components":
                _extractedImagesResult = await ImageExtraction.ExtractComponentsAsync(imageBytes, _codeImageMimeType, _minComponentSize);
                break;
                
            case "SmartDetect":
                _extractedImagesResult = await ImageExtraction.ExtractWithOptionsAsync(imageBytes, _codeImageMimeType, options);
                break;
                
            case "AIRegions":
            default:
                // Use original extraction type-based logic
                switch (_extractionType)
                {
                    case "icons":
                        _extractedImagesResult = await ImageExtraction.ExtractIconsAsync(imageBytes, _codeImageMimeType);
                        break;
                    case "logos":
                        _extractedImagesResult = await ImageExtraction.ExtractLogosAsync(imageBytes, _codeImageMimeType);
                        break;
                    default:
                        _extractedImagesResult = await ImageExtraction.ExtractImagesAsync(imageBytes, _codeImageMimeType);
                        break;
                }
                break;
        }
        
        if (!_extractedImagesResult.Success)
        {
            _codeError = _extractedImagesResult.ErrorMessage ?? "Failed to extract images";
            return;
        }
        
        // Apply filters
        if (_extractedImagesResult.Images != null)
        {
            var filtered = _extractedImagesResult.Images.AsEnumerable();
            
            // Filter by type if not "all"
            if (_extractionType != "all" && _extractionType != "icons" && _extractionType != "logos")
            {
                filtered = filtered.Where(img => 
                    (img.ImageType?.ToLower() ?? "").Contains(_extractionType.ToLower()));
            }
            
            // Filter by size
            filtered = _extractionSizeFilter switch
            {
                "small" => filtered.Where(img => img.Width <= 64 && img.Height <= 64),
                "medium" => filtered.Where(img => (img.Width > 64 || img.Height > 64) && img.Width <= 256 && img.Height <= 256),
                "large" => filtered.Where(img => img.Width > 256 || img.Height > 256),
                "custom" => filtered.Where(img => 
                    img.Width >= _extractionMinSize && img.Height >= _extractionMinSize &&
                    img.Width <= _extractionMaxSize && img.Height <= _extractionMaxSize),
                _ => filtered
            };
            
            // Filter by confidence
            if (_extractionHighConfidenceOnly)
            {
                filtered = filtered.Where(img => img.Confidence >= 80);
            }
            
            var filteredList = filtered.ToList();
            _extractedImagesResult.Images = filteredList;
            _extractedImagesResult.TotalImagesFound = filteredList.Count;
            _extractedImagesResult.AnalysisSummary = $"Extracted {filteredList.Count} {GetExtractionTypeLabel()} images";
        }
    }
    
    private string GetExtractionTypeLabel()
    {
        return _extractionType switch
        {
            "icons" => "icon",
            "logos" => "logo/branding",
            "photos" => "photo",
            "illustrations" => "illustration",
            "charts" => "chart/diagram",
            "backgrounds" => "background",
            "avatars" => "avatar",
            _ => ""
        };
    }
    
    private string GetExtractionResultTitle()
    {
        if (_extractionDetectOnly)
            return "Detected Regions";
            
        return _cropMode switch
        {
            "AzureVision" => "☁️ Azure Vision 4.0 — Pixel-Accurate Extraction",
            "AzureVisionComprehensive" => "☁️ Azure Vision 4.0 — Comprehensive (All Features)",
            "AzureVisionPeople" => "☁️ Azure Vision 4.0 — People/Avatars",
            "HybridPixelPerfect" => "⚡ Hybrid — Azure Vision + GPT-4o + Edge",
            "SmartUICards" => "🖼️ SkiaSharp — UI Cards & Widgets",
            "ContourDetection" => "🖼️ SkiaSharp — Contour Detection",
            "FloodFillRegions" => "🖼️ SkiaSharp — Flood Fill Regions",
            "Grid" => $"🖼️ SkiaSharp — Grid Cells ({_gridRows}×{_gridColumns})",
            "Sections" => "🖼️ SkiaSharp — Page Sections",
            "Components" => "🖼️ SkiaSharp — UI Components",
            "SmartDetect" => "🤖 GPT-4o + Edge Refinement",
            "AIRegions" => "🤖 GPT-4o — AI Detected Regions",
            _ => "Extracted Images"
        };
    }
    
    private async Task CropAndDownloadRegion(BoundingBox bounds)
    {
        try
        {
            var imageBytes = Convert.FromBase64String(_codeImageBase64);
            var cropResult = await ImageExtraction.CropRegionAsync(imageBytes, _codeImageMimeType, bounds);
            
            if (cropResult.Success && cropResult.Base64Data != null)
            {
                var filename = $"cropped-{bounds.X}-{bounds.Y}-{bounds.Width}x{bounds.Height}.png";
                await DownloadImageBase64(cropResult.Base64Data, filename);
            }
            else
            {
                _codeError = cropResult.ErrorMessage ?? "Failed to crop region";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Crop failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task DownloadImageBase64(string base64Data, string filename)
    {
        try
        {
            await JS.InvokeVoidAsync("downloadFile", $"data:image/png;base64,{base64Data}", filename);
        }
        catch (Exception ex)
        {
            _codeError = $"Download failed: {ex.Message}";
        }
    }
    
    private void ClearAnalysisResults()
    {
        _colorAnalysis = null;
        _typographyAnalysis = null;
        _layoutAnalysis = null;
        _componentsAnalysis = null;
        _iconsAnalysis = null;
        _accessibilityAnalysis = null;
        _comprehensiveAnalysis = null;
        _extractedImagesResult = null;
        _imageRegionsResult = null;
    }
    
    private string GetAnalysisButtonText()
    {
        if (_selectedAnalysis == "extractImages")
        {
            var modeLabel = _cropMode switch
            {
                "AzureVision" => "Azure Vision",
                "AzureVisionComprehensive" => "Azure Vision (Full)",
                "AzureVisionPeople" => "People/Avatars",
                "HybridPixelPerfect" => "Hybrid (Best)",
                "SmartUICards" => "UI Cards",
                "ContourDetection" => "Contours",
                "FloodFillRegions" => "Color Regions",
                "Grid" => $"Grid ({_gridRows}×{_gridColumns})",
                "Sections" => "Sections",
                "Components" => "Components",
                "SmartDetect" => "GPT-4o + Edge",
                "AIRegions" => _extractionType switch
                {
                    "all" => "GPT-4o All",
                    "icons" => "Icons",
                    "logos" => "Logos",
                    "photos" => "Photos",
                    "illustrations" => "Illustrations",
                    "charts" => "Charts",
                    "backgrounds" => "Backgrounds",
                    "avatars" => "Avatars",
                    _ => "Images"
                },
                _ => "Images"
            };
            return _extractionDetectOnly ? $"Detect {modeLabel}" : $"Extract {modeLabel}";
        }
        
        return _selectedAnalysis switch
        {
            "code" => "Generate Code",
            "codeWithViewModel" => "Generate Code + ViewModel",
            "describe" => "Describe Design",
            "colors" => "Extract Colors",
            "typography" => "Extract Typography",
            "layout" => "Analyze Layout",
            "components" => "Extract Components",
            "icons" => "Identify Icons",
            "accessibility" => "Run Accessibility Audit",
            "improvements" => "Get Suggestions",
            "text" => "Extract Text",
            "comprehensive" => "Run Full Analysis",
            "customVisionClassify" => "Classify (Custom Vision)",
            "customVisionDetect" => "Detect Objects (Custom Vision)",
            "videoFrames" => "Extract Video Frames",
            "videoAnalyze" => "Analyze Video",
            _ => "Analyze"
        };
    }

    private string GetAnalysisButtonIcon() => _selectedAnalysis switch
    {
        "code" => "💻",
        "codeWithViewModel" => "📋",
        "extractImages" => "🖼️",
        "describe" => "📝",
        "colors" => "🎨",
        "typography" => "🔤",
        "layout" => "📐",
        "components" => "🧩",
        "icons" => "🎯",
        "accessibility" => "♿",
        "improvements" => "💡",
        "text" => "📜",
        "comprehensive" => "🔬",
        "customVisionClassify" => "🎯",
        "customVisionDetect" => "📦",
        "videoFrames" => "🎞️",
        "videoAnalyze" => "🎬",
        _ => "🚀"
    };

     private string GetAnalysisDisplayName() => _selectedAnalysis switch
     {
         "code" => "Generate Code",
         "codeWithViewModel" => "Generate Code + ViewModel",
         "extractImages" => "Extract All Images",
         "describe" => "Describe Design",
         "colors" => "Extract Color Palette",
         "typography" => "Extract Typography",
         "layout" => "Analyze Layout",
         "components" => "Extract UI Components",
         "icons" => "Identify Icons",
         "accessibility" => "Accessibility Audit",
         "improvements" => "Suggest Improvements",
         "text" => "Extract Text (OCR)",
         "comprehensive" => "Full UI Analysis",
         "visionAnalyze" => "Azure Vision — Analyze",
         "analyzeComprehensive" => "Azure Vision — Full",
         "imageCategory" => "Azure Vision — Categories",
         "customVisionClassify" => "Custom Vision Classification",
         "customVisionDetect" => "Custom Vision Object Detection",
         "videoFrames" => "Extract Video Frames",
         "videoAnalyze" => "Video Insights & Transcript",
         _ => "Analysis"
     };

     private string GetAnalysisDescription() => _selectedAnalysis switch
     {
         "code" => "Convert UI screenshot to production-ready code. Supports HTML/CSS, React, Vue, Blazor, SwiftUI, MAUI XAML, Angular.",
         "codeWithViewModel" => "Generate code with data binding. Extracts text content into a ViewModel/Model class for dynamic content.",
         "extractImages" => "Detect and extract all images, icons, logos, and graphics from a composite screenshot with AI precision.",
         "describe" => "Get a comprehensive description of UI design including layout, colors, components, and style.",
         "colors" => "Extract complete color palette: primary, secondary, accent, background, text colors and gradients.",
         "typography" => "Identify fonts, sizes, weights, line heights, and text styles used in the design.",
         "layout" => "Analyze layout structure: grid system, spacing, sections, breakpoints, and responsive patterns.",
         "components" => "Extract all UI components with their properties, styles, and hierarchy as structured data.",
         "icons" => "Identify icons and suggest matches from popular libraries: Heroicons, Material, Font Awesome.",
         "accessibility" => "WCAG accessibility audit: contrast ratios, text sizes, touch targets, and recommendations.",
         "improvements" => "Get AI suggestions to improve the UI design: UX, accessibility, visual hierarchy.",
         "text" => "OCR: Extract all visible text with position info. Supports multiple languages and fonts.",
         "comprehensive" => "Complete UI analysis: colors, typography, layout, components, icons, and accessibility combined.",
         "visionAnalyze" => "Azure Vision 4.0 quick pass with objects + dense captions.",
         "analyzeComprehensive" => "Azure Vision 4.0 full feature set (objects, captions, people, tags, crops).",
         "imageCategory" => "Classify the scene with Azure Vision categories and confidences.",
         "customVisionClassify" => "Run your trained Custom Vision classifier to label the image with project-specific tags and probabilities.",
         "customVisionDetect" => "Use your Custom Vision object detector to find project-specific objects with bounding boxes and confidence scores.",
         "videoFrames" => "Upload a video to sample frames (1s interval) for quick visual inspection and thumbnails.",
         "videoAnalyze" => "Analyze video for labels, faces, and transcript snippets using Azure AI Video Indexer.",
         _ => "Select an analysis type to see details."
     };

     private string GetServiceName() => _selectedAnalysis switch
     {
         "code" or "codeWithViewModel" or "describe" or "colors" or "typography" or "layout" or "components" or "icons" or "accessibility" or "improvements" or "comprehensive" or "text" => "GPT-4o Vision",
         "extractImages" => "GPT-4o + SkiaSharp",
         "visionAnalyze" or "analyzeComprehensive" or "imageCategory" or "visionCaption" or "visionDenseCaptions" or "visionTags" or "visionSmartCrops" or "visionRead" or "detectObjects" or "detectFaces" or "detectPeople" or "detectBrands" or "imageType" or "adultContent" or "removeBackground" => "Azure AI Vision",
         "customVisionClassify" or "customVisionDetect" => "Azure AI Custom Vision",
         "videoFrames" or "videoAnalyze" => "Azure AI Video Indexer",
         _ => "Azure AI"
     };

     private string GetServiceBadgeColor() => _selectedAnalysis switch
     {
         "code" or "codeWithViewModel" or "describe" or "colors" or "typography" or "layout" or "components" or "icons" or "accessibility" or "improvements" or "comprehensive" or "text" => "#8b5cf6",
         "extractImages" => "#10b981",
         "visionAnalyze" or "analyzeComprehensive" or "imageCategory" or "visionCaption" or "visionDenseCaptions" or "visionTags" or "visionSmartCrops" or "visionRead" or "detectObjects" or "detectFaces" or "detectPeople" or "detectBrands" or "imageType" or "adultContent" or "removeBackground" => "#0ea5e9",
         "customVisionClassify" or "customVisionDetect" => "#0ea5e9",
         "videoFrames" or "videoAnalyze" => "#2563eb",
         _ => "#667eea"
     };

    private bool IsAzureVisionRequired() => _selectedAnalysis switch
    {
        "visionAnalyze" or "visionCaption" or "visionDenseCaptions" or "visionTags" or "visionSmartCrops" or "visionRead" or "removeBackground" or "detectObjects" or "detectPeople" or "analyzeComprehensive" or "detectFaces" or "detectBrands" or "imageType" or "adultContent" or "imageCategory" => true,
        _ => false
    };

    private async Task CopyCodeToClipboard()
    {
        if (!string.IsNullOrEmpty(_generatedCode))
        {
            try
            {
                // Try modern clipboard API first
                await JS.InvokeVoidAsync("navigator.clipboard.writeText", _generatedCode);
                _codeCopied = true;
                await Task.Delay(100);
                StateHasChanged();
            }
            catch
            {
                try
                {
                    // Fallback to custom clipboard function
                    var success = await JS.InvokeAsync<bool>("copyToClipboard", _generatedCode);
                    _codeCopied = success;
                    StateHasChanged();
                }
                catch
                {
                    // Final fallback
                    try
                    {
                        var escapedText = JsonSerializer.Serialize(_generatedCode);
                        await JS.InvokeVoidAsync("eval", $@"
                            (function() {{
                                var textArea = document.createElement('textarea');
                                textArea.value = {escapedText};
                                textArea.style.position = 'fixed';
                                textArea.style.left = '-9999px';
                                document.body.appendChild(textArea);
                                textArea.focus();
                                textArea.select();
                                document.execCommand('copy');
                                document.body.removeChild(textArea);
                            }})();
                        ");
                        _codeCopied = true;
                        StateHasChanged();
                    }
                    catch
                    {
                        _codeCopied = false;
                        _codeError = "Failed to copy code to clipboard";
                        StateHasChanged();
                    }
                }
            }
            
            // Reset the copied flag after 2 seconds
            if (_codeCopied)
            {
                await Task.Delay(2000);
                _codeCopied = false;
                StateHasChanged();
            }
        }
    }
    
    private bool CanShowPreview()
    {
        // HTML-based and Razor frameworks can show preview panel
        return _targetFramework is "HTML/CSS" or "Tailwind CSS" or "Blazor Razor" or "Blazor MAUI" or "ASP.NET Razor";
    }
    
    private bool IsRazorFramework()
    {
        // Check if the current framework is a Razor-based framework
        return _targetFramework is "Blazor Razor" or "Blazor MAUI" or "ASP.NET Razor";
    }

    private bool IsHtmlFramework()
    {
        // Check if the current framework outputs pure HTML
        return _targetFramework is "HTML/CSS" or "Tailwind CSS";
    }

    private bool IsVideoUpload() => _codeImageMimeType?.StartsWith("video", StringComparison.OrdinalIgnoreCase) == true;

    private string GetPreviewTitle()
    {
        return _targetFramework switch
        {
            "HTML/CSS" => "Live HTML Preview",
            "Tailwind CSS" => "Live Tailwind Preview",
            "Blazor Razor" => "Blazor Component Preview",
            "Blazor MAUI" => "MAUI Blazor Preview",
            "ASP.NET Razor" => "Razor Page Preview",
            _ => "Preview"
        };
    }
    
    private void RefreshPreview()
    {
        // Force re-render by triggering state change
        _previewKey = Guid.NewGuid().ToString();
        StateHasChanged();
        if (IsHtmlFramework())
        {
            _ = LoadPreviewIframeAsync();
        }
        else if (IsRazorFramework())
        {
            _ = LoadRazorPreviewAsync();
        }
    }
    
    private string _previewKey = "";
    
    private string GetPreviewDataUrl()
    {
        if (string.IsNullOrEmpty(_generatedCode)) 
            return "data:text/html,<html><body style='font-family:sans-serif;padding:20px;color:#666;'><h2>No preview available</h2><p>Generate HTML or Tailwind CSS code to see preview</p></body></html>";
        
        var html = GetPreviewHtml();
        var bytes = System.Text.Encoding.UTF8.GetBytes(html);
        var base64 = Convert.ToBase64String(bytes);
        // Add cache-busting parameter using preview key
        return $"data:text/html;charset=utf-8;base64,{base64}#{_previewKey}";
    }
    
    private async Task LoadPreviewIframeAsync()
    {
        // Only load iframe for HTML-based frameworks (not Razor)
        if (string.IsNullOrEmpty(_generatedCode) || !IsHtmlFramework()) return;
        
        try
        {
            _htmlPreviewContent = GetPreviewHtml();
            StateHasChanged();
            
            // Also try JS method as backup
            await Task.Delay(100);
            await JS.InvokeVoidAsync("loadIframeContent", "htmlPreviewFrame,htmlPreviewFrameSplit", _htmlPreviewContent);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to load preview: {ex.Message}");
        }
    }
    
    private void SetCodeViewMode()
    {
        _codeViewMode = "code";
    }
    
    private void SetPreviewViewMode()
    {
        _codeViewMode = "preview";
        StateHasChanged();
        if (IsHtmlFramework())
        {
            _ = LoadPreviewIframeAsync();
        }
        else if (IsRazorFramework())
        {
            _ = LoadRazorPreviewAsync();
        }
    }
    
    private void SetSplitViewMode()
    {
        _codeViewMode = "split";
        StateHasChanged();
        if (IsHtmlFramework())
        {
            _ = LoadPreviewIframeAsync();
        }
        else if (IsRazorFramework())
        {
            _ = LoadRazorPreviewAsync();
        }
    }
    
    private async Task LoadRazorPreviewAsync()
    {
        if (string.IsNullOrEmpty(_generatedCode)) 
        {
            // No-op for inline preview - DynamicRazorPreview component handles it
            // This is only used for popup/download features
            return;
        }
        
        if (RazorRenderer == null)
        {
            return;
        }
        
        try
        {
            // Generate preview HTML for popup/download features
            _razorPreviewHtml = await RazorRenderer.GeneratePreviewPageAsync(_generatedCode, _targetFramework);
            _lastRazorRenderResult = await RazorRenderer.RenderToHtmlAsync(_generatedCode, _targetFramework);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Failed to generate Razor preview HTML: {ex.Message}");
        }
    }
    
    private async Task OpenPreviewPopup()
    {
        if (string.IsNullOrEmpty(_generatedCode) || !CanShowPreview()) return;
        
        try
        {
            string htmlContent;
            if (IsRazorFramework() && RazorRenderer != null)
            {
                htmlContent = await RazorRenderer.GeneratePreviewPageAsync(_generatedCode, _targetFramework);
            }
            else
            {
                htmlContent = GetPreviewHtml();
            }
            var escapedHtml = System.Text.Json.JsonSerializer.Serialize(htmlContent);
            
            // Use JavaScript to open a new window and write content directly
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    try {{
                        var htmlContent = {escapedHtml};
                        
                        // Method 1: Open blank window and write content
                        var w = window.open('about:blank', '_blank', 'width=1024,height=768,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no');
                        
                        if (w) {{
                            w.document.open();
                            w.document.write(htmlContent);
                            w.document.close();
                            w.focus();
                            return;
                        }}
                        
                        // Method 2: Try data URL
                        var encoded = btoa(unescape(encodeURIComponent(htmlContent)));
                        var dataUrl = 'data:text/html;charset=utf-8;base64,' + encoded;
                        var w2 = window.open(dataUrl, '_blank');
                        
                        if (w2) {{
                            w2.focus();
                            return;
                        }}
                        
                        // Method 3: Download as fallback
                        alert('Could not open preview window. The file will be downloaded instead.');
                        var blob = new Blob([htmlContent], {{type: 'text/html'}});
                        var url = URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'preview.html';
                        a.click();
                        URL.revokeObjectURL(url);
                        
                    }} catch(e) {{
                        console.error('Preview error:', e);
                        alert('Could not open preview: ' + e.message);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Preview error: {ex.Message}");
        }
    }
    
    private async Task DownloadPreviewHtml()
    {
        if (string.IsNullOrEmpty(_generatedCode) || !CanShowPreview()) return;
        
        try
        {
            string htmlContent;
            if (IsRazorFramework() && RazorRenderer != null)
            {
                htmlContent = await RazorRenderer.GeneratePreviewPageAsync(_generatedCode, _targetFramework);
            }
            else
            {
                htmlContent = GetPreviewHtml();
            }
            var bytes = System.Text.Encoding.UTF8.GetBytes(htmlContent);
            var base64 = Convert.ToBase64String(bytes);
            
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    try {{
                        var base64 = '{base64}';
                        var binary = atob(base64);
                        var bytes = new Uint8Array(binary.length);
                        for (var i = 0; i < binary.length; i++) {{
                            bytes[i] = binary.charCodeAt(i);
                        }}
                        var blob = new Blob([bytes], {{ type: 'text/html' }});
                        var url = URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'preview-' + new Date().toISOString().slice(0,10) + '.html';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        setTimeout(function() {{ URL.revokeObjectURL(url); }}, 1000);
                    }} catch(e) {{
                        alert('Download failed: ' + e.message);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Download failed: {ex.Message}");
        }
    }
    
    private string GetPreviewHtml()
    {
        if (string.IsNullOrEmpty(_generatedCode)) return "<html><body><p>No code generated yet</p></body></html>";
        
        var htmlContent = _generatedCode.Trim();
        
        // Clean up code block markers if present
        if (htmlContent.StartsWith("```html", StringComparison.OrdinalIgnoreCase))
        {
            htmlContent = htmlContent.Substring(7);
        }
        else if (htmlContent.StartsWith("```"))
        {
            var firstNewline = htmlContent.IndexOf('\n');
            if (firstNewline > 0)
            {
                htmlContent = htmlContent.Substring(firstNewline + 1);
            }
        }
        if (htmlContent.EndsWith("```"))
        {
            htmlContent = htmlContent.Substring(0, htmlContent.Length - 3);
        }
        htmlContent = htmlContent.Trim();
        
        // If it already has a full HTML structure, return as-is
        if (htmlContent.Contains("<!DOCTYPE", StringComparison.OrdinalIgnoreCase) || 
            htmlContent.Contains("<html", StringComparison.OrdinalIgnoreCase))
        {
            return htmlContent;
        }
        
        // Otherwise wrap it in a proper HTML document with comprehensive inline CSS
        return $@"<!DOCTYPE html>
<html lang=""en"">
<head>
    <meta charset=""UTF-8"">
    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
    <script src=""https://cdn.tailwindcss.com""></script>
    <style>
        /* Base Reset */
        * {{ box-sizing: border-box; margin: 0; padding: 0; }}
        body {{ 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.5;
            color: #1f2937;
            background: #ffffff;
            padding: 16px;
            min-height: 100vh;
        }}
        
        /* Tailwind-like utilities as fallback */
        .flex {{ display: flex; }}
        .flex-col {{ flex-direction: column; }}
        .items-center {{ align-items: center; }}
        .justify-center {{ justify-content: center; }}
        .justify-between {{ justify-content: space-between; }}
        .gap-2 {{ gap: 0.5rem; }}
        .gap-4 {{ gap: 1rem; }}
        .p-2 {{ padding: 0.5rem; }}
        .p-4 {{ padding: 1rem; }}
        .p-6 {{ padding: 1.5rem; }}
        .m-2 {{ margin: 0.5rem; }}
        .m-4 {{ margin: 1rem; }}
        .mb-2 {{ margin-bottom: 0.5rem; }}
        .mb-4 {{ margin-bottom: 1rem; }}
        .mt-2 {{ margin-top: 0.5rem; }}
        .mt-4 {{ margin-top: 1rem; }}
        .text-center {{ text-align: center; }}
        .text-sm {{ font-size: 0.875rem; }}
        .text-lg {{ font-size: 1.125rem; }}
        .text-xl {{ font-size: 1.25rem; }}
        .text-2xl {{ font-size: 1.5rem; }}
        .font-bold {{ font-weight: 700; }}
        .font-semibold {{ font-weight: 600; }}
        .text-white {{ color: white; }}
        .text-gray-500 {{ color: #6b7280; }}
        .text-gray-700 {{ color: #374151; }}
        .bg-white {{ background-color: white; }}
        .bg-gray-100 {{ background-color: #f3f4f6; }}
        .bg-blue-500 {{ background-color: #3b82f6; }}
        .bg-blue-600 {{ background-color: #2563eb; }}
        .rounded {{ border-radius: 0.25rem; }}
        .rounded-lg {{ border-radius: 0.5rem; }}
        .rounded-xl {{ border-radius: 0.75rem; }}
        .shadow {{ box-shadow: 0 1px 3px rgba(0,0,0,0.1); }}
        .shadow-lg {{ box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }}
        .border {{ border: 1px solid #e5e7eb; }}
        .w-full {{ width: 100%; }}
        .h-full {{ height: 100%; }}
        .min-h-screen {{ min-height: 100vh; }}
        
        /* Common components */
        .btn {{ 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            padding: 0.5rem 1rem; 
            border-radius: 0.375rem; 
            font-weight: 500;
            cursor: pointer;
            border: none;
        }}
        .btn-primary {{ background: #3b82f6; color: white; }}
        .btn-secondary {{ background: #6b7280; color: white; }}
        
        .card {{ 
            background: white; 
            border-radius: 0.5rem; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }}
        .card-header {{ padding: 1rem; border-bottom: 1px solid #e5e7eb; font-weight: 600; }}
        .card-body {{ padding: 1rem; }}
        
        .form-control {{
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 1rem;
        }}
    </style>
</head>
<body>
{htmlContent}
</body>
</html>";
    }
    
    private static string GetCodeSystemPrompt(string framework)
    {
        var basePrompt = """
            You are an expert frontend developer specializing in converting UI designs to code.
            Analyze the provided UI image and generate clean, well-structured, responsive code that 
            replicates it as closely as possible. Pay attention to:
            - Layout and spacing
            - Colors and gradients
            - Typography and font sizes
            - Border radius and shadows
            - Responsive design
            - Accessibility
            
            Output ONLY the code, no explanations or markdown formatting.
            """;

        return framework switch
        {
            "React" => basePrompt + "\nGenerate React functional components with inline styles or styled-components.",
            "Blazor" => basePrompt + "\nGenerate Blazor components (.razor) with scoped CSS.",
            "SwiftUI" => basePrompt + "\nGenerate SwiftUI views for iOS/macOS.",
            "MAUI XAML" => basePrompt + "\nGenerate .NET MAUI XAML with proper namespaces.",
            "Tailwind CSS" => basePrompt + "\nGenerate HTML with Tailwind CSS classes.",
            "Vue" => basePrompt + "\nGenerate Vue 3 components with Composition API.",
            _ => basePrompt + "\nGenerate semantic HTML5 with embedded CSS."
        };
    }
    
    private static string GetLanguageHint(string framework)
    {
        return framework switch
        {
            "React" => "jsx",
            "Blazor" => "razor",
            "SwiftUI" => "swift",
            "MAUI XAML" => "xml",
            "Vue" => "vue",
            "Tailwind CSS" => "html",
            _ => "html"
        };
    }
    
    private static string CleanCodeOutput(string code)
    {
        code = code.Trim();
        
        if (code.StartsWith("```"))
        {
            var firstNewline = code.IndexOf('\n');
            if (firstNewline > 0)
            {
                code = code[(firstNewline + 1)..];
            }
        }
        
        if (code.EndsWith("```"))
        {
            code = code[..^3];
        }
        
        return code.Trim();
    }
    
    // ViewModel Generation Methods
    private async Task GenerateCodeWithViewModel()
    {
        if (string.IsNullOrEmpty(_codeImageBase64)) return;
        
        _isConvertingToCode = true;
        _extractedTextJson = "";
        _generatedViewModel = "";
        _generatedRazorWithParams = "";
        _viewModelPreviewHtml = "";
        _codeError = "";
        _viewModelTab = "extracted";
        StateHasChanged();
        
        try
        {
            // Step 1: Extract all text/data from the image using VisionService
            var extractPrompt = @"
Analyze this UI image and extract ALL visible text, labels, numbers, and data values.
Return a JSON object where each key is a meaningful property name (camelCase) and each value is the text/number found.
Include: titles, labels, values, button text, status text, dates, numbers, percentages, etc.
Example format:
{
    ""pageTitle"": ""Dashboard"",
    ""userName"": ""John Doe"",
    ""progressValue"": 75,
    ""progressMax"": 100,
    ""statusText"": ""Active"",
    ""buttonText"": ""Submit"",
    ""dateValue"": ""January 2024""
}
Return ONLY valid JSON with actual values from the image.";
            
            var extractResult = await VisionService.AnalyzeImageAsync(_codeImageBase64, _codeImageMimeType, extractPrompt);
            
            if (!extractResult.Success)
            {
                _codeError = $"Text extraction failed: {extractResult.ErrorMessage}";
                _isConvertingToCode = false;
                StateHasChanged();
                return;
            }
            
            _extractedTextJson = CleanJsonOutput(extractResult.Content ?? "{}");
            StateHasChanged();
            
            // Step 2: Generate a ViewModel class from the extracted data
            _generatedViewModel = GenerateViewModelFromJson(_extractedTextJson);
            StateHasChanged();
            
            // Step 3: Generate Razor page with parameters
            var razorPrompt = $@"
Generate a Blazor Razor page that recreates this UI design.
The page should use a ViewModel parameter called 'Model' with these properties extracted from the image:
{_extractedTextJson}

Requirements:
1. Use [Parameter] public PageViewModel Model {{ get; set; }} = new();
2. Replace ALL hardcoded text with @Model.PropertyName
3. Use inline CSS styles (no external stylesheets)
4. Make it responsive and match the design closely
5. Include the @page directive at the top
6. Include the ViewModel class definition in a @code section or reference it

Return ONLY the complete Razor page code.";
            
            var razorResult = await VisionService.AnalyzeImageAsync(_codeImageBase64, _codeImageMimeType, razorPrompt);
            
            if (razorResult.Success)
            {
                _generatedRazorWithParams = CleanCodeOutput(razorResult.Content ?? "");
                
                // Generate preview HTML
                _viewModelPreviewHtml = GeneratePreviewHtml();
            }
            else
            {
                _codeError = $"Razor generation failed: {razorResult.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Generation failed: {ex.Message}";
        }
        
        _isConvertingToCode = false;
        StateHasChanged();
    }
    
    private string CleanJsonOutput(string json)
    {
        json = json.Trim();
        if (json.StartsWith("```json")) json = json[7..];
        else if (json.StartsWith("```")) json = json[3..];
        if (json.EndsWith("```")) json = json[..^3];
        return json.Trim();
    }
    
    private string GenerateViewModelFromJson(string json)
    {
        try
        {
            using var doc = JsonDocument.Parse(json);
            var sb = new StringBuilder();
            
            sb.AppendLine("namespace YourApp.Models;");
            sb.AppendLine();
            sb.AppendLine("public class PageViewModel");
            sb.AppendLine("{");
            
            foreach (var prop in doc.RootElement.EnumerateObject())
            {
                var propName = char.ToUpper(prop.Name[0]) + prop.Name[1..];
                var propType = prop.Value.ValueKind switch
                {
                    JsonValueKind.Number => prop.Value.TryGetInt32(out _) ? "int" : "double",
                    JsonValueKind.True or JsonValueKind.False => "bool",
                    JsonValueKind.Array => "List<string>",
                    _ => "string"
                };
                
                var defaultValue = prop.Value.ValueKind switch
                {
                    JsonValueKind.Number => prop.Value.ToString(),
                    JsonValueKind.True => "true",
                    JsonValueKind.False => "false",
                    JsonValueKind.String => $"\"{prop.Value.GetString()?.Replace("\"", "\\\"")}\"",
                    _ => "\"\""
                };
                
                sb.AppendLine($"    public {propType} {propName} {{ get; set; }} = {defaultValue};");
            }
            
            sb.AppendLine("}");
            return sb.ToString();
        }
        catch
        {
            return "// Error generating ViewModel - check extracted JSON\npublic class PageViewModel { }";
        }
    }
    
    private string GeneratePreviewHtml()
    {
        // Try to convert Razor-like syntax to plain HTML for preview
        var html = _generatedRazorWithParams;
        
        // Remove @page directive
        html = System.Text.RegularExpressions.Regex.Replace(html, @"@page\s+""[^""]*""", "");
        
        // Remove @code section
        html = System.Text.RegularExpressions.Regex.Replace(html, @"@code\s*\{[\s\S]*\}", "", System.Text.RegularExpressions.RegexOptions.Singleline);
        
        // Try to replace @Model.Property with actual values from extracted JSON
        try
        {
            using var doc = JsonDocument.Parse(_extractedTextJson);
            foreach (var prop in doc.RootElement.EnumerateObject())
            {
                var propName = char.ToUpper(prop.Name[0]) + prop.Name[1..];
                var value = prop.Value.ToString();
                html = html.Replace($"@Model.{propName}", value);
                html = html.Replace($"@(Model.{propName})", value);
            }
        }
        catch { }
        
        // Remove remaining Razor syntax
        html = System.Text.RegularExpressions.Regex.Replace(html, @"@\w+[\.\w]*", "");
        html = System.Text.RegularExpressions.Regex.Replace(html, @"@\([^)]*\)", "");
        
        return $@"<!DOCTYPE html>
<html>
<head>
    <meta charset=""UTF-8"">
    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
    <style>* {{ box-sizing: border-box; }} body {{ margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }}</style>
</head>
<body>
{html}
</body>
</html>";
    }
    
    private async Task CopyExtractedText()
    {
        await CopyToClipboard(_extractedTextJson);
    }
    
    private async Task CopyViewModel()
    {
        await CopyToClipboard(_generatedViewModel);
    }
    
    private async Task CopyRazorCode()
    {
        await CopyToClipboard(_generatedRazorWithParams);
    }
    

    private async Task OpenViewModelPreview()
    {
        if (string.IsNullOrEmpty(_viewModelPreviewHtml)) return;
        
        try
        {
            var escapedHtml = System.Text.Json.JsonSerializer.Serialize(_viewModelPreviewHtml);
            
            // Use JavaScript to open a new window and write content directly
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    try {{
                        var htmlContent = {escapedHtml};
                        
                        // Method 1: Open blank window and write content directly
                        var w = window.open('', '_blank', 'width=600,height=800,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no');
                        
                        if (w) {{
                            w.document.open();
                            w.document.write(htmlContent);
                            w.document.close();
                            w.document.title = 'Preview';
                            w.focus();
                            return;
                        }}
                        
                        // Method 2: Try blob URL
                        var blob = new Blob([htmlContent], {{type: 'text/html;charset=utf-8'}});
                        var url = URL.createObjectURL(blob);
                        var w2 = window.open(url, '_blank', 'width=600,height=800');
                        
                        if (w2) {{
                            w2.focus();
                            // Clean up blob URL after a delay
                            setTimeout(function() {{ URL.revokeObjectURL(url); }}, 1000);
                            return;
                        }}
                        
                        // Method 3: Download as fallback
                        alert('Could not open preview window (popup may be blocked). The file will be downloaded instead.');
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'preview.html';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                    }} catch(e) {{
                        console.error('Preview error:', e);
                        alert('Could not open preview: ' + e.message);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Preview error: {ex.Message}");
        }
    }
    
    #region Service Info Modal
    
    private void ShowServiceInfoModal() => _showServiceInfoModal = true;
    
    private void ShowExtractionModeInfo() => _showServiceInfoModal = true;
    
    private void ShowApiCoverage() => _showServiceInfoModal = true;
    
    // === Premium Conversion Engine Methods ===
    
    private void OpenPremiumConversionDialog()
    {
        // Check if an image is uploaded
        if (string.IsNullOrEmpty(_codeImageUrl))
        {
            _codeError = "Please upload an image first before using the Premium Engine.";
            return;
        }
        
        _selectedAnalysis = "premiumCode";
        _showPremiumConversionDialog = true;
        _showAdvancedPremiumOptions = false;
        StateHasChanged();
    }
    
    private void ClosePremiumConversionDialog()
    {
        _showPremiumConversionDialog = false;
        StateHasChanged();
    }
    
    private async Task StartPremiumConversion()
    {
        if (string.IsNullOrEmpty(_codeImageUrl) || string.IsNullOrEmpty(_codeImageBase64))
        {
            _codeError = "Please upload an image first.";
            return;
        }
        
        _showPremiumConversionDialog = false;
        _isConvertingToCode = true;
        _codeError = "";
        _generatedCode = "";
        _targetFramework = _premiumOptions.Framework; // Set framework for loading message
        _premiumConversionProgress = "Initializing...";
        _premiumConversionProgressPercent = 0;
        StateHasChanged();
        
        try
        {
            // Convert base64 to bytes
            var imageBytes = Convert.FromBase64String(_codeImageBase64);
            
            // Call the premium conversion engine with progress callback
            _premiumConversionResult = await ImageToCode.ConvertWithPremiumEngineAsync(
                imageBytes,
                _codeImageMimeType,
                _premiumOptions,
                progress =>
                {
                    _premiumConversionProgress = $"{progress.Stage}: {progress.Message}";
                    _premiumConversionProgressPercent = progress.PercentComplete;
                    InvokeAsync(StateHasChanged);
                }
            );
            
            if (_premiumConversionResult.Success)
            {
                _generatedCode = _premiumConversionResult.Code ?? "";
                _codeLanguage = _premiumConversionResult.Language ?? "html";
                
                // Show fidelity score and warnings
                if (_premiumConversionResult.FidelityScore > 0)
                {
                    _premiumConversionProgress = $"✓ Complete! Fidelity Score: {_premiumConversionResult.FidelityScore}/100";
                }
                
                // If design tokens were extracted, show them in the output
                if (_premiumConversionResult.DesignTokens?.CssVariables != null)
                {
                    // Prepend CSS variables to the code if it's HTML/CSS
                    if (_premiumOptions.UseDesignTokens && 
                        (_premiumOptions.Framework == "HTML/CSS" || _premiumOptions.Framework == "Tailwind CSS"))
                    {
                        _generatedCode = $"<style>\n{_premiumConversionResult.DesignTokens.CssVariables}\n</style>\n\n{_generatedCode}";
                    }
                }
                
                // Update the target framework for display
                _targetFramework = _premiumOptions.Framework;
                
                // Auto-switch to split view to show both code AND preview
                if (CanShowPreview())
                {
                    _codeViewMode = "split";
                }
                
                // SAVE AND DOWNLOAD THE GENERATED HTML FILE
                await SaveAndDownloadGeneratedHtml();
            }
            else
            {
                _codeError = _premiumConversionResult.ErrorMessage ?? "Premium conversion failed";
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Premium conversion error: {ex.Message}";
        }
        finally
        {
            _isConvertingToCode = false;
            StateHasChanged();
        }
    }
    
    private async Task SaveAndDownloadGeneratedHtml()
    {
        if (string.IsNullOrEmpty(_generatedCode)) return;
        
        try
        {
            // Prepare HTML content - wrap if not a full document
            var htmlContent = _generatedCode;
            if (!htmlContent.Contains("<!DOCTYPE") && !htmlContent.Contains("<html"))
            {
                // Extract style tags
                var styleMatch = System.Text.RegularExpressions.Regex.Match(htmlContent, @"(<style[^>]*>[\s\S]*?</style>)", System.Text.RegularExpressions.RegexOptions.IgnoreCase);
                var styleContent = styleMatch.Success ? styleMatch.Value : "";
                var bodyContent = styleMatch.Success ? htmlContent.Replace(styleMatch.Value, "") : htmlContent;
                
                htmlContent = $@"<!DOCTYPE html>
<html>
<head>
    <meta charset=""UTF-8"">
    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
    <title>Generated Preview - {_targetFramework}</title>
    <style>
        * {{ box-sizing: border-box; }}
        body {{ 
            margin: 0; 
            padding: 20px; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.5;
            background: #ffffff;
        }}
    </style>
    {styleContent}
</head>
<body>
{bodyContent.Trim()}
</body>
</html>";
            }
            
            // Generate filename with timestamp
            var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            var filename = $"generated_preview_{timestamp}.html";
            
            // Download the file using JavaScript Blob
            var escapedHtml = System.Text.Json.JsonSerializer.Serialize(htmlContent);
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    var content = {escapedHtml};
                    var blob = new Blob([content], {{ type: 'text/html;charset=utf-8' }});
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = '{filename}';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Also show alert with file location info
                    alert('HTML file downloaded as: {filename}\\n\\nCheck your Downloads folder and double-click the file to open it in your browser.');
                }})();
            ");
            
            Console.WriteLine($"[SaveAndDownloadGeneratedHtml] Downloaded file: {filename}, Size: {htmlContent.Length} bytes");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[SaveAndDownloadGeneratedHtml] Error: {ex.Message}");
            _codeError = $"Failed to download HTML file: {ex.Message}";
        }
    }

    #endregion

    #region Splitter Drag Functionality
    
    private bool _splitterInitialized = false;
    private string _lastLoadedPreviewCode = "";
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadGroupSettingsAsync();
        }
        // Load preview iframe when in preview/split mode and code has changed (HTML frameworks only)
        if (!string.IsNullOrEmpty(_generatedCode) && 
            IsHtmlFramework() && 
            (_codeViewMode == "preview" || _codeViewMode == "split") &&
            _generatedCode != _lastLoadedPreviewCode)
        {
            _lastLoadedPreviewCode = _generatedCode;
            await LoadPreviewIframeAsync();
        }
        
        if (firstRender && !_splitterInitialized)
        {
            _splitterInitialized = true;
            // Inject splitter and drag-drop JavaScript
            await JS.InvokeVoidAsync("eval", @"
                // Splitter drag functionality
                window.initSplitterDrag = function(containerId, leftPaneId, splitterId) {
                    const container = document.getElementById(containerId);
                    const leftPane = document.getElementById(leftPaneId);
                    const splitter = document.getElementById(splitterId);
                    
                    if (!container || !leftPane || !splitter) return;
                    
                    let isDragging = false;
                    let startX = 0;
                    let startWidth = 0;
                    
                    splitter.addEventListener('mousedown', function(e) {
                        isDragging = true;
                        startX = e.clientX;
                        startWidth = leftPane.offsetWidth;
                        document.body.style.cursor = 'col-resize';
                        document.body.style.userSelect = 'none';
                        e.preventDefault();
                    });
                    
                    document.addEventListener('mousemove', function(e) {
                        if (!isDragging) return;
                        const dx = e.clientX - startX;
                        const containerWidth = container.offsetWidth;
                        let newWidth = startWidth + dx;
                        
                        // Constraints
                        const minWidth = 250;
                        const maxWidth = containerWidth * 0.6;
                        
                        if (newWidth < minWidth) newWidth = minWidth;
                        if (newWidth > maxWidth) newWidth = maxWidth;
                        
                        leftPane.style.width = newWidth + 'px';
                    });
                    
                    document.addEventListener('mouseup', function(e) {
                        if (isDragging) {
                            isDragging = false;
                            document.body.style.cursor = '';
                            document.body.style.userSelect = '';
                        }
                    });
                };
                
                // Store last dropped file for reading
                window._lastDroppedFile = null;
                
                // Global drag/drop handler to capture dropped files
                document.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                document.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                        const file = e.dataTransfer.files[0];
                        if (file.type.startsWith('image/')) {
                            window._lastDroppedFile = file;
                        }
                    }
                });
                
                // Read dropped file and return base64
                window.readDroppedFile = function() {
                    return new Promise((resolve, reject) => {
                        const file = window._lastDroppedFile;
                        if (!file) {
                            resolve(null);
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const base64 = e.target.result.split(',')[1];
                            resolve({
                                base64: base64,
                                mimeType: file.type,
                                fileName: file.name
                            });
                            window._lastDroppedFile = null;
                        };
                        reader.onerror = function() {
                            reject(new Error('Failed to read file'));
                            window._lastDroppedFile = null;
                        };
                        reader.readAsDataURL(file);
                    });
                };
                
                // Escape key handler for login cancellation
                window.loginEscapeHandler = null;
                window.setupLoginEscapeHandler = function(dotNetRef) {
                    if (window.loginEscapeHandler) {
                        document.removeEventListener('keydown', window.loginEscapeHandler);
                    }
                    window.loginEscapeHandler = function(e) {
                        if (e.key === 'Escape') {
                            dotNetRef.invokeMethodAsync('CancelLoginFromJs');
                        }
                    };
                    document.addEventListener('keydown', window.loginEscapeHandler);
                };
                window.removeLoginEscapeHandler = function() {
                    if (window.loginEscapeHandler) {
                        document.removeEventListener('keydown', window.loginEscapeHandler);
                        window.loginEscapeHandler = null;
                    }
                };
            ");
        }
    }
    
    private async Task StartSplitterDrag(MouseEventArgs e)
    {
        // Initialize splitter drag via JavaScript
        await JS.InvokeVoidAsync("initSplitterDrag", "splitContainer", "leftPane", "splitter");
    }

    #endregion

    #region Service Settings Dialog
    
    private void ShowServiceSettings() => _showServiceSettingsDialog = true;
    
    private void ShowServiceSettingsFromLogin()
    {
        // Cancel any ongoing login first
        Cancel();
        // Then show settings
        _showServiceSettingsDialog = true;
    }
    
    private async Task HandleServiceSettingsSaved(AzureOpenAISettings settings)
    {
        _serviceSettings = settings;
        // Settings are automatically saved to localStorage by the dialog
        // The app would need to restart or refresh services to use new settings
        StateHasChanged();
    }
    
    protected override async Task OnInitializedAsync()
    {
        // Start with settings from appsettings.json (injected via IOptions)
        _serviceSettings = new AzureOpenAISettings
        {
            SubscriptionId = AppSettings.Value.SubscriptionId,
            ResourceGroup = AppSettings.Value.ResourceGroup,
            AccountName = AppSettings.Value.AccountName,
            Endpoint = AppSettings.Value.Endpoint,
            DefaultDeployment = AppSettings.Value.DefaultDeployment,
            ImageDeployment = AppSettings.Value.ImageDeployment,
            VisionDeployment = AppSettings.Value.VisionDeployment,
            VisionEndpoint = AppSettings.Value.VisionEndpoint,
            VisionKey = AppSettings.Value.VisionKey,
            DocumentIntelligenceEndpoint = AppSettings.Value.DocumentIntelligenceEndpoint,
            DocumentIntelligenceKey = AppSettings.Value.DocumentIntelligenceKey,
            CustomVisionEndpoint = AppSettings.Value.CustomVisionEndpoint,
            CustomVisionKey = AppSettings.Value.CustomVisionKey,
            CustomVisionProjectId = AppSettings.Value.CustomVisionProjectId,
            VideoIndexerAccountId = AppSettings.Value.VideoIndexerAccountId,
            VideoIndexerLocation = AppSettings.Value.VideoIndexerLocation,
            VideoIndexerApiKey = AppSettings.Value.VideoIndexerApiKey,
            DalleDeployment = AppSettings.Value.DalleDeployment
        };
        
        // Then merge any localStorage overrides (user customizations)
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "AzureAISettings");
            if (!string.IsNullOrEmpty(json))
            {
                var saved = System.Text.Json.JsonSerializer.Deserialize<AzureOpenAISettings>(json);
                if (saved != null)
                {
                    // Only override with localStorage values if they are not placeholder values
                    MergeLocalStorageSettings(saved);
                }
            }
        }
        catch
        {
            // Use appsettings.json values if localStorage fails
        }
    }
    
    private void MergeLocalStorageSettings(AzureOpenAISettings saved)
    {
        // Only override with saved values that are not empty/placeholder
        if (!string.IsNullOrEmpty(saved.Endpoint) && !saved.Endpoint.Contains("YOUR-"))
            _serviceSettings.Endpoint = saved.Endpoint;
        if (!string.IsNullOrEmpty(saved.SubscriptionId) && !saved.SubscriptionId.Contains("YOUR-"))
            _serviceSettings.SubscriptionId = saved.SubscriptionId;
        if (!string.IsNullOrEmpty(saved.ResourceGroup) && !saved.ResourceGroup.Contains("YOUR-"))
            _serviceSettings.ResourceGroup = saved.ResourceGroup;
        if (!string.IsNullOrEmpty(saved.AccountName) && !saved.AccountName.Contains("YOUR-"))
            _serviceSettings.AccountName = saved.AccountName;
        if (!string.IsNullOrEmpty(saved.DefaultDeployment))
            _serviceSettings.DefaultDeployment = saved.DefaultDeployment;
        if (!string.IsNullOrEmpty(saved.VisionDeployment))
            _serviceSettings.VisionDeployment = saved.VisionDeployment;
        if (!string.IsNullOrEmpty(saved.ImageDeployment))
            _serviceSettings.ImageDeployment = saved.ImageDeployment;
        if (!string.IsNullOrEmpty(saved.DalleDeployment))
            _serviceSettings.DalleDeployment = saved.DalleDeployment;
        if (!string.IsNullOrEmpty(saved.VisionEndpoint) && !saved.VisionEndpoint.Contains("YOUR-"))
            _serviceSettings.VisionEndpoint = saved.VisionEndpoint;
        if (!string.IsNullOrEmpty(saved.VisionKey) && !saved.VisionKey.Contains("YOUR-"))
            _serviceSettings.VisionKey = saved.VisionKey;
        if (!string.IsNullOrEmpty(saved.DocumentIntelligenceEndpoint) && !saved.DocumentIntelligenceEndpoint.Contains("YOUR-"))
            _serviceSettings.DocumentIntelligenceEndpoint = saved.DocumentIntelligenceEndpoint;
        if (!string.IsNullOrEmpty(saved.DocumentIntelligenceKey) && !saved.DocumentIntelligenceKey.Contains("YOUR-"))
            _serviceSettings.DocumentIntelligenceKey = saved.DocumentIntelligenceKey;
        if (!string.IsNullOrEmpty(saved.CustomVisionEndpoint) && !saved.CustomVisionEndpoint.Contains("YOUR-"))
            _serviceSettings.CustomVisionEndpoint = saved.CustomVisionEndpoint;
        if (!string.IsNullOrEmpty(saved.CustomVisionKey) && !saved.CustomVisionKey.Contains("YOUR-"))
            _serviceSettings.CustomVisionKey = saved.CustomVisionKey;
        if (!string.IsNullOrEmpty(saved.CustomVisionProjectId) && !saved.CustomVisionProjectId.Contains("YOUR-"))
            _serviceSettings.CustomVisionProjectId = saved.CustomVisionProjectId;
        if (!string.IsNullOrEmpty(saved.VideoIndexerAccountId) && !saved.VideoIndexerAccountId.Contains("YOUR-"))
            _serviceSettings.VideoIndexerAccountId = saved.VideoIndexerAccountId;
        if (!string.IsNullOrEmpty(saved.VideoIndexerLocation))
            _serviceSettings.VideoIndexerLocation = saved.VideoIndexerLocation;
        if (!string.IsNullOrEmpty(saved.VideoIndexerApiKey) && !saved.VideoIndexerApiKey.Contains("YOUR-"))
            _serviceSettings.VideoIndexerApiKey = saved.VideoIndexerApiKey;
    }

    #endregion
    
    #region Analysis Result Formatting Helpers
    
    private string FormatTableResult(TableExtractionResult result)
    {
        if (result.Headers == null || result.Rows == null) return "No table data found";
        
        var sb = new StringBuilder();
        sb.AppendLine($"Table: {result.RowCount} rows × {result.ColumnCount} columns\n");
        sb.AppendLine("Headers: " + string.Join(" | ", result.Headers));
        sb.AppendLine(new string('-', 50));
        foreach (var row in result.Rows)
        {
            sb.AppendLine(string.Join(" | ", row));
        }
        return sb.ToString();
    }
    
    private string FormatDocumentFields(DocumentParseResult result)
    {
        if (result.Fields == null) return "No fields extracted";
        
        var sb = new StringBuilder();
        foreach (var field in result.Fields)
        {
            sb.AppendLine($"• {field.Key}: {field.Value}");
        }
        return sb.ToString();
    }
    
    private string FormatInvoiceResult(InvoiceResult result)
    {
        var sb = new StringBuilder();
        sb.AppendLine("📄 INVOICE DETAILS\n");
        if (!string.IsNullOrEmpty(result.VendorName)) sb.AppendLine($"Vendor: {result.VendorName}");
        if (!string.IsNullOrEmpty(result.CustomerName)) sb.AppendLine($"Customer: {result.CustomerName}");
        if (!string.IsNullOrEmpty(result.InvoiceId)) sb.AppendLine($"Invoice #: {result.InvoiceId}");
        if (result.InvoiceDate.HasValue) sb.AppendLine($"Date: {result.InvoiceDate:d}");
        if (result.DueDate.HasValue) sb.AppendLine($"Due Date: {result.DueDate:d}");
        sb.AppendLine();
        if (result.SubTotal.HasValue) sb.AppendLine($"Subtotal: {result.SubTotal:C}");
        if (result.TotalTax.HasValue) sb.AppendLine($"Tax: {result.TotalTax:C}");
        if (result.Total.HasValue) sb.AppendLine($"TOTAL: {result.Total:C}");
        return sb.ToString();
    }
    
    private string FormatReceiptResult(ReceiptResult result)
    {
        var sb = new StringBuilder();
        sb.AppendLine("🧾 RECEIPT DETAILS\n");
        if (!string.IsNullOrEmpty(result.MerchantName)) sb.AppendLine($"Merchant: {result.MerchantName}");
        if (!string.IsNullOrEmpty(result.MerchantAddress)) sb.AppendLine($"Address: {result.MerchantAddress}");
        if (result.TransactionDate.HasValue) sb.AppendLine($"Date: {result.TransactionDate:g}");
        sb.AppendLine();
        if (result.SubTotal.HasValue) sb.AppendLine($"Subtotal: {result.SubTotal:C}");
        if (result.Tax.HasValue) sb.AppendLine($"Tax: {result.Tax:C}");
        if (result.Tip.HasValue) sb.AppendLine($"Tip: {result.Tip:C}");
        if (result.Total.HasValue) sb.AppendLine($"TOTAL: {result.Total:C}");
        return sb.ToString();
    }
    
    private string FormatChartResult(ChartDataResult result)
    {
        var sb = new StringBuilder();
        sb.AppendLine($"📈 Chart Type: {result.ChartType}");
        if (!string.IsNullOrEmpty(result.Title)) sb.AppendLine($"Title: {result.Title}");
        if (result.Labels?.Any() == true) sb.AppendLine($"Labels: {string.Join(", ", result.Labels)}");
        if (result.Series?.Any() == true)
        {
            sb.AppendLine("\nData Series:");
            foreach (var series in result.Series)
            {
                sb.AppendLine($"  {series.Name}: [{string.Join(", ", series.Values ?? new List<double>())}]");
            }
        }
        return sb.ToString();
    }
    
    private string FormatObjectDetectionResult(AzureVisionResult result)
    {
        if (result.Regions == null || !result.Regions.Any()) return "No objects detected";
        
        var sb = new StringBuilder();
        sb.AppendLine($"Detected {result.Regions.Count} objects:\n");
        foreach (var obj in result.Regions)
        {
            sb.AppendLine($"• {obj.Caption ?? obj.RegionType ?? "Object"} ({obj.Confidence:P0}) at [{obj.X}, {obj.Y}] {obj.Width}×{obj.Height}");
        }
        return sb.ToString();
    }
    
    private string FormatFaceDetectionResult(FaceDetectionResult result)
    {
        if (result.Faces == null || !result.Faces.Any()) return "No faces detected";
        
        var sb = new StringBuilder();
        sb.AppendLine($"Detected {result.Faces.Count} faces:\n");
        int i = 1;
        foreach (var face in result.Faces)
        {
            sb.AppendLine($"Face {i++}:");
            if (face.Age > 0) sb.AppendLine($"  Age: ~{face.Age}");
            if (!string.IsNullOrEmpty(face.Gender)) sb.AppendLine($"  Gender: {face.Gender}");
            sb.AppendLine($"  Location: [{face.X}, {face.Y}] {face.Width}×{face.Height}");
        }
        return sb.ToString();
    }
    
    private string FormatBrandDetectionResult(BrandDetectionResult result)
    {
        if (result.Brands == null || !result.Brands.Any()) return "No brands/logos detected";
        
        var sb = new StringBuilder();
        sb.AppendLine($"Detected {result.Brands.Count} brands:\n");
        foreach (var brand in result.Brands)
        {
            sb.AppendLine($"• {brand.Name} ({brand.Confidence:P0}) at [{brand.X}, {brand.Y}]");
        }
        return sb.ToString();
    }
    
    #endregion
}