@page "/"
@using AzureLogin.Shared.Services
@using System.Text
@using System.Text.Json
@using Microsoft.Extensions.Options
@inject IAzureOpenAIService AzureOpenAI
@inject IImageToCodeService ImageToCode
@inject IVisionService VisionService
@inject IImageExtractionService ImageExtraction
@inject IAzureVisionService? AzureVision
@inject IAdvancedAIService? AdvancedAI
@inject IUrlLauncher UrlLauncher
@inject IJSRuntime JS
@inject IOptions<AzureOpenAISettings> AppSettings

<PageTitle>Azure OpenAI</PageTitle>

<style>
    .app-container {
        min-height: 100vh;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
        padding: 1rem;
    }
    
    .glass-card {
        background: #ffffff;
        border: 1px solid #e2e4e8;
        transition: box-shadow 0.2s ease;
    }
    
    .glass-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
    }
    
    /* Drag and drop upload zone styles */
    .upload-zone {
        transition: all 0.2s ease;
    }
    
    .upload-zone.drag-over {
        border-color: #38ef7d !important;
        background: #f0fff4 !important;
        transform: scale(1.02);
        box-shadow: 0 8px 25px rgba(56, 239, 125, 0.3);
    }
    
    .gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .gradient-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }
    
    .gradient-pink {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .btn-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        transition: all 0.2s ease;
    }
    
    .btn-gradient:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-gradient:disabled {
        opacity: 0.6;
    }
    
    .btn-gradient-pink {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .btn-gradient-pink:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        border: none;
        color: white !important;
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        color: white !important;
    }
    
    .icon-circle {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
        margin: 0 auto 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    /* Premium Toolbar Navigation - Dark Gray/Purple Theme */
    .toolbar-container {
        background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
        border-radius: 14px;
        padding: 5px;
        box-shadow: 0 4px 15px rgba(55, 65, 81, 0.3);
        margin-bottom: 16px;
        border: 1px solid #4b5563;
    }
    
    .toolbar-inner {
        display: flex;
        gap: 4px;
        background: rgba(0, 0, 0, 0.15);
        border-radius: 10px;
        padding: 4px;
    }
    
    .tab-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px 20px;
        border-radius: 8px;
        border: none;
        background: transparent;
        color: rgba(255, 255, 255, 0.75);
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    
    .tab-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, transparent 100%);
        opacity: 0;
        transition: opacity 0.25s ease;
    }
    
    .tab-btn:hover:not(.active) {
        color: white;
        background: rgba(255, 255, 255, 0.1);
    }
    
    .tab-btn:hover:not(.active)::before {
        opacity: 1;
    }
    
    .tab-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .tab-btn .tab-icon {
        font-size: 1.2rem;
        line-height: 1;
    }
    
    .tab-btn .tab-label {
        font-weight: 600;
        letter-spacing: -0.3px;
    }
    
    .tab-btn .tab-badge {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        padding: 2px 8px;
        border-radius: 5px;
        font-size: 0.65rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .tab-btn.active .tab-badge {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }
    
    .extraction-mode-btn:hover {
        background: #f0f4ff !important;
        border-color: #667eea !important;
    }
    
    .extraction-mode-btn:active {
        transform: scale(0.98);
        background: #e0e7ff !important;
    }
    
    /* Draggable Splitter Styles */
    .split-container {
        display: flex;
        flex-direction: row;
        height: 100%;
        min-height: 900px;
        gap: 0;
        width: 100%;
    }
    
    .split-pane-left {
        overflow: auto;
        min-width: 280px;
        max-width: 50%;
        height: 100%;
        flex-shrink: 0;
    }
    
    .split-pane-right {
        flex: 1;
        overflow: hidden;
        min-width: 400px;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .split-pane-right > * {
        flex: 1;
        min-height: 0;
    }
    
    .split-pane-right .code-output-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
        min-height: 0;
        overflow: hidden;
    }
    
    .code-view-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        overflow: hidden;
    }
    
    .code-split-view {
        flex: 1;
        display: flex;
        gap: 10px;
        min-height: 0;
        overflow: hidden;
    }
    
    .code-panel, .preview-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        min-width: 0;
        overflow: hidden;
    }
    
    .code-panel-content, .preview-panel-content {
        flex: 1;
        min-height: 0;
        overflow: auto;
        position: relative;
    }
    
    .preview-iframe-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    
    .preview-iframe-container iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    
    .vertical-splitter {
        width: 8px;
        background: linear-gradient(180deg, #e5e7eb 0%, #d1d5db 50%, #e5e7eb 100%);
        cursor: col-resize;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        border-radius: 4px;
        margin: 0 2px;
        height: 100%;
    }
    
    .vertical-splitter:hover {
        background: linear-gradient(180deg, #667eea 0%, #764ba2 50%, #667eea 100%);
    }
    
    .vertical-splitter:active {
        background: linear-gradient(180deg, #5a67d8 0%, #6b46c1 50%, #5a67d8 100%);
    }
    
    .vertical-splitter::before {
        content: "⋮";
        color: #9ca3af;
        font-size: 14px;
        font-weight: bold;
    }
    
    .vertical-splitter:hover::before {
        color: white;
    }
    
    /* Responsive adjustments */
    @@media (max-width: 992px) {
        .split-container {
            flex-direction: column;
            height: auto;
            min-height: auto;
        }
        
        .split-pane-left {
            width: 100% !important;
            max-width: 100%;
            min-width: auto;
            height: auto;
            min-height: 300px;
        }
        
        .split-pane-right {
            width: 100%;
            min-width: auto;
            height: auto;
            min-height: 400px;
        }
        
        .vertical-splitter {
            display: none;
        }
    }
    
    .form-control-modern {
        border-radius: 8px;
        border: 1px solid #d1d5db;
        padding: 10px 14px;
        transition: all 0.2s ease;
        font-size: 14px;
        background: #fff;
    }
    
    .form-control-modern:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        outline: none;
    }
    
    .response-box {
        background: #f9fafb;
        border-radius: 8px;
        border-left: 3px solid #667eea;
        padding: 16px;
        margin-top: 16px;
    }
    
    .image-result {
        animation: fadeIn 0.3s ease;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .user-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 14px 18px;
        border-radius: 10px;
    }
    
    .code-display {
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid #e2e4e8;
        padding: 16px;
    }
    
    .code-text {
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-size: 1.4rem;
        font-weight: 600;
        color: #374151;
        letter-spacing: 3px;
    }
    
    .section-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: #667eea;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
    }
    
    .generated-image {
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .code-output-panel {
        background: linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        min-height: 650px;
    }
    
    .code-pre {
        background: #1e293b;
        border-radius: 10px;
        color: #e2e8f0;
        font-family: 'SF Mono', 'Fira Code', monospace;
        font-size: 12px;
        line-height: 1.6;
        max-height: 550px;
        overflow: auto;
    }
    
    .analysis-action-btn {
        position: relative;
        overflow: hidden;
    }
    
    .analysis-action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s ease;
    }
    
    .analysis-action-btn:hover::before {
        left: 100%;
    }
    
    .analysis-action-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5) !important;
    }
    
    .analysis-action-btn:active:not(:disabled) {
        transform: translateY(0);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4) !important;
    }
    
    .analysis-action-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%) !important;
        box-shadow: none !important;
    }
    
    /* Premium Action Button Styles */
    .premium-action-btn {
        position: relative;
        overflow: hidden;
    }
    
    .premium-action-btn .btn-shimmer {
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
        transition: left 0.6s ease;
    }
    
    .premium-action-btn:hover:not(:disabled) .btn-shimmer {
        left: 100%;
    }
    
    .premium-action-btn:hover:not(:disabled) {
        transform: translateY(-3px) scale(1.01);
        box-shadow: 0 10px 35px rgba(102, 126, 234, 0.5), 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
    }
    
    .premium-action-btn:active:not(:disabled) {
        transform: translateY(-1px) scale(1);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4) !important;
    }
    
    .premium-action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%) !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
    }
    
    .premium-action-btn.processing {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%) !important;
    }
    
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Analysis Select Styling - Enhanced for visibility */
    .analysis-select {
        border: 2px solid #e0e7ff;
        transition: all 0.2s ease;
        font-size: 1rem !important;
        padding: 12px 14px !important;
        line-height: 1.5;
        min-height: 52px;
    }
    
    .analysis-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
    }
    
    .analysis-select optgroup {
        font-weight: 800 !important;
        font-size: 0.95rem !important;
        color: #ffffff !important;
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%) !important;
        padding: 12px 10px !important;
        margin-top: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .analysis-select option {
        font-weight: 500;
        font-size: 0.95rem !important;
        color: #1f2937;
        padding: 12px 16px !important;
        line-height: 1.6;
        background: #ffffff;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .analysis-select option:hover {
        background: #f0f4ff !important;
    }
    
    .analysis-select option:checked {
        background: linear-gradient(135deg, #ede9fe 0%, #fae8ff 100%) !important;
        font-weight: 600;
    }
    
    /* API Detail Card Animation */
    .api-detail-card {
        transition: all 0.3s ease;
    }
    
    .api-detail-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
</style>

@* Inline script fallback for clipboard *@
<script suppress-error="BL9992">
    if (!window.copyToClipboard) {
        window.copyToClipboard = function(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "0";
            textArea.style.top = "0";
            textArea.style.opacity = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            var success = false;
            try { success = document.execCommand('copy'); } catch(e) {}
            document.body.removeChild(textArea);
            return success;
        };
    }
</script>

<div class="app-container">
    <div class="container-fluid" style="max-width: 1400px; margin: 0 auto;">
        
        @switch (_state)
        {
            case AppState.NotSignedIn:
                <div class="card glass-card border-0 shadow-lg" style="border-radius: 24px; overflow: hidden;">
                    <div class="card-body text-center py-5 px-4 gradient-primary">
                        <div class="icon-circle">
                            🤖
                        </div>
                        <h1 class="mb-3 text-white fw-bold" style="font-size: 2.2rem;">Azure OpenAI</h1>
                        <p class="mb-4 px-3" style="color: rgba(255,255,255,0.9); font-size: 1.1rem;">
                            Unlock the power of AI with your Microsoft account
                        </p>
                        
                        @if (!string.IsNullOrEmpty(_error))
                        {
                            <div class="alert mb-4 mx-auto" style="background: rgba(255,255,255,0.95); border: none; border-radius: 12px; max-width: 450px; color: #c53030;">
                                <div class="mb-2"><strong>⚠️ @(_loginTimedOut ? "Login Timed Out" : "Sign In Failed")</strong></div>
                                <p class="mb-2" style="font-size: 0.95rem;">@_error</p>
                                @if (_loginTimedOut)
                                {
                                    <p class="mb-0" style="font-size: 0.85rem; color: #666;">
                                        You can try again or check your Azure settings.
                                    </p>
                                }
                            </div>
                            
                            <div class="d-flex justify-content-center gap-3 mb-4 flex-wrap">
                                <button class="btn btn-light px-4 py-2 fw-bold" 
                                        style="border-radius: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.15);" 
                                        @onclick="StartSignIn">
                                    <span style="color: #667eea;">🔄 Try Again</span>
                                </button>
                                <button class="btn btn-outline-light px-4 py-2 fw-semibold" 
                                        style="border-radius: 25px;" 
                                        @onclick="ShowServiceSettingsFromLogin">
                                    <span>⚙️ Check Settings</span>
                                </button>
                            </div>
                        }
                        else
                        {
                            <button class="btn btn-light btn-lg px-5 py-3 fw-bold" 
                                    style="border-radius: 50px; box-shadow: 0 8px 25px rgba(0,0,0,0.2); font-size: 1.1rem;" 
                                    @onclick="StartSignIn">
                                <span style="color: #667eea;">🔐 Sign In with Microsoft</span>
                            </button>
                        }
                        
                        <p class="mt-4 mb-0" style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">
                            Secure authentication via Azure AD
                        </p>
                        
                        @* Settings shortcut *@
                        <button class="btn btn-link mt-2" style="color: rgba(255,255,255,0.6); text-decoration: none; font-size: 0.85rem;" 
                                @onclick="ShowServiceSettingsFromLogin">
                            ⚙️ Configure Service Settings
                        </button>
                    </div>
                </div>
                break;
                
            case AppState.SigningIn:
                <div class="card glass-card border-0 shadow-lg" style="border-radius: 24px;">
                    <div class="card-body py-5 px-4">
                        <div class="text-center mb-4">
                            <div style="font-size: 48px; margin-bottom: 16px;">🔑</div>
                            <h3 class="fw-bold" style="color: #333;">Sign in to Azure</h3>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(_userCode))
                        {
                            <div class="code-display mb-4">
                                <p class="section-title mb-3">Your sign-in code</p>
                                <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                                    <code class="code-text user-select-all" id="deviceCode" style="font-size: 1.5rem; letter-spacing: 2px; font-weight: bold;">@_userCode</code>
                                    <button class="btn btn-gradient px-4 py-2" style="border-radius: 10px;" @onclick="CopyCodeManual">
                                        @(_copied ? "✓ Copied!" : "📋 Copy Code")
                                    </button>
                                </div>
                            </div>
                            
                            <button class="btn btn-gradient w-100 py-3 fw-semibold mb-4" 
                                    style="border-radius: 14px; font-size: 1.1rem;" 
                                    @onclick="OpenLoginPopup">
                                🔗 Open Sign-In Window
                            </button>
                            
                            <div class="mb-4 p-3" style="background: #f8f9fa; border-radius: 12px;">
                                <p class="section-title">How to sign in</p>
                                <ol class="mb-0 ps-3" style="color: #666; line-height: 1.8;">
                                    <li>Copy the code above</li>
                                    <li>Click "Open Sign-In Window"</li>
                                    <li>Paste the code and sign in with your Microsoft account</li>
                                </ol>
                            </div>
                            
                            <div class="text-center py-3" style="border-top: 1px solid #eee;">
                                <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
                                    <div class="spinner-border spinner-border-sm" style="color: #667eea;"></div>
                                    <span style="color: #888;">Waiting for authentication...</span>
                                </div>
                                
                                @* Timeout countdown *@
                                <div class="mb-3 p-2" style="background: @(_remainingSeconds <= 30 ? "#fff3cd" : "#f0f4ff"); border-radius: 8px;">
                                    <span style="color: @(_remainingSeconds <= 30 ? "#856404" : "#667eea"); font-weight: 500;">
                                        ⏱️ Time remaining: @TimeSpan.FromSeconds(_remainingSeconds).ToString(@"m\:ss")
                                    </span>
                                    @if (_remainingSeconds <= 30)
                                    {
                                        <br/>
                                        <small style="color: #856404;">Login will timeout soon. Press Cancel or Esc to exit.</small>
                                    }
                                </div>
                                
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-outline-secondary" style="border-radius: 10px;" @onclick="Cancel">
                                        ❌ Cancel (Esc)
                                    </button>
                                    <button class="btn btn-outline-primary" style="border-radius: 10px;" @onclick="ShowServiceSettingsFromLogin">
                                        ⚙️ Settings
                                    </button>
                                </div>
                                <small class="d-block mt-2" style="color: #aaa;">Press Esc key to cancel and return to settings</small>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <div class="spinner-border mb-3" style="color: #667eea; width: 3rem; height: 3rem;"></div>
                                <p style="color: #888; font-size: 1.1rem;">Preparing secure sign-in...</p>
                                <p style="color: #aaa; font-size: 0.9rem;">Press Esc or click Cancel to exit</p>
                                <button class="btn btn-outline-secondary mt-3" style="border-radius: 10px;" @onclick="Cancel">
                                    ❌ Cancel
                                </button>
                            </div>
                        }
                    </div>
                </div>
                break;
                
            case AppState.SignedIn:
                <div class="card glass-card border-0 shadow-sm mb-3" style="border-radius: 12px; overflow: hidden;">
                    <div class="user-badge">
                        <div class="d-flex justify-content-between align-items-center position-relative">
                            <div class="d-flex align-items-center gap-3">
                                <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                                    👤
                                </div>
                                <div>
                                    <h5 class="mb-0 text-white fw-bold">@_userName</h5>
                                    <small style="color: rgba(255,255,255,0.85);">Connected to @AzureOpenAI.DeploymentName</small>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-light btn-sm fw-semibold" style="border-radius: 10px; padding: 8px 16px;" @onclick="ShowServiceSettings" title="Service Settings">
                                    ⚙️ Settings
                                </button>
                                <button class="btn btn-light btn-sm fw-semibold" style="border-radius: 10px; padding: 8px 16px;" @onclick="SignOut">
                                    Sign Out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                @* Premium Toolbar Navigation *@
                <div class="toolbar-container">
                    <div class="toolbar-inner">
                        <button class="tab-btn @(_activeTab == "chat" ? "active" : "")" @onclick="SetChatTab">
                            <span class="tab-icon">💬</span>
                            <span class="tab-label">Chat</span>
                            <span class="tab-badge">GPT-4o</span>
                        </button>
                        <button class="tab-btn @(_activeTab == "image" ? "active" : "")" @onclick="SetImageTab">
                            <span class="tab-icon">🎨</span>
                            <span class="tab-label">Image Studio</span>
                            <span class="tab-badge">DALL-E</span>
                        </button>
                        <button class="tab-btn @(_activeTab == "code" ? "active" : "")" @onclick="SetCodeTab">
                            <span class="tab-icon">✨</span>
                            <span class="tab-label">Vision AI</span>
                            <span class="tab-badge">64 APIs</span>
                        </button>
                    </div>
                </div>
                
                @if (_activeTab == "chat")
                {
                    <div class="card glass-card border-0 shadow-sm" style="border-radius: 12px;">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <span style="font-size: 20px;">💬</span>
                                <h5 class="mb-0 fw-semibold" style="color: #374151;">Chat with GPT-4o</h5>
                            </div>
                            
                            <textarea class="form-control form-control-modern mb-3" rows="4" @bind="_message" 
                                      placeholder="Ask me anything... I'm here to help!" disabled="@_sending"></textarea>
                            
                            <button class="btn btn-gradient w-100 py-2 fw-medium" style="border-radius: 8px;" 
                                    @onclick="SendMessage" 
                                    disabled="@(_sending || string.IsNullOrWhiteSpace(_message))">
                                @if (_sending)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Processing...</span>
                                }
                                else
                                {
                                    <span>Send Message</span>
                                }
                            </button>
                            
                            @if (!string.IsNullOrEmpty(_response))
                            {
                                <div class="response-box">
                                    <p class="section-title">Response</p>
                                    <div style="white-space: pre-wrap; color: #333; line-height: 1.7;">@_response</div>
                                </div>
                            }
                            
                            @if (!string.IsNullOrEmpty(_chatError))
                            {
                                <div class="alert mt-4 mb-0" style="background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; border-radius: 12px;">
                                    <strong>⚠️ Error:</strong> @_chatError
                                </div>
                            }
                        </div>
                    </div>
                }
                else if (_activeTab == "image")
                {
                    <div class="card glass-card border-0 shadow-sm" style="border-radius: 12px;">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center gap-2 mb-3">
                                <span style="font-size: 22px;">🎨</span>
                                <h5 class="mb-0 fw-semibold" style="color: #374151;">Image Studio</h5>
                                <span class="badge ms-auto" style="background: #6b7280; font-weight: 500; padding: 6px 12px; font-size: 0.75rem;">gpt-image-1.5</span>
                            </div>
                            
                            @* Two Pane Layout *@
                            <div class="row g-3">
                                @* Left Pane - Input/Upload *@
                                <div class="col-lg-6">
                                    <div class="h-100 p-4" style="background: #f9fafb; border-radius: 10px; border: 1px solid #e5e7eb;">
                                        <h6 class="fw-semibold mb-3" style="color: #4b5563;">
                                            <span class="me-2">📝</span>Create New Image
                                        </h6>
                                        
                                        <textarea class="form-control form-control-modern mb-3" rows="5" @bind="_imagePrompt" 
                                                  placeholder="Describe the image you want to create in detail... Be creative and specific!" 
                                                  disabled="@_generatingImage"
                                                  style="resize: none;"></textarea>
                                        
                                        <div class="mb-3">
                                            <label class="section-title">Image Size</label>
                                            <select class="form-select form-control-modern" @bind="_imageSize">
                                                <option value="1024x1024">📐 Square (1024×1024)</option>
                                                <option value="1792x1024">🖼️ Landscape (1792×1024)</option>
                                                <option value="1024x1792">📱 Portrait (1024×1792)</option>
                                            </select>
                                        </div>
                                        
                                        <button class="btn btn-gradient w-100 py-2 fw-medium mb-3" 
                                                style="border-radius: 8px;" 
                                                @onclick="GenerateImage" 
                                                disabled="@(_generatingImage || string.IsNullOrWhiteSpace(_imagePrompt))">
                                            @if (_generatingImage)
                                            {
                                                <span class="spinner-border spinner-border-sm me-2"></span>
                                                <span>Creating...</span>
                                            }
                                            else
                                            {
                                                <span>Generate Image</span>
                                            }
                                        </button>
                                        
                                        <hr style="border-color: #e5e7eb; margin: 1rem 0;" />
                                        
                                        <h6 class="fw-semibold mb-3" style="color: #4b5563;">
                                            <span class="me-2">📤</span>Upload Reference Image
                                        </h6>
                                        
                                        <div class="upload-zone p-3 text-center" 
                                             style="border: 2px dashed #d1d5db; border-radius: 10px; background: #fafafa; cursor: pointer;"
                                             @onclick="TriggerFileUpload">
                                            @if (string.IsNullOrEmpty(_uploadedImageUrl))
                                            {
                                                <div style="color: #6b7280;">
                                                    <span style="font-size: 36px; display: block; margin-bottom: 8px;">🖼️</span>
                                                    <p class="mb-1 fw-medium">Click to upload an image</p>
                                                    <p class="mb-0 small text-muted">PNG, JPG up to 10MB</p>
                                                </div>
                                            }
                                            else
                                            {
                                                <img src="@_uploadedImageUrl" alt="Uploaded" 
                                                     style="max-width: 100%; max-height: 200px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);" />
                                                <p class="mt-2 mb-0 small text-muted">Click to change image</p>
                                            }
                                        </div>
                                        
                                        <InputFile id="imageUpload" accept="image/*" style="display: none;" OnChange="HandleFileUploadNew" />
                                        
                                        @if (!string.IsNullOrEmpty(_uploadedImageUrl))
                                        {
                                            <button class="btn btn-outline-danger w-100 mt-3" style="border-radius: 10px;" @onclick="ClearUploadedImage">
                                                🗑️ Remove Uploaded Image
                                            </button>
                                        }
                                    </div>
                                </div>
                                
                                @* Right Pane - Preview/Output *@
                                <div class="col-lg-6">
                                    <div class="h-100 p-4" style="background: #f9fafb; border-radius: 10px; border: 1px solid #e5e7eb;">
                                        <h6 class="fw-semibold mb-3" style="color: #4b5563;">
                                            <span class="me-2">🖼️</span>Generated Result
                                        </h6>
                                        
                                        @if (_generatingImage)
                                        {
                                            <div class="text-center py-5" style="min-height: 350px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: #6b7280;"></div>
                                                <p class="fw-medium" style="color: #4b5563;">Creating your image...</p>
                                                <p class="small text-muted">This may take a moment</p>
                                            </div>
                                        }
                                        else if (!string.IsNullOrEmpty(_generatedImageUrl))
                                        {
                                            <div class="image-result">
                                                <div class="text-center p-3" style="background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08);">
                                                    <img src="@_generatedImageUrl" alt="Generated Image" class="generated-image" 
                                                         style="max-width: 100%; max-height: 500px; width: auto; height: auto;" />
                                                </div>
                                                
                                                <div class="d-flex gap-2 mt-3">
                                                    <button class="btn btn-gradient flex-fill py-2 fw-medium" style="border-radius: 8px;" @onclick="DownloadImage">
                                                        💾 Download
                                                    </button>
                                                    <button class="btn btn-outline-secondary flex-fill py-2 fw-medium" style="border-radius: 8px;" @onclick="ClearGeneratedImage">
                                                        🔄 New
                                                    </button>
                                                </div>
                                                
                                                @if (!string.IsNullOrEmpty(_revisedPrompt))
                                                {
                                                    <div class="mt-3 p-3" style="background: white; border-radius: 8px; border-left: 3px solid #6b7280;">
                                                        <p class="section-title mb-1">AI Enhanced Prompt</p>
                                                        <p class="mb-0" style="color: #4b5563; font-size: 0.85rem; font-style: italic;">@_revisedPrompt</p>
                                                    </div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="text-center py-5" style="min-height: 350px; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                <div style="width: 80px; height: 80px; background: #e5e7eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px;">
                                                    <span style="font-size: 32px;">🎨</span>
                                                </div>
                                                <p class="fw-medium mb-2" style="color: #6b7280;">No image generated yet</p>
                                                <p class="small text-muted px-4">Enter a description and click "Generate Image"</p>
                                            </div>
                                        }
                                        
                                        @if (!string.IsNullOrEmpty(_imageError))
                                        {
                                            <div class="alert mt-3 mb-0" style="background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; border-radius: 12px;">
                                                <strong>⚠️ Error:</strong> @_imageError
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
                else if (_activeTab == "code")
                {
                    <div class="card glass-card border-0 shadow-sm" style="border-radius: 12px; height: calc(100vh - 220px); min-height: 800px;">
                        <div class="card-body p-3" style="height: 100%; display: flex; flex-direction: column; overflow: hidden;">
                            @* Premium Header Banner - Compact *@
                            <div class="vision-header-banner" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ec4899 100%); color: white; padding: 12px 16px; border-radius: 10px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25);">
                                <div class="d-flex align-items-center gap-3">
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 10px 12px; backdrop-filter: blur(10px);">
                                        <span style="font-size: 1.5rem;">🧠</span>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.1rem; font-weight: 700; letter-spacing: -0.5px;">Vision Analysis Studio</div>
                                        <div style="font-size: 0.75rem; opacity: 0.9;">Powered by Azure OpenAI GPT-4o & Azure AI Vision 4.0</div>
                                    </div>
                                </div>
                                <button type="button" class="btn" style="background: rgba(255,255,255,0.95); color: #667eea; border: none; border-radius: 10px; padding: 8px 16px; font-weight: 700; font-size: 0.8rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 6px;" @onclick="ShowApiCoverage">
                                    <span style="font-size: 1rem;">📊</span>
                                    <span>64 APIs</span>
                                    <span class="badge" style="background: linear-gradient(135deg, #10b981, #059669); color: white; font-size: 0.65rem; padding: 2px 6px; margin-left: 4px;">95%</span>
                                </button>
                            </div>
                            
                            @* Section Title with Gradient *@
                            <div class="d-flex align-items-center gap-3 mb-3" style="flex-shrink: 0;">
                                <div style="display: flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #f0f4ff 0%, #fdf4ff 100%); padding: 8px 14px; border-radius: 10px; border: 1px solid #e0e7ff;">
                                    <span style="font-size: 1.4rem;">🖼️</span>
                                    <span style="font-size: 1.1rem; color: #6366f1;">→</span>
                                    <span style="font-size: 1.4rem;">💻</span>
                                </div>
                                <div style="flex: 1;">
                                    <h5 class="mb-0 fw-bold" style="background: linear-gradient(135deg, #4f46e5, #7c3aed, #db2777); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-size: 1.15rem;">Image to Code & AI Analysis</h5>
                                    <div style="font-size: 0.7rem; color: #6b7280; margin-top: 2px;">Upload any UI screenshot • Generate production code • Extract assets</div>
                                </div>
                                <div class="d-flex gap-2">
                                    <span class="badge" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); font-weight: 600; padding: 6px 10px; font-size: 0.7rem; display: flex; align-items: center; gap: 4px;">
                                        <span>🤖</span> GPT-4o
                                    </span>
                                    <span class="badge" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); font-weight: 600; padding: 6px 10px; font-size: 0.7rem; display: flex; align-items: center; gap: 4px;">
                                        <span>👁️</span> Vision
                                    </span>
                                </div>
                            </div>
                            
                            <div class="split-container" id="splitContainer" style="flex: 1;">
                                @* Left Pane - Upload & Analysis Options *@
                                <div class="split-pane-left" id="leftPane" style="width: 35%;">
                                    <div class="h-100 p-3" style="background: linear-gradient(180deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 12px; border: 1px solid #e5e7eb; height: 100%; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #4f46e5; display: flex; align-items: center; gap: 8px;">
                                                <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">📤</span>
                                                Upload UI Design
                                            </h6>
                                            
                                            <div class="upload-zone p-3 text-center mb-3 @(_isDragOver ? "drag-over" : "")" 
                                                 style="border: 2px dashed @(_isDragOver ? "#38ef7d" : "#667eea"); border-radius: 10px; background: @(_isDragOver ? "#f0fff4" : "#fff"); cursor: pointer; min-height: 200px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s ease;"
                                                 @onclick="TriggerCodeImageUpload"
                                                 @ondragenter="HandleDragEnter"
                                                 @ondragenter:preventDefault
                                                 @ondragleave="HandleDragLeave"
                                                 @ondragleave:preventDefault
                                                 @ondragover="HandleDragOver"
                                                 @ondragover:preventDefault
                                                 @ondrop="HandleDrop"
                                                 @ondrop:preventDefault>
                                                @if (string.IsNullOrEmpty(_codeImageUrl))
                                                {
                                                    <div style="color: @(_isDragOver ? "#38ef7d" : "#667eea");">
                                                        <span style="font-size: 48px; display: block; margin-bottom: 10px;">@(_isDragOver ? "📥" : "🎨")</span>
                                                        <p class="mb-1 fw-medium">@(_isDragOver ? "Drop image here!" : "Click or drag & drop a UI screenshot")</p>
                                                        <p class="mb-0 small text-muted">PNG, JPG, WebP up to 20MB</p>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <img src="@_codeImageUrl" alt="Uploaded UI" 
                                                         style="max-width: 100%; max-height: 180px; border-radius: 12px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);" />
                                                }
                                            </div>
                                            
                                            <InputFile id="codeImageUpload" accept="image/*" style="display: none;" OnChange="HandleCodeImageUploadNew" />
                                        
                                        @if (!string.IsNullOrEmpty(_codeImageUrl))
                                        {
                                            <button class="btn btn-outline-danger w-100 mb-3" style="border-radius: 10px;" @onclick="ClearCodeImage">
                                                🗑️ Remove Image
                                            </button>
                                        }
                                        
                                        @* Analysis Type Selection - Enhanced with API Details *@
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <label class="section-title mb-0" style="font-size: 0.9rem;">
                                                    <span style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; font-size: 1rem;">🎯 Analysis Type</span>
                                                </label>
                                                <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.75rem; padding: 5px 10px; font-weight: 600;">64 APIs</span>
                                            </div>
                                            <select class="form-select form-control-modern analysis-select" @bind="_selectedAnalysis" style="font-size: 1rem; padding: 14px 16px; font-weight: 500;">
                                                <optgroup label="💻 CODE GENERATION — GPT-4o Vision">
                                                    <option value="code">💻 Generate Code → HTML/CSS/React/Vue/Blazor</option>
                                                    <option value="codeWithViewModel">📋 Code + ViewModel → Complete with data binding</option>
                                                </optgroup>
                                                <optgroup label="🖼️ IMAGE EXTRACTION — AI + SkiaSharp">
                                                    <option value="extractImages">🖼️ Extract All → Detect & crop all images</option>
                                                    <option value="extractIcons">🎯 Icons Only → Small graphics & symbols</option>
                                                    <option value="extractLogos">🏷️ Logos/Brands → Brand elements</option>
                                                    <option value="extractPhotos">📷 Photos Only → Photographs & images</option>
                                                    <option value="extractAvatars">👤 Avatars → Profile pictures & people</option>
                                                    <option value="extractCharts">📊 Charts → Graphs & diagrams</option>
                                                    <option value="extractBackgrounds">🖼️ Backgrounds → Background images</option>
                                                </optgroup>
                                                <optgroup label="📝 TEXT & OCR — Vision + GPT-4o">
                                                    <option value="text">📜 Extract Text → OCR all visible text</option>
                                                    <option value="handwriting">✍️ Handwriting → Transcribe handwritten text</option>
                                                    <option value="table">📊 Table Data → Extract rows & columns</option>
                                                    <option value="math">🔢 Math Equations → Convert to LaTeX</option>
                                                    <option value="denseCaptions">💬 Dense Captions → Multiple region descriptions</option>
                                                    <option value="singleCaption">📝 Single Caption → One sentence description</option>
                                                </optgroup>
                                                <optgroup label="📄 DOCUMENT INTELLIGENCE — Azure AI">
                                                    <option value="document">📄 Parse Document → Extract structured data</option>
                                                    <option value="invoice">🧾 Invoice → Vendor, items, totals</option>
                                                    <option value="receipt">🧾 Receipt → Merchant, items, total</option>
                                                    <option value="idDocument">🪪 ID Document → Name, DOB, ID number</option>
                                                    <option value="businessCard">💼 Business Card → Contact info</option>
                                                    <option value="chart">📈 Chart Data → Extract graph values</option>
                                                </optgroup>
                                                <optgroup label="🎨 DESIGN ANALYSIS — GPT-4o Vision">
                                                    <option value="describe">📝 Describe → Full UI description</option>
                                                    <option value="colors">🎨 Colors → Extract color palette</option>
                                                    <option value="typography">🔤 Typography → Fonts & text styles</option>
                                                    <option value="layout">📐 Layout → Grid, spacing, structure</option>
                                                    <option value="components">🧩 Components → UI elements & hierarchy</option>
                                                    <option value="icons">🎯 Icons → Identify icon library matches</option>
                                                    <option value="smartCrops">✂️ Smart Crops → AI crop suggestions</option>
                                                    <option value="tags">🏷️ Tags → Content categorization</option>
                                                </optgroup>
                                                <optgroup label="🔍 ADVANCED ANALYSIS — GPT-4o + Vision">
                                                    <option value="accessibility">♿ Accessibility → WCAG audit & issues</option>
                                                    <option value="improvements">💡 Improvements → UX suggestions</option>
                                                    <option value="compare">🔄 Compare 2 → Diff two images</option>
                                                    <option value="compareMultiple">🔄 Compare Multiple → Multi-image diff</option>
                                                    <option value="imageDiff">🔍 Image Diff → Highlight changes</option>
                                                    <option value="askQuestion">❓ Ask Question → Custom image Q&A</option>
                                                    <option value="spatialQuestion">📍 Spatial Q&A → "What's left of X?"</option>
                                                    <option value="comprehensive">🔬 Full Analysis → Complete UI breakdown</option>
                                                </optgroup>
                                                <optgroup label="🖼️ IMAGE PROCESSING — Azure + DALL-E">
                                                    <option value="removeBackground">🗑️ Remove Background → Transparent PNG</option>
                                                    <option value="upscale">⬆️ Upscale → 2x/4x resolution</option>
                                                    <option value="styleTransfer">🎭 Style Transfer → Apply artistic style</option>
                                                    <option value="segment">✂️ Segment → Split into regions</option>
                                                    <option value="depthMap">🗺️ Depth Map → 3D depth estimation</option>
                                                    <option value="editImage">✏️ Edit (DALL-E) → Modify image regions</option>
                                                    <option value="imageVariations">🔄 Variations (DALL-E) → Similar images</option>
                                                    <option value="generateImage">🎨 Generate (DALL-E) → Create from text</option>
                                                </optgroup>
                                                <optgroup label="👁️ AZURE VISION 4.0 — Computer Vision">
                                                    <option value="detectObjects">📦 Objects → Detect with bounding boxes</option>
                                                    <option value="detectFaces">👤 Faces → Age, gender, emotion</option>
                                                    <option value="detectPeople">🚶 People → Person detection</option>
                                                    <option value="detectBrands">🏷️ Brands → Logo recognition</option>
                                                    <option value="imageType">🖼️ Image Type → Photo/clipart/drawing</option>
                                                    <option value="adultContent">🔞 Content Check → Adult/racy/gore</option>
                                                    <option value="imageCategory">📁 Category → Scene classification</option>
                                                    <option value="analyzeComprehensive">🔬 Vision Full → All features combined</option>
                                                </optgroup>
                                                <optgroup label="🤖 CHAT & CUSTOM — GPT-4o">
                                                    <option value="chat">💬 Chat → Conversation with AI</option>
                                                    <option value="customPrompt">📝 Custom Prompt → Your own question</option>
                                                </optgroup>
                                            </select>
                                            
                                            @* API Details Card - Enhanced *@
                                            <div class="api-detail-card mt-3 p-3" style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); border-radius: 12px; border: 2px solid #e0e7ff;">
                                                <div class="d-flex align-items-start gap-3">
                                                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 12px; display: flex; align-items: center; justify-content: center;">
                                                        <span style="font-size: 1.6rem;">@GetAnalysisButtonIcon()</span>
                                                    </div>
                                                    <div style="flex: 1;">
                                                        <div class="fw-bold" style="color: #4c1d95; font-size: 1.05rem; margin-bottom: 4px;">@GetAnalysisDisplayName()</div>
                                                        <div style="color: #6b7280; font-size: 0.85rem; line-height: 1.45;">@GetAnalysisDescription()</div>
                                                        <div class="mt-2 d-flex flex-wrap gap-2">
                                                            <span class="badge" style="background: @GetServiceBadgeColor(); font-size: 0.75rem; padding: 5px 10px; font-weight: 600;">@GetServiceName()</span>
                                                            @if (IsAzureVisionRequired())
                                                            {
                                                                <span class="badge" style="background: @(AzureVision?.IsConfigured == true ? "#10b981" : "#ef4444"); font-size: 0.75rem; padding: 5px 10px; font-weight: 600;">
                                                                    @(AzureVision?.IsConfigured == true ? "✓ Vision Ready" : "⚠ Vision Required")
                                                                </span>
                                                            }
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        @* Image Extraction Options *@
                                        @if (_selectedAnalysis == "extractImages")
                                        {
                                            <div class="mb-3 p-2" style="background: #f0f4ff; border-radius: 8px; border: 1px solid #667eea;">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label class="section-title mb-0">🎯 Extraction Mode</label>
                                                    <button type="button" class="btn btn-sm" 
                                                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; padding: 4px 12px; font-size: 0.75rem;"
                                                            @onclick="ShowExtractionModeInfo">
                                                        ℹ️ Service Info
                                                    </button>
                                                </div>
                                                @{
                                                    var azureVisionAvailable = AzureVision?.IsConfigured ?? false;
                                                    var visionStatus = azureVisionAvailable ? "✅" : "❌ NA";
                                                }
                                                <select class="form-select form-control-modern form-select-sm mb-2" @bind="_cropMode">
                                                    <optgroup label="☁️ Azure AI Vision 4.0">
                                                        <option value="AzureVision">🎯 Azure Vision (Azure AI Vision API) @visionStatus</option>
                                                        <option value="AzureVisionComprehensive">🔮 Comprehensive (Azure AI Vision API) @visionStatus</option>
                                                        <option value="AzureVisionPeople">👤 People/Avatars (Azure AI Vision API) @visionStatus</option>
                                                    </optgroup>
                                                    <optgroup label="🤖 Azure OpenAI GPT-4o">
                                                        <option value="SmartDetect">🔬 Smart Detect (GPT-4o + SkiaSharp) ✅</option>
                                                        <option value="AIRegions">🤖 AI Regions (GPT-4o) ✅</option>
                                                    </optgroup>
                                                    <optgroup label="⚡ Hybrid">
                                                        <option value="HybridPixelPerfect">⚡ Hybrid Best (Vision + GPT-4o) @visionStatus</option>
                                                    </optgroup>
                                                    <optgroup label="🖼️ Local (SkiaSharp)">
                                                        <option value="SmartUICards">🃏 UI Cards ✅</option>
                                                        <option value="ContourDetection">📐 Contours ✅</option>
                                                        <option value="FloodFillRegions">🌊 Flood Fill ✅</option>
                                                        <option value="Components">🧩 Components ✅</option>
                                                        <option value="Grid">📊 Grid ✅</option>
                                                        <option value="Sections">📑 Sections ✅</option>
                                                    </optgroup>
                                                </select>
                                                @if (!azureVisionAvailable)
                                                {
                                                    <div class="small" style="color: #dc3545; margin-top: 4px;">
                                                        ⚠️ Azure Vision not configured. Set <code>VisionEndpoint</code> and <code>VisionKey</code> in appsettings.json
                                                    </div>
                                                }
                                                
                                                @if (_cropMode == "Grid")
                                                {
                                                    <div class="row g-2 mb-2">
                                                        <div class="col-6">
                                                            <label class="small text-muted">Rows</label>
                                                            <input type="number" class="form-control form-control-sm" @bind="_gridRows" min="1" max="10" />
                                                        </div>
                                                        <div class="col-6">
                                                            <label class="small text-muted">Columns</label>
                                                            <input type="number" class="form-control form-control-sm" @bind="_gridColumns" min="1" max="10" />
                                                        </div>
                                                    </div>
                                                }
                                                
                                                @if (_cropMode == "Components")
                                                {
                                                    <div class="mb-2">
                                                        <label class="small text-muted">Min Component Size (px)</label>
                                                        <input type="number" class="form-control form-control-sm" @bind="_minComponentSize" min="5" max="200" />
                                                    </div>
                                                }
                                                
                                                @if (_cropMode == "SmartDetect" || _cropMode == "AIRegions")
                                                {
                                                    <label class="section-title mb-1 mt-2">🔍 Extraction Type</label>
                                                    <select class="form-select form-control-modern form-select-sm mb-2" @bind="_extractionType">
                                                        <option value="all">📦 All Images & Graphics</option>
                                                        <option value="icons">🎯 Icons Only</option>
                                                        <option value="logos">🏷️ Logos & Branding</option>
                                                        <option value="photos">📷 Photos Only</option>
                                                        <option value="illustrations">🎨 Illustrations</option>
                                                        <option value="charts">📊 Charts & Diagrams</option>
                                                        <option value="backgrounds">🖼️ Background Images</option>
                                                        <option value="avatars">👤 Avatars & Profile Images</option>
                                                    </select>
                                                }
                                                
                                                <label class="section-title mb-1 mt-2">📐 Size Filter</label>
                                                <select class="form-select form-control-modern form-select-sm mb-2" @bind="_extractionSizeFilter">
                                                    <option value="all">All Sizes</option>
                                                    <option value="small">Small (≤64px)</option>
                                                    <option value="medium">Medium (65-256px)</option>
                                                    <option value="large">Large (>256px)</option>
                                                    <option value="custom">Custom Size Range</option>
                                                </select>
                                                
                                                @if (_extractionSizeFilter == "custom")
                                                {
                                                    <div class="row g-2 mb-2">
                                                        <div class="col-6">
                                                            <label class="small text-muted">Min (px)</label>
                                                            <input type="number" class="form-control form-control-sm" @bind="_extractionMinSize" min="1" placeholder="16" />
                                                        </div>
                                                        <div class="col-6">
                                                            <label class="small text-muted">Max (px)</label>
                                                            <input type="number" class="form-control form-control-sm" @bind="_extractionMaxSize" min="1" placeholder="1000" />
                                                        </div>
                                                    </div>
                                                }
                                                
                                                <label class="section-title mb-1 mt-2">⚙️ Options</label>
                                                @if (_cropMode == "SmartDetect")
                                                {
                                                    <div class="form-check mb-1">
                                                        <input class="form-check-input" type="checkbox" id="refineEdges" @bind="_refineWithEdgeDetection" />
                                                        <label class="form-check-label small" for="refineEdges">Refine bounds with edge detection</label>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="small text-muted">Edge Threshold</label>
                                                        <input type="range" class="form-range" @bind="_edgeDetectionThreshold" min="10" max="100" />
                                                        <small class="text-muted">@_edgeDetectionThreshold</small>
                                                    </div>
                                                }
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" id="addPadding" @bind="_extractionAddPadding" />
                                                    <label class="form-check-label small" for="addPadding">Add padding (2px)</label>
                                                </div>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" id="includeCoords" @bind="_extractionIncludeCoordinates" />
                                                    <label class="form-check-label small" for="includeCoords">Show coordinates</label>
                                                </div>
                                                <div class="form-check mb-1">
                                                    <input class="form-check-input" type="checkbox" id="detectOnly" @bind="_extractionDetectOnly" />
                                                    <label class="form-check-label small" for="detectOnly">Detect only (no crop)</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="highConfidence" @bind="_extractionHighConfidenceOnly" />
                                                    <label class="form-check-label small" for="highConfidence">High confidence (≥80%)</label>
                                                </div>
                                            </div>
                                        }
                                        
                                        @if (_selectedAnalysis == "code" || _selectedAnalysis == "codeWithViewModel")
                                        {
                                            <div class="mb-4">
                                                <label class="section-title" style="display: flex; align-items: center; gap: 6px; font-size: 0.9rem; margin-bottom: 10px;">
                                                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem;">🎯</span>
                                                    <span style="font-weight: 700; color: #4f46e5;">Target Framework</span>
                                                </label>
                                                <select class="form-select form-control-modern" @bind="_targetFramework" style="font-size: 1rem; padding: 12px 14px; font-weight: 500; border: 2px solid #e0e7ff;">
                                                    <option value="HTML/CSS">🌐 HTML/CSS — Vanilla web</option>
                                                    <option value="Tailwind CSS">🎨 Tailwind CSS — Utility-first</option>
                                                    <option value="React">⚛️ React — JSX Component</option>
                                                    <option value="Vue">💚 Vue.js — SFC Component</option>
                                                    <option value="Blazor Razor">🔷 Blazor Razor — .razor file</option>
                                                    <option value="Razor Pages">📄 Razor Pages — .cshtml file</option>
                                                    <option value="SwiftUI">🍎 SwiftUI — iOS/macOS</option>
                                                    <option value="MAUI XAML">📱 .NET MAUI — Cross-platform</option>
                                                    <option value="Angular">🅰️ Angular — TypeScript</option>
                                                </select>
                                            </div>
                                        }
                                        
                                        @* ========== GIANT GENERATE BUTTON - ALWAYS VISIBLE ========== *@
                                        <div class="generate-button-section" style="background: linear-gradient(135deg, #f0f4ff 0%, #fdf4ff 100%); border-radius: 16px; padding: 16px; margin-top: 16px; border: 2px solid #e0e7ff;">
                                            @if (string.IsNullOrEmpty(_codeImageUrl))
                                            {
                                                @* Upload Required Message *@
                                                <div class="text-center p-4" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 12px; border: 2px dashed #f59e0b;">
                                                    <span style="font-size: 2.5rem; display: block; margin-bottom: 12px;">📤</span>
                                                    <p class="mb-1 fw-bold" style="color: #92400e; font-size: 1.1rem;">Upload an Image First</p>
                                                    <p class="mb-0" style="color: #b45309; font-size: 0.9rem;">Drop or click the upload zone above to get started</p>
                                                </div>
                                            }
                                            else
                                            {
                                                @* GIANT GENERATE BUTTON *@
                                                <button class="btn w-100 premium-action-btn @(_isAnalyzing || _isConvertingToCode ? "processing" : "")" 
                                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 40%, #ec4899 100%); color: white; border: none; border-radius: 16px; padding: 24px 28px; box-shadow: 0 8px 32px rgba(102, 126, 234, 0.5), 0 0 0 4px rgba(102, 126, 234, 0.15); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); font-size: 1.2rem; position: relative; overflow: hidden; min-height: 90px;" 
                                                        @onclick="RunAnalysis" 
                                                        disabled="@(_isAnalyzing || _isConvertingToCode)">
                                                    @* Animated Background Shimmer *@
                                                    <div class="btn-shimmer" style="position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent); transition: left 0.6s ease;"></div>
                                                    
                                                    @if (_isAnalyzing || _isConvertingToCode)
                                                    {
                                                        <div class="d-flex align-items-center justify-content-center gap-4">
                                                            <div class="processing-spinner" style="width: 36px; height: 36px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
                                                            <div style="text-align: left;">
                                                                <div style="font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px;">Processing with AI...</div>
                                                                <div style="font-size: 0.9rem; opacity: 0.9;">@GetServiceName() is analyzing your image</div>
                                                            </div>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <div class="d-flex align-items-center justify-content-center gap-4">
                                                            <div style="background: rgba(255,255,255,0.25); border-radius: 14px; padding: 14px 16px; backdrop-filter: blur(8px);">
                                                                <span style="font-size: 2rem;">@GetAnalysisButtonIcon()</span>
                                                            </div>
                                                            <div style="text-align: left; flex: 1;">
                                                                <div style="font-weight: 800; font-size: 1.4rem; letter-spacing: -0.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">@GetAnalysisButtonText()</div>
                                                                <div style="font-size: 0.95rem; opacity: 0.95; margin-top: 2px;">
                                                                    @GetServiceName() • <span style="font-weight: 600;">@_targetFramework</span>
                                                                </div>
                                                            </div>
                                                            <div style="background: rgba(255,255,255,0.2); border-radius: 12px; padding: 12px 16px; display: flex; align-items: center; gap: 6px;">
                                                                <span style="font-size: 1.5rem;">▶</span>
                                                                <span style="font-weight: 700; font-size: 1rem;">GO</span>
                                                            </div>
                                                        </div>
                                                    }
                                                </button>
                                                
                                                @* Keyboard Shortcut Hint *@
                                                <div class="text-center mt-3" style="font-size: 0.8rem; color: #6b7280;">
                                                    <kbd style="background: #e5e7eb; padding: 3px 8px; border-radius: 5px; font-family: monospace; font-size: 0.75rem; font-weight: 600;">⌘</kbd> + 
                                                    <kbd style="background: #e5e7eb; padding: 3px 8px; border-radius: 5px; font-family: monospace; font-size: 0.75rem; font-weight: 600;">Enter</kbd> 
                                                    to generate
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                
                                @* Draggable Vertical Splitter *@
                                <div class="vertical-splitter" id="splitter" @onmousedown="StartSplitterDrag"></div>
                            
                                @* Right Pane - Results - Full Height *@
                                <div class="split-pane-right" id="rightPane">
                                    @if (_selectedAnalysis == "code")
                                    {
                                        @* Code Generation Output with Inline Preview *@
                                        <div class="code-output-panel p-2">
                                            @* Header - Compact *@
                                            <div class="d-flex align-items-center justify-content-between mb-2" style="flex-shrink: 0;">
                                                <div class="d-flex align-items-center gap-2">
                                                    <h6 class="fw-bold mb-0" style="color: #667eea; font-size: 0.95rem;">
                                                        <span class="me-1">💻</span>Generated Code
                                                    </h6>
                                                    @if (!string.IsNullOrEmpty(_codeLanguage))
                                                    {
                                                        <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.65rem; padding: 3px 7px;">@_codeLanguage.ToUpper()</span>
                                                    }
                                                </div>
                                                <div class="d-flex gap-2 align-items-center">
                                                    @if (!string.IsNullOrEmpty(_generatedCode))
                                                    {
                                                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 6px; padding: 4px 10px; font-size: 0.7rem; font-weight: 600;" @onclick="CopyCodeToClipboard">
                                                            @(_codeCopied ? "✓ Copied!" : "📋 Copy")
                                                        </button>
                                                        @if (CanShowPreview())
                                                        {
                                                            <button type="button" class="btn btn-sm" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 6px; padding: 4px 10px; font-size: 0.7rem; font-weight: 600;" @onclick="DownloadPreviewHtml">
                                                                📥 Download
                                                            </button>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                            
                                            @* View Mode Tabs - Compact *@
                                            @if (!string.IsNullOrEmpty(_generatedCode) && CanShowPreview())
                                            {
                                                <div class="d-flex gap-2 mb-2" style="flex-shrink: 0; background: #f1f5f9; padding: 6px; border-radius: 8px;">
                                                    <button class="btn btn-sm @(_codeViewMode == "code" ? "" : "btn-outline-secondary")" 
                                                            style="@(_codeViewMode == "code" ? "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;" : "") border-radius: 6px; padding: 6px 14px; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 4px;"
                                                            @onclick="SetCodeViewMode">
                                                        <span>💻</span> Code
                                                    </button>
                                                    <button class="btn btn-sm @(_codeViewMode == "preview" ? "" : "btn-outline-secondary")" 
                                                            style="@(_codeViewMode == "preview" ? "background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;" : "") border-radius: 6px; padding: 6px 14px; font-weight: 600; font-size: 0.8rem; display: flex; align-items: center; gap: 4px;"
                                                            @onclick="SetPreviewViewMode">
                                                        <span>👁️</span> Preview
                                                    </button>
                                                    <button class="btn btn-sm @(_codeViewMode == "split" ? "" : "btn-outline-secondary")" 
                                                            style="@(_codeViewMode == "split" ? "background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;" : "") border-radius: 6px; padding: 6px 14px; font-weight: 700; font-size: 0.8rem; display: flex; align-items: center; gap: 4px;"
                                                            @onclick="SetSplitViewMode">
                                                        <span>◧</span> Split
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-auto" 
                                                            style="border-radius: 6px; padding: 6px 10px; font-weight: 600; font-size: 0.8rem;"
                                                            @onclick="OpenPreviewPopup" title="Open in new window">
                                                        🔗
                                                    </button>
                                                </div>
                                            }

                                            @* Content Area - Fills Remaining Space *@
                                            <div class="code-view-container">
                                            @if (_isConvertingToCode)
                                            {
                                                <div class="text-center" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                    <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: #667eea;"></div>
                                                    <p class="fw-semibold" style="color: #667eea;">Generating @_targetFramework code...</p>
                                                    <p class="small text-muted">GPT-4o Vision is analyzing your UI</p>
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(_generatedCode))
                                            {
                                                @if (_codeViewMode == "code" || !CanShowPreview())
                                                {
                                                    @* Code Only View - Full Height *@
                                                    <div class="code-panel" style="border-radius: 10px; border: 2px solid #e2e8f0;">
                                                        <div class="code-panel-content">
                                                            <pre class="code-pre" style="margin: 0; padding: 12px; white-space: pre-wrap; height: 100%; font-size: 12px; line-height: 1.5; background: #1e293b; color: #e2e8f0; border-radius: 8px;">@_generatedCode</pre>
                                                        </div>
                                                    </div>
                                                }
                                                else if (_codeViewMode == "preview")
                                                {
                                                    @* Preview Only View - Full Height *@
                                                    <div class="preview-panel" style="border-radius: 10px; border: 2px solid #10b981;">
                                                        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;">
                                                            <span style="font-weight: 600; font-size: 0.85rem;">👁️ Live Preview — @_targetFramework</span>
                                                            <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 5px; padding: 3px 10px; font-size: 0.75rem;" @onclick="RefreshPreview">🔄</button>
                                                        </div>
                                                        <div class="preview-panel-content" style="background: white;">
                                                            <div class="preview-iframe-container">
                                                                <iframe src="@GetPreviewDataUrl()"></iframe>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                else if (_codeViewMode == "split")
                                                {
                                                    @* Split View - Code + Preview - Full Height *@
                                                    <div class="code-split-view">
                                                        @* Code Panel *@
                                                        <div class="code-panel" style="border-radius: 10px; border: 2px solid #e2e8f0;">
                                                            <div style="background: #1e293b; color: white; padding: 8px 12px; font-weight: 600; font-size: 0.8rem; flex-shrink: 0; border-radius: 8px 8px 0 0;">
                                                                💻 Code
                                                            </div>
                                                            <div class="code-panel-content">
                                                                <pre class="code-pre" style="margin: 0; padding: 10px; white-space: pre-wrap; height: 100%; font-size: 11px; line-height: 1.4; background: #1e293b; color: #e2e8f0;">@_generatedCode</pre>
                                                            </div>
                                                        </div>
                                                        @* Preview Panel *@
                                                        <div class="preview-panel" style="border-radius: 10px; border: 2px solid #10b981;">
                                                            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 12px; font-weight: 600; font-size: 0.8rem; flex-shrink: 0; border-radius: 8px 8px 0 0;">
                                                                👁️ Live Preview
                                                            </div>
                                                            <div class="preview-panel-content" style="background: white;">
                                                                <div class="preview-iframe-container">
                                                                    <iframe src="@GetPreviewDataUrl()"></iframe>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="text-center" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 8px 30px rgba(102, 126, 234, 0.3);">
                                                        <span style="font-size: 36px;">💻</span>
                                                    </div>
                                                    <p class="mt-2 fw-bold" style="color: #667eea; font-size: 1rem;">Ready to Generate Code</p>
                                                    <p class="text-muted small" style="max-width: 280px;">Upload a UI screenshot and click Generate</p>
                                                </div>
                                            }
                                            </div>
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "codeWithViewModel")
                                    {
                                        @* Code + ViewModel Generation with OCR *@
                                        <div class="p-3" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; display: flex; flex-direction: column; height: 100%;">
                                            @* Tabs *@
                                            <ul class="nav nav-tabs mb-3" style="border-bottom: 2px solid #e0e0e0; flex-shrink: 0;">
                                                <li class="nav-item">
                                                    <button class="nav-link @(_viewModelTab == "extracted" ? "active" : "")" style="@(_viewModelTab == "extracted" ? "color: #667eea; border-color: #667eea #667eea #fff; font-weight: 600;" : "color: #666;")" @onclick='() => _viewModelTab = "extracted"'>
                                                        📜 Extracted Text
                                                    </button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link @(_viewModelTab == "viewmodel" ? "active" : "")" style="@(_viewModelTab == "viewmodel" ? "color: #667eea; border-color: #667eea #667eea #fff; font-weight: 600;" : "color: #666;")" @onclick='() => _viewModelTab = "viewmodel"'>
                                                        📋 ViewModel
                                                    </button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link @(_viewModelTab == "razor" ? "active" : "")" style="@(_viewModelTab == "razor" ? "color: #667eea; border-color: #667eea #667eea #fff; font-weight: 600;" : "color: #666;")" @onclick='() => _viewModelTab = "razor"'>
                                                        🔷 Razor Page
                                                    </button>
                                                </li>
                                                <li class="nav-item">
                                                    <button class="nav-link @(_viewModelTab == "preview" ? "active" : "")" style="@(_viewModelTab == "preview" ? "color: #667eea; border-color: #667eea #667eea #fff; font-weight: 600;" : "color: #666;")" @onclick='() => _viewModelTab = "preview"'>
                                                        👁️ Preview
                                                    </button>
                                                </li>
                                            </ul>
                                            
                                            @if (_isConvertingToCode)
                                            {
                                                <div class="text-center py-5">
                                                    <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: #667eea;"></div>
                                                    <p class="fw-semibold" style="color: #667eea;">Extracting text and generating code...</p>
                                                    <p class="small text-muted">This may take a moment</p>
                                                </div>
                                            }
                                            else if (_viewModelTab == "extracted")
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="fw-bold mb-0">📜 Extracted Text/Data</h6>
                                                    @if (!string.IsNullOrEmpty(_extractedTextJson))
                                                    {
                                                        <button class="btn btn-sm btn-outline-secondary" @onclick="CopyExtractedText">📋 Copy</button>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(_extractedTextJson))
                                                {
                                                    <div style="max-height: 400px; overflow: auto; border-radius: 8px; background: #f8f9fa; padding: 12px;">
                                                        <pre style="margin: 0; font-size: 12px; white-space: pre-wrap;">@_extractedTextJson</pre>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-center py-5" style="color: #888;">
                                                        <span style="font-size: 40px; opacity: 0.5;">📜</span>
                                                        <p class="mt-2">Upload an image and click "Generate" to extract text</p>
                                                    </div>
                                                }
                                            }
                                            else if (_viewModelTab == "viewmodel")
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="fw-bold mb-0">📋 Generated ViewModel</h6>
                                                    @if (!string.IsNullOrEmpty(_generatedViewModel))
                                                    {
                                                        <button class="btn btn-sm btn-outline-secondary" @onclick="CopyViewModel">📋 Copy</button>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(_generatedViewModel))
                                                {
                                                    <div style="max-height: 400px; overflow: auto; border-radius: 8px;">
                                                        <pre style="margin: 0; padding: 12px; background: #1e1e1e; color: #d4d4d4; border-radius: 8px; font-size: 11px; white-space: pre-wrap;">@_generatedViewModel</pre>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-center py-5" style="color: #888;">
                                                        <span style="font-size: 40px; opacity: 0.5;">📋</span>
                                                        <p class="mt-2">ViewModel will appear here after generation</p>
                                                    </div>
                                                }
                                            }
                                            else if (_viewModelTab == "razor")
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="fw-bold mb-0">🔷 Generated Razor Page</h6>
                                                    @if (!string.IsNullOrEmpty(_generatedRazorWithParams))
                                                    {
                                                        <button class="btn btn-sm btn-outline-secondary" @onclick="CopyRazorCode">📋 Copy</button>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(_generatedRazorWithParams))
                                                {
                                                    <div style="max-height: 400px; overflow: auto; border-radius: 8px;">
                                                        <pre style="margin: 0; padding: 12px; background: #1e1e1e; color: #d4d4d4; border-radius: 8px; font-size: 11px; white-space: pre-wrap;">@_generatedRazorWithParams</pre>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-center py-5" style="color: #888;">
                                                        <span style="font-size: 40px; opacity: 0.5;">🔷</span>
                                                        <p class="mt-2">Razor page will appear here after generation</p>
                                                    </div>
                                                }
                                            }
                                            else if (_viewModelTab == "preview")
                                            {
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <h6 class="fw-bold mb-0">👁️ Live Preview</h6>
                                                    @if (!string.IsNullOrEmpty(_generatedRazorWithParams))
                                                    {
                                                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px;" @onclick="OpenViewModelPreview">🔗 Open in New Window</button>
                                                    }
                                                </div>
                                                @if (!string.IsNullOrEmpty(_viewModelPreviewHtml))
                                                {
                                                    <div style="max-height: 400px; overflow: auto; border: 1px solid #e0e0e0; border-radius: 8px; background: #fff;">
                                                        <iframe srcdoc="@_viewModelPreviewHtml" style="width: 100%; height: 400px; border: none;"></iframe>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-center py-5" style="color: #888;">
                                                        <span style="font-size: 40px; opacity: 0.5;">👁️</span>
                                                        <p class="mt-2">Preview will appear here after generation</p>
                                                    </div>
                                                }
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "colors" && _colorAnalysis != null)
                                    {
                                        @* Color Palette Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">🎨 Extracted Color Palette</h6>
                                            <div class="row g-3">
                                                @if (!string.IsNullOrEmpty(_colorAnalysis.PrimaryColor))
                                                {
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 text-center" style="background: @_colorAnalysis.PrimaryColor; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                                            <small class="d-block fw-bold">Primary</small>
                                                            <code style="color: white;">@_colorAnalysis.PrimaryColor</code>
                                                        </div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(_colorAnalysis.SecondaryColor))
                                                {
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 text-center" style="background: @_colorAnalysis.SecondaryColor; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                                            <small class="d-block fw-bold">Secondary</small>
                                                            <code style="color: white;">@_colorAnalysis.SecondaryColor</code>
                                                        </div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(_colorAnalysis.AccentColor))
                                                {
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 text-center" style="background: @_colorAnalysis.AccentColor; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                                            <small class="d-block fw-bold">Accent</small>
                                                            <code style="color: white;">@_colorAnalysis.AccentColor</code>
                                                        </div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(_colorAnalysis.BackgroundColor))
                                                {
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 text-center border" style="background: @_colorAnalysis.BackgroundColor;">
                                                            <small class="d-block fw-bold">Background</small>
                                                            <code>@_colorAnalysis.BackgroundColor</code>
                                                        </div>
                                                    </div>
                                                }
                                                @if (!string.IsNullOrEmpty(_colorAnalysis.TextColor))
                                                {
                                                    <div class="col-6 col-md-4">
                                                        <div class="p-3 rounded-3 text-center border" style="background: #f5f5f5;">
                                                            <small class="d-block fw-bold" style="color: @_colorAnalysis.TextColor;">Text</small>
                                                            <code style="color: @_colorAnalysis.TextColor;">@_colorAnalysis.TextColor</code>
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                            @if (!string.IsNullOrEmpty(_colorAnalysis.ColorScheme))
                                            {
                                                <div class="mt-3 p-2 rounded" style="background: #f5f5f5;">
                                                    <small><strong>Color Scheme:</strong> @_colorAnalysis.ColorScheme</small>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(_colorAnalysis.Content))
                                            {
                                                <details class="mt-3">
                                                    <summary class="btn btn-sm btn-outline-secondary">View Raw JSON</summary>
                                                    <pre class="mt-2 p-2 rounded" style="background: #f5f5f5; font-size: 11px; max-height: 200px; overflow: auto;">@_colorAnalysis.Content</pre>
                                                </details>
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "typography" && _typographyAnalysis != null)
                                    {
                                        @* Typography Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">🔤 Typography Analysis</h6>
                                            <div class="row g-3">
                                                @if (!string.IsNullOrEmpty(_typographyAnalysis.PrimaryFont))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #f8f9fa;"><small class="text-muted d-block">Primary Font</small><strong style="font-size: 1.1rem;">@_typographyAnalysis.PrimaryFont</strong></div></div>
                                                }
                                                @if (!string.IsNullOrEmpty(_typographyAnalysis.HeadingFont))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #f8f9fa;"><small class="text-muted d-block">Heading Font</small><strong>@_typographyAnalysis.HeadingFont</strong></div></div>
                                                }
                                                @if (!string.IsNullOrEmpty(_typographyAnalysis.BodyFont))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #f8f9fa;"><small class="text-muted d-block">Body Font</small><strong>@_typographyAnalysis.BodyFont</strong></div></div>
                                                }
                                                @if (!string.IsNullOrEmpty(_typographyAnalysis.LineHeight))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #f8f9fa;"><small class="text-muted d-block">Line Height</small><strong>@_typographyAnalysis.LineHeight</strong></div></div>
                                                }
                                            </div>
                                            @if (_typographyAnalysis.FontSizes?.Any() == true)
                                            {
                                                <div class="mt-3">
                                                    <small class="text-muted d-block mb-2">Font Sizes</small>
                                                    <div class="d-flex flex-wrap gap-2">
                                                        @foreach (var size in _typographyAnalysis.FontSizes)
                                                        {
                                                            <span class="badge bg-secondary">@size.Key: @size.Value</span>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "layout" && _layoutAnalysis != null)
                                    {
                                        @* Layout Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">📐 Layout Analysis</h6>
                                            <div class="row g-3">
                                                @if (!string.IsNullOrEmpty(_layoutAnalysis.LayoutType))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #e3f2fd;"><small class="text-muted d-block">Layout Type</small><strong style="color: #1976d2;">@_layoutAnalysis.LayoutType</strong></div></div>
                                                }
                                                @if (!string.IsNullOrEmpty(_layoutAnalysis.ContainerWidth))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #e3f2fd;"><small class="text-muted d-block">Container Width</small><strong>@_layoutAnalysis.ContainerWidth</strong></div></div>
                                                }
                                                @if (_layoutAnalysis.Columns.HasValue)
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #e3f2fd;"><small class="text-muted d-block">Grid Columns</small><strong>@_layoutAnalysis.Columns</strong></div></div>
                                                }
                                                @if (!string.IsNullOrEmpty(_layoutAnalysis.Gap))
                                                {
                                                    <div class="col-md-6"><div class="p-3 rounded-3" style="background: #e3f2fd;"><small class="text-muted d-block">Gap</small><strong>@_layoutAnalysis.Gap</strong></div></div>
                                                }
                                            </div>
                                            @if (_layoutAnalysis.Sections?.Any() == true)
                                            {
                                                <div class="mt-3">
                                                    <small class="text-muted d-block mb-2">Sections</small>
                                                    @foreach (var sec in _layoutAnalysis.Sections)
                                                    {
                                                        <div class="p-2 mb-2 rounded" style="background: #f5f5f5;">
                                                            <strong>@(sec.Name)</strong> <span class="badge bg-info">@(sec.Type)</span>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "components" && _componentsAnalysis != null)
                                    {
                                        @* Components Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">🧩 UI Components</h6>
                                            @if (!string.IsNullOrEmpty(_componentsAnalysis.LayoutType))
                                            {
                                                <div class="mb-3 p-2 rounded" style="background: #fff3e0;"><strong>Layout:</strong> @_componentsAnalysis.LayoutType</div>
                                            }
                                            @if (_componentsAnalysis.Sections?.Any() == true)
                                            {
                                                <div class="mb-3"><strong>Sections:</strong> @string.Join(", ", _componentsAnalysis.Sections)</div>
                                            }
                                            @if (_componentsAnalysis.Components?.Any() == true)
                                            {
                                                @foreach (var comp in _componentsAnalysis.Components)
                                                {
                                                    <div class="p-2 mb-2 rounded border">
                                                        <span class="badge" style="background: #667eea;">@comp.Type</span>
                                                        @if (!string.IsNullOrEmpty(comp.Name)) { <strong class="ms-2">@comp.Name</strong> }
                                                        @if (!string.IsNullOrEmpty(comp.Text)) { <span class="text-muted ms-2">"@comp.Text"</span> }
                                                    </div>
                                                }
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "icons" && _iconsAnalysis != null)
                                    {
                                        @* Icons Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">🎯 Identified Icons</h6>
                                            @if (!string.IsNullOrEmpty(_iconsAnalysis.IconStyle))
                                            {
                                                <div class="mb-2"><strong>Style:</strong> @_iconsAnalysis.IconStyle</div>
                                            }
                                            @if (!string.IsNullOrEmpty(_iconsAnalysis.SuggestedLibrary))
                                            {
                                                <div class="mb-3 p-2 rounded" style="background: #e8f5e9;"><strong>Suggested Library:</strong> <span style="color: #2e7d32;">@_iconsAnalysis.SuggestedLibrary</span></div>
                                            }
                                            @if (_iconsAnalysis.Icons?.Any() == true)
                                            {
                                                <div class="d-flex flex-wrap gap-2">
                                                    @foreach (var icon in _iconsAnalysis.Icons)
                                                    {
                                                        <div class="p-2 rounded border text-center" style="min-width: 80px;">
                                                            <div class="fw-bold">@icon.SuggestedName</div>
                                                            <small class="text-muted">@icon.Location</small>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "accessibility" && _accessibilityAnalysis != null)
                                    {
                                        @* Accessibility Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">♿ Accessibility Audit</h6>
                                            @if (!string.IsNullOrEmpty(_accessibilityAnalysis.OverallScore))
                                            {
                                                var scoreColor = _accessibilityAnalysis.OverallScore == "Good" ? "#4caf50" : _accessibilityAnalysis.OverallScore == "Poor" ? "#f44336" : "#ff9800";
                                                <div class="mb-3 p-3 rounded text-center" style="background: @scoreColor; color: white;">
                                                    <h5 class="mb-0">@_accessibilityAnalysis.OverallScore</h5>
                                                </div>
                                            }
                                            <div class="row g-2 mb-3">
                                                <div class="col-4"><div class="p-2 rounded text-center" style="background: @(_accessibilityAnalysis.HasSufficientTextSize == true ? "#e8f5e9" : "#ffebee");">Text Size: @(_accessibilityAnalysis.HasSufficientTextSize == true ? "✓" : "✗")</div></div>
                                                <div class="col-4"><div class="p-2 rounded text-center" style="background: @(_accessibilityAnalysis.HasClearHierarchy == true ? "#e8f5e9" : "#ffebee");">Hierarchy: @(_accessibilityAnalysis.HasClearHierarchy == true ? "✓" : "✗")</div></div>
                                                <div class="col-4"><div class="p-2 rounded text-center" style="background: @(_accessibilityAnalysis.HasTouchTargets == true ? "#e8f5e9" : "#ffebee");">Touch Targets: @(_accessibilityAnalysis.HasTouchTargets == true ? "✓" : "✗")</div></div>
                                            </div>
                                            @if (_accessibilityAnalysis.Issues?.Any() == true)
                                            {
                                                <h6>Issues Found:</h6>
                                                @foreach (var issue in _accessibilityAnalysis.Issues)
                                                {
                                                    var severityColor = issue.Severity == "critical" ? "#f44336" : issue.Severity == "major" ? "#ff9800" : "#2196f3";
                                                    <div class="p-2 mb-2 rounded border-start border-4" style="border-color: @severityColor !important; background: #fafafa;">
                                                        <span class="badge" style="background: @severityColor;">@issue.Severity</span>
                                                        <span class="ms-2">@issue.Description</span>
                                                        @if (!string.IsNullOrEmpty(issue.Recommendation))
                                                        {
                                                            <div class="small text-muted mt-1">💡 @issue.Recommendation</div>
                                                        }
                                                    </div>
                                                }
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "comprehensive" && _comprehensiveAnalysis != null)
                                    {
                                        @* Comprehensive Analysis Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <h6 class="fw-bold mb-3" style="color: #333;">🔬 Comprehensive Analysis</h6>
                                            @if (!string.IsNullOrEmpty(_comprehensiveAnalysis.OverallStyle))
                                            {
                                                <div class="mb-3 p-2 rounded" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                                    <strong>Design Style:</strong> @_comprehensiveAnalysis.OverallStyle
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(_comprehensiveAnalysis.Description))
                                            {
                                                <div class="mb-3"><strong>Description:</strong><p class="mb-0 mt-1">@_comprehensiveAnalysis.Description</p></div>
                                            }
                                            @if (_comprehensiveAnalysis.DesignPatterns?.Any() == true)
                                            {
                                                <div class="mb-3"><strong>Design Patterns:</strong><div class="d-flex flex-wrap gap-1 mt-1">@foreach (var p in _comprehensiveAnalysis.DesignPatterns) { <span class="badge bg-secondary">@p</span> }</div></div>
                                            }
                                            @if (_comprehensiveAnalysis.SuggestedFrameworks?.Any() == true)
                                            {
                                                <div class="mb-3"><strong>Suggested Frameworks:</strong><div class="d-flex flex-wrap gap-1 mt-1">@foreach (var f in _comprehensiveAnalysis.SuggestedFrameworks) { <span class="badge bg-info">@f</span> }</div></div>
                                            }
                                        </div>
                                    }
                                    else if (_selectedAnalysis == "extractImages" && _extractedImagesResult != null)
                                    {
                                        @* Extracted Images Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; overflow: auto;">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="fw-bold mb-0" style="color: #333;">
                                                    🖼️ @GetExtractionResultTitle()
                                                    <span class="badge bg-primary ms-2">@(_extractedImagesResult.TotalImagesFound) found</span>
                                                </h6>
                                                @if (_extractedImagesResult.Images?.Any() == true && !_extractionDetectOnly)
                                                {
                                                    <button class="btn btn-sm" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 8px;"
                                                            @onclick="DownloadAllExtractedImages">
                                                        📥 Download All
                                                    </button>
                                                }
                                            </div>
                                            
                                            @if (!string.IsNullOrEmpty(_extractedImagesResult.AnalysisSummary))
                                            {
                                                <div class="alert alert-info py-2 mb-3" style="border-radius: 10px; font-size: 0.85rem;">
                                                    @_extractedImagesResult.AnalysisSummary
                                                </div>
                                            }
                                            
                                            @* Show image with region overlay for detect-only mode *@
                                            @if (_extractionDetectOnly && !string.IsNullOrEmpty(_codeImageBase64) && _extractedImagesResult.Images?.Any() == true)
                                            {
                                                <div class="mb-3 position-relative" style="border: 2px solid #ddd; border-radius: 12px; overflow: hidden;">
                                                    <div style="position: relative; display: inline-block; width: 100%;">
                                                        <img src="@_codeImageUrl" alt="Source image with regions" 
                                                             style="width: 100%; height: auto; display: block;" />
                                                        @{
                                                            int regionIndex = 0;
                                                            var colors = new[] { "#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", "#ffeaa7", "#dfe6e9", "#fd79a8", "#a29bfe" };
                                                        }
                                                        @foreach (var img in _extractedImagesResult.Images!)
                                                        {
                                                            if (img.BoundingBox != null)
                                                            {
                                                                var color = colors[regionIndex % colors.Length];
                                                                <div style="position: absolute; 
                                                                            left: @(img.BoundingBox.NormalizedX * 100)%; 
                                                                            top: @(img.BoundingBox.NormalizedY * 100)%; 
                                                                            width: @(img.BoundingBox.NormalizedWidth * 100)%; 
                                                                            height: @(img.BoundingBox.NormalizedHeight * 100)%;
                                                                            border: 3px solid @color;
                                                                            background: @(color)22;
                                                                            border-radius: 4px;
                                                                            box-sizing: border-box;
                                                                            pointer-events: none;">
                                                                    <span style="position: absolute; top: -1px; left: -1px; background: @color; color: white; font-size: 10px; padding: 1px 4px; border-radius: 0 0 4px 0; font-weight: bold;">@(regionIndex + 1)</span>
                                                                </div>
                                                                regionIndex++;
                                                            }
                                                        }
                                                    </div>
                                                </div>
                                                <div class="mb-2" style="font-size: 0.75rem; color: #666;">
                                                    <strong>Regions Legend:</strong> Hover over regions above or see details below
                                                </div>
                                            }
                                            
                                            @if (_extractedImagesResult.Images?.Any() == true)
                                            {
                                                <div class="row g-3">
                                                    @{
                                                        int cardIndex = 0;
                                                        var cardColors = new[] { "#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", "#ffeaa7", "#dfe6e9", "#fd79a8", "#a29bfe" };
                                                    }
                                                    @foreach (var img in _extractedImagesResult.Images)
                                                    {
                                                        var cardColor = cardColors[cardIndex % cardColors.Length];
                                                        <div class="col-6 col-md-4 col-lg-3">
                                                            <div class="card h-100 shadow-sm" style="border-radius: 12px; overflow: hidden; border-left: 4px solid @cardColor;">
                                                                <div style="height: 120px; background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%); display: flex; align-items: center; justify-content: center; padding: 8px; position: relative;">
                                                                    @if (!string.IsNullOrEmpty(img.Base64Data))
                                                                    {
                                                                        <img src="data:image/png;base64,@img.Base64Data" 
                                                                             style="max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;" 
                                                                             alt="@img.Description" />
                                                                    }
                                                                    else if (_extractionDetectOnly && img.BoundingBox != null)
                                                                    {
                                                                        <div class="text-center w-100" style="color: #666;">
                                                                            <div style="font-size: 28px; font-weight: bold; color: @cardColor;">@(cardIndex + 1)</div>
                                                                            <div style="font-size: 0.7rem; margin-top: 4px;">
                                                                                @img.BoundingBox.Width×@img.BoundingBox.Height px
                                                                            </div>
                                                                            <div style="font-size: 0.65rem; color: #888;">
                                                                                Position: (@img.BoundingBox.X, @img.BoundingBox.Y)
                                                                            </div>
                                                                        </div>
                                                                    }
                                                                </div>
                                                                <div class="card-body p-2">
                                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                                        <span class="badge" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-size: 0.65rem;">@img.ImageType</span>
                                                                        <span class="badge bg-success" style="font-size: 0.6rem;">@img.Confidence%</span>
                                                                    </div>
                                                                    <small class="d-block text-truncate mb-1" title="@img.Description" style="font-size: 0.75rem; color: #555;">
                                                                        @(img.Description?.Length > 40 ? img.Description[..40] + "..." : img.Description)
                                                                    </small>
                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                        <small class="text-muted" style="font-size: 0.65rem;">@(img.Width)×@(img.Height)px</small>
                                                                        @if (!_extractionDetectOnly && !string.IsNullOrEmpty(img.Base64Data))
                                                                        {
                                                                            <button class="btn btn-sm p-1" style="font-size: 0.65rem; background: #e3f2fd; border: none; border-radius: 6px;" 
                                                                                    @onclick="() => DownloadExtractedImage(img)">
                                                                                📥
                                                                            </button>
                                                                        }
                                                                        @if (_extractionDetectOnly && img.BoundingBox != null)
                                                                        {
                                                                            <button class="btn btn-sm p-1" style="font-size: 0.65rem; background: #e8f5e9; border: none; border-radius: 6px;" 
                                                                                    @onclick="() => CropAndDownloadRegion(img.BoundingBox!)">
                                                                                ✂️ Crop
                                                                            </button>
                                                                        }
                                                                    </div>
                                                                    @if (_extractionIncludeCoordinates && img.BoundingBox != null)
                                                                    {
                                                                        <div class="mt-1 p-1" style="background: #f8f9fa; border-radius: 4px; font-size: 0.6rem; font-family: monospace; color: #666;">
                                                                            x:@img.BoundingBox.X y:@img.BoundingBox.Y w:@img.BoundingBox.Width h:@img.BoundingBox.Height
                                                                        </div>
                                                                    }
                                                                </div>
                                                            </div>
                                                        </div>
                                                        cardIndex++;
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-center py-5" style="color: #888;">
                                                    <span style="font-size: 48px; opacity: 0.5;">🖼️</span>
                                                    <p class="mt-2">No images found matching your criteria</p>
                                                    <small class="text-muted">Try adjusting the extraction type or size filter</small>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        @* Generic Text Result Display *@
                                        <div class="p-4" style="background: #fff; border-radius: 16px; border: 2px solid #e0e0e0; flex: 1; display: flex; flex-direction: column;">
                                            <h6 class="fw-bold mb-3" style="color: #333; flex-shrink: 0;">📋 Analysis Result</h6>
                                            @if (_isAnalyzing)
                                            {
                                                <div class="text-center py-5" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                                                    <div class="spinner-border mb-3" style="width: 3rem; height: 3rem; color: #667eea;"></div>
                                                    <p>Analyzing your design...</p>
                                                </div>
                                            }
                                            else if (!string.IsNullOrEmpty(_analysisResult))
                                            {
                                                <div style="flex: 1; overflow: auto;">
                                                    <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">@_analysisResult</pre>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="text-center py-5" style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888;">
                                                    <span style="font-size: 40px; opacity: 0.5;">🔍</span>
                                                    <p class="mt-2">Upload an image and select an analysis type</p>
                                                </div>
                                            }
                                        </div>
                                    }
                                    
                                    @if (!string.IsNullOrEmpty(_codeError))
                                    {
                                        <div class="alert mt-3 mb-0" style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border: 1px solid #ff6b6b; border-radius: 12px;">
                                            <strong>⚠️ Error:</strong> @_codeError
                                        </div>
                                    }
                                </div> @* End split-pane-right *@
                            </div> @* End split-container *@
                        </div>
                    </div>
                }
                break;
        }
        
        <p class="text-center mt-4 mb-0" style="color: #999; font-size: 0.85rem;">
            Powered by Azure OpenAI Service
        </p>
    </div>
</div>

@* Service Info Modal Component *@
<ServiceInfoModal @bind-IsVisible="_showServiceInfoModal" 
                  AzureVisionAvailable="@(AzureVision?.IsConfigured ?? false)" 
                  CurrentMode="@_cropMode" />

@* Service Settings Dialog Component *@
<ServiceSettingsDialog @bind-IsVisible="_showServiceSettingsDialog"
                       Settings="_serviceSettings"
                       OnSave="HandleServiceSettingsSaved" />

@code {
    enum AppState { NotSignedIn, SigningIn, SignedIn }
    
    private AppState _state = AppState.NotSignedIn;
    private string _error = "";
    private string _userCode = "";
    private string _verificationUrl = "";
    private string _userName = "";
    private string _message = "";
    private string _response = "";
    private string _chatError = "";
    private bool _sending = false;
    private bool _copied = false;
    
    // Login timeout and cancellation
    private CancellationTokenSource? _loginCancellation;
    private const int LoginTimeoutSeconds = 120; // 2 minutes timeout
    private bool _loginTimedOut = false;
    private int _remainingSeconds = 0;
    private System.Timers.Timer? _countdownTimer;
    private DotNetObjectReference<Home>? _dotNetRef;
    
    [JSInvokable]
    public void CancelLoginFromJs()
    {
        InvokeAsync(() =>
        {
            if (_state == AppState.SigningIn)
            {
                Cancel();
                StateHasChanged();
            }
        });
    }
    
    // Tab navigation
    private string _activeTab = "chat";
    
    // Image generation
    private string _imagePrompt = "";
    private string _imageSize = "1024x1024";
    private string _generatedImageUrl = "";
    private string _revisedPrompt = "";
    private string _imageError = "";
    private bool _generatingImage = false;
    
    // Image upload
    private string _uploadedImageUrl = "";
    private string _uploadedImageName = "";
    private byte[]? _uploadedImageBytes = null;
    
    // Image to Code
    private string _codeImageUrl = "";
    private string _codeImageBase64 = "";
    private string _codeImageMimeType = "image/png";
    private string _targetFramework = "HTML/CSS";
    private string _generatedCode = "";
    private string _codeLanguage = "";
    private string _codeError = "";
    private bool _isConvertingToCode = false;
    private bool _codeCopied = false;
    private bool _isDragOver = false;
    
    // Vision Analysis Features
    private string _selectedAnalysis = "code"; // code, codeWithViewModel, extractImages, extractIcons, extractLogos, describe, colors, typography, layout, components, icons, accessibility, comprehensive
    private string _analysisResult = "";
    private bool _isAnalyzing = false;
    private string? _processedImageBase64 = null; // For image processing results (background removal, upscale, etc.)
    private ComprehensiveUIAnalysis? _comprehensiveAnalysis = null;
    private ColorPaletteResult? _colorAnalysis = null;
    private TypographyResult? _typographyAnalysis = null;
    private LayoutResult? _layoutAnalysis = null;
    private UIComponentsResult? _componentsAnalysis = null;
    private IconsResult? _iconsAnalysis = null;
    private AccessibilityResult? _accessibilityAnalysis = null;
    private ImageExtractionResult? _extractedImagesResult = null;
    private ImageRegionResult? _imageRegionsResult = null;
    
    // Image Extraction Options
    private string _extractionType = "all"; // all, icons, logos, photos, illustrations, charts, backgrounds, avatars
    private string _extractionSizeFilter = "all"; // all, small, medium, large, custom
    private int _extractionMinSize = 16;
    private int _extractionMaxSize = 1000;
    private bool _extractionAddPadding = true;
    private bool _extractionIncludeCoordinates = true;
    private bool _extractionDetectOnly = false;
    private bool _extractionHighConfidenceOnly = false;
    
    // New Crop Mode Options
    private string _cropMode = "AzureVision"; // AzureVision, SmartUICards, ContourDetection, FloodFillRegions, SmartDetect, Grid, Sections, Components, AIRegions
    private bool _showServiceInfoModal;
    private bool _showServiceSettingsDialog;
    private AzureOpenAISettings _serviceSettings = new();
    private int _gridRows = 2;
    private int _gridColumns = 2;
    private int _minComponentSize = 20;
    private bool _refineWithEdgeDetection = true;
    private int _edgeDetectionThreshold = 30;
    private int _colorThreshold = 25;
    
    // ViewModel Generation with OCR
    private string _viewModelTab = "extracted"; // extracted, viewmodel, razor, preview
    private string _extractedTextJson = "";
    private string _generatedViewModel = "";
    private string _generatedRazorWithParams = "";
    private string _viewModelPreviewHtml = "";

    // Code Preview Mode
    private string _codeViewMode = "code"; // code, preview, split

    private async Task StartSignIn()
    {
        _error = "";
        _state = AppState.SigningIn;
        _userCode = "";
        _verificationUrl = "";
        _copied = false;
        _loginTimedOut = false;
        _remainingSeconds = LoginTimeoutSeconds;
        
        // Setup escape key handler
        _dotNetRef?.Dispose();
        _dotNetRef = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("setupLoginEscapeHandler", _dotNetRef);
        
        // Create cancellation token for timeout
        _loginCancellation?.Cancel();
        _loginCancellation?.Dispose();
        _loginCancellation = new CancellationTokenSource();
        
        // Start countdown timer
        _countdownTimer?.Stop();
        _countdownTimer?.Dispose();
        _countdownTimer = new System.Timers.Timer(1000);
        _countdownTimer.Elapsed += async (s, e) =>
        {
            _remainingSeconds--;
            if (_remainingSeconds <= 0)
            {
                _countdownTimer?.Stop();
                _loginCancellation?.Cancel();
            }
            await InvokeAsync(StateHasChanged);
        };
        _countdownTimer.Start();
        
        StateHasChanged();
        
        try
        {
            var authTask = AzureOpenAI.GetAuthenticationStatusAsync();
            
            // Poll for the device code with cancellation check
            for (int i = 0; i < 100 && string.IsNullOrEmpty(AzureOpenAI.UserCode); i++)
            {
                if (_loginCancellation?.Token.IsCancellationRequested == true)
                {
                    throw new OperationCanceledException("Login was cancelled or timed out");
                }
                await Task.Delay(100);
            }
            
            if (!string.IsNullOrEmpty(AzureOpenAI.UserCode))
            {
                _userCode = AzureOpenAI.UserCode;
                _verificationUrl = AzureOpenAI.VerificationUrl ?? "https://microsoft.com/devicelogin";
                StateHasChanged();
                
                // Copy to clipboard only - user must click button to open browser
                await Task.Delay(300);
                await CopyToClipboard(_userCode);
            }
            
            // Wait for auth with timeout
            var timeoutTask = Task.Delay(TimeSpan.FromSeconds(LoginTimeoutSeconds), _loginCancellation.Token);
            var completedTask = await Task.WhenAny(authTask, timeoutTask);
            
            if (completedTask == timeoutTask || _loginCancellation.Token.IsCancellationRequested)
            {
                _loginTimedOut = true;
                _error = "Login timed out. Please try again or check your settings.";
                _state = AppState.NotSignedIn;
                AzureOpenAI.SignOut();
            }
            else
            {
                var status = await authTask;
                
                if (status.IsAuthenticated)
                {
                    _userName = status.UserName ?? "User";
                    _state = AppState.SignedIn;
                }
                else
                {
                    _error = status.ErrorMessage ?? "Sign in failed";
                    _state = AppState.NotSignedIn;
                }
            }
        }
        catch (OperationCanceledException)
        {
            _loginTimedOut = true;
            _error = "Login was cancelled or timed out. Please try again.";
            _state = AppState.NotSignedIn;
            AzureOpenAI.SignOut();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
            _state = AppState.NotSignedIn;
        }
        finally
        {
            _countdownTimer?.Stop();
            _countdownTimer?.Dispose();
            _countdownTimer = null;
            
            // Cleanup escape handler
            try
            {
                await JS.InvokeVoidAsync("removeLoginEscapeHandler");
                _dotNetRef?.Dispose();
                _dotNetRef = null;
            }
            catch { /* Ignore JS errors during cleanup */ }
        }
        
        StateHasChanged();
    }
    
    private async Task CopyToClipboard(string text)
    {
        if (string.IsNullOrEmpty(text)) return;
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            _copied = true;
            StateHasChanged();
        }
        catch
        {
            try
            {
                var escapedText = JsonSerializer.Serialize(text);
                await JS.InvokeVoidAsync("eval", $@"
                    (function() {{
                        var textArea = document.createElement('textarea');
                        textArea.value = {escapedText};
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                    }})();
                ");
                _copied = true;
            }
            catch
            {
                _copied = false;
            }
            StateHasChanged();
        }
    }
    
    private async Task CopyCodeManual()
    {
        await CopyToClipboard(_userCode);
    }
    
    private async Task OpenLoginPopup()
    {
        try
        {
            // Use the IUrlLauncher service which creates a proper popup with the device code
            await UrlLauncher.OpenUrlAsync(_verificationUrl, _userCode);
        }
        catch (Exception ex)
        {
            _error = $"Failed to open login window: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private string GetLoginUrl()
    {
        if (string.IsNullOrEmpty(_verificationUrl)) return "#";
        return _verificationUrl;
    }
    
    private async Task CancelAsync()
    {
        // Remove escape key handler
        await JS.InvokeVoidAsync("removeLoginEscapeHandler");
        _dotNetRef?.Dispose();
        _dotNetRef = null;
        
        // Cancel ongoing login
        _loginCancellation?.Cancel();
        _loginCancellation?.Dispose();
        _loginCancellation = null;
        
        // Stop countdown timer
        _countdownTimer?.Stop();
        _countdownTimer?.Dispose();
        _countdownTimer = null;
        
        AzureOpenAI.SignOut();
        _state = AppState.NotSignedIn;
        _userCode = "";
        _verificationUrl = "";
        _loginTimedOut = false;
        _remainingSeconds = 0;
    }
    
    private void Cancel()
    {
        _ = CancelAsync();
    }
    
    private void SignOut()
    {
        AzureOpenAI.SignOut();
        _userName = "";
        _message = "";
        _response = "";
        _imagePrompt = "";
        _generatedImageUrl = "";
        _revisedPrompt = "";
        _imageError = "";
        _codeImageUrl = "";
        _generatedCode = "";
        _codeError = "";
        _activeTab = "chat";
        _state = AppState.NotSignedIn;
    }
    
    private void SetChatTab() => _activeTab = "chat";
    private void SetImageTab() => _activeTab = "image";
    private void SetCodeTab() => _activeTab = "code";
    
    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_message)) return;
        
        _sending = true;
        _response = "";
        _chatError = "";
        StateHasChanged();
        
        try
        {
            _response = await AzureOpenAI.GetChatCompletionAsync(_message, "You are a helpful assistant. Be concise.");
        }
        catch (Exception ex)
        {
            _chatError = ex.Message;
        }
        
        _sending = false;
        StateHasChanged();
    }
    
    private async Task GenerateImage()
    {
        if (string.IsNullOrWhiteSpace(_imagePrompt)) return;
        
        _generatingImage = true;
        _generatedImageUrl = "";
        _revisedPrompt = "";
        _imageError = "";
        StateHasChanged();
        
        try
        {
            var result = await AzureOpenAI.GenerateImageAsync(_imagePrompt, _imageSize);
            
            if (result.Success)
            {
                _generatedImageUrl = result.ImageUrl ?? "";
                _revisedPrompt = result.RevisedPrompt ?? "";
            }
            else
            {
                _imageError = result.ErrorMessage ?? "Image generation failed";
            }
        }
        catch (Exception ex)
        {
            _imageError = ex.Message;
        }
        
        _generatingImage = false;
        StateHasChanged();
    }
    
    private async Task DownloadImage()
    {
        if (string.IsNullOrEmpty(_generatedImageUrl)) return;
        
        try
        {
            var fileName = $"generated-image-{DateTime.Now:yyyyMMdd-HHmmss}.png";
            var escapedUrl = JsonSerializer.Serialize(_generatedImageUrl);
            
            await JS.InvokeVoidAsync("eval", $@"
                (async function() {{
                    var imageUrl = {escapedUrl};
                    var fileName = '{fileName}';
                    
                    try {{
                        if (imageUrl.startsWith('data:')) {{
                            var link = document.createElement('a');
                            link.href = imageUrl;
                            link.download = fileName;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }} else {{
                            var response = await fetch(imageUrl);
                            var blob = await response.blob();
                            var url = URL.createObjectURL(blob);
                            var link = document.createElement('a');
                            link.href = url;
                            link.download = fileName;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        }}
                    }} catch (e) {{
                        window.open(imageUrl, '_blank');
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            _imageError = $"Download failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task DownloadExtractedImage(ExtractedImage img)
    {
        if (string.IsNullOrEmpty(img.Base64Data)) return;
        
        try
        {
            var fileName = !string.IsNullOrEmpty(img.SuggestedFilename) 
                ? img.SuggestedFilename 
                : $"extracted-{img.ImageType ?? "image"}-{DateTime.Now:yyyyMMdd-HHmmss}.png";
            
            var dataUrl = $"data:image/png;base64,{img.Base64Data}";
            var escapedDataUrl = JsonSerializer.Serialize(dataUrl);
            
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    var link = document.createElement('a');
                    link.href = {escapedDataUrl};
                    link.download = '{fileName}';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }})();
            ");
        }
        catch (Exception ex)
        {
            _codeError = $"Download failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task DownloadAllExtractedImages()
    {
        if (_extractedImagesResult?.Images == null || !_extractedImagesResult.Images.Any()) return;
        
        try
        {
            var timestamp = DateTime.Now.ToString("yyyyMMdd-HHmmss");
            var index = 0;
            
            foreach (var img in _extractedImagesResult.Images.Where(i => !string.IsNullOrEmpty(i.Base64Data)))
            {
                index++;
                var fileName = !string.IsNullOrEmpty(img.SuggestedFilename) 
                    ? img.SuggestedFilename 
                    : $"extracted-{img.ImageType ?? "image"}-{index:D3}.png";
                
                var dataUrl = $"data:image/png;base64,{img.Base64Data}";
                var escapedDataUrl = JsonSerializer.Serialize(dataUrl);
                
                await JS.InvokeVoidAsync("eval", $@"
                    (function() {{
                        var link = document.createElement('a');
                        link.href = {escapedDataUrl};
                        link.download = '{fileName}';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }})();
                ");
                
                // Small delay between downloads to prevent browser blocking
                await Task.Delay(200);
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Download failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task TriggerFileUpload()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('imageUpload').click()");
    }
    

    private async Task HandleFileUploadNew(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file != null)
            {
                // Read file into memory (max 10MB)
                var maxSize = 10 * 1024 * 1024;
                using var stream = file.OpenReadStream(maxSize);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var bytes = ms.ToArray();
                
                // Convert to base64 data URL
                var base64 = Convert.ToBase64String(bytes);
                var mimeType = file.ContentType;
                _uploadedImageUrl = $"data:{mimeType};base64,{base64}";
                _uploadedImageName = file.Name;
                _uploadedImageBytes = bytes;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _imageError = $"Upload failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private void ClearUploadedImage()
    {
        _uploadedImageUrl = "";
        _uploadedImageName = "";
        _uploadedImageBytes = null;
        StateHasChanged();
    }
    
    private void ClearGeneratedImage()
    {
        _generatedImageUrl = "";
        _revisedPrompt = "";
        _imageError = "";
        StateHasChanged();
    }
    
    // Image to Code Methods
    private async Task TriggerCodeImageUpload()
    {
        await JS.InvokeVoidAsync("eval", "document.getElementById('codeImageUpload').click()");
    }
    
    private async Task HandleCodeImageUpload(ChangeEventArgs e)
    {
        try
        {
            var result = await JS.InvokeAsync<string>("eval", @"
                (function() {
                    return new Promise((resolve, reject) => {
                        var input = document.getElementById('codeImageUpload');
                        if (input.files && input.files[0]) {
                            var file = input.files[0];
                            var reader = new FileReader();
                            reader.onload = function(e) {
                                resolve(JSON.stringify({
                                    name: file.name,
                                    type: file.type || 'image/png',
                                    data: e.target.result
                                }));
                            };
                            reader.onerror = function() { reject('Failed to read file'); };
                            reader.readAsDataURL(file);
                        } else {
                            resolve(null);
                        }
                    });
                })()
            ");
            
            if (!string.IsNullOrEmpty(result) && result != "null")
            {
                var fileData = JsonDocument.Parse(result);
                _codeImageUrl = fileData.RootElement.GetProperty("data").GetString() ?? "";
                _codeImageMimeType = fileData.RootElement.GetProperty("type").GetString() ?? "image/png";
                
                // Extract base64 from data URL
                if (_codeImageUrl.Contains(","))
                {
                    _codeImageBase64 = _codeImageUrl.Split(',')[1];
                }
                
                _codeError = "";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Upload failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task HandleCodeImageUploadNew(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file != null)
            {
                // Read file into memory (max 20MB)
                var maxSize = 20 * 1024 * 1024;
                using var stream = file.OpenReadStream(maxSize);
                using var ms = new MemoryStream();
                await stream.CopyToAsync(ms);
                var bytes = ms.ToArray();
                
                // Convert to base64 data URL
                var base64 = Convert.ToBase64String(bytes);
                var mimeType = file.ContentType ?? "image/png";
                _codeImageUrl = $"data:{mimeType};base64,{base64}";
                _codeImageBase64 = base64;
                _codeImageMimeType = mimeType;
                _codeError = "";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Upload failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private void ClearCodeImage()
    {
        _codeImageUrl = "";
        _codeImageBase64 = "";
        _generatedCode = "";
        _codeError = "";
        _codeCopied = false;
        StateHasChanged();
    }
    
    #region Drag and Drop Handlers
    
    private void HandleDragEnter(DragEventArgs e)
    {
        _isDragOver = true;
        StateHasChanged();
    }
    
    private void HandleDragLeave(DragEventArgs e)
    {
        _isDragOver = false;
        StateHasChanged();
    }
    
    private void HandleDragOver(DragEventArgs e)
    {
        _isDragOver = true;
    }
    
    private async Task HandleDrop(DragEventArgs e)
    {
        _isDragOver = false;
        StateHasChanged();
        
        try
        {
            // Use JavaScript to read the dropped file and return base64
            var result = await JS.InvokeAsync<DropResult>("readDroppedFile");
            if (result != null && !string.IsNullOrEmpty(result.Base64))
            {
                _codeImageBase64 = result.Base64;
                _codeImageMimeType = result.MimeType ?? "image/png";
                _codeImageUrl = $"data:{_codeImageMimeType};base64,{_codeImageBase64}";
                _codeError = "";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Drop failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private class DropResult
    {
        public string? Base64 { get; set; }
        public string? MimeType { get; set; }
        public string? FileName { get; set; }
    }
    
    #endregion
    
    private async Task ConvertImageToCode()
    {
        if (string.IsNullOrEmpty(_codeImageBase64)) return;
        
        _isConvertingToCode = true;
        _generatedCode = "";
        _codeError = "";
        _codeCopied = false;
        StateHasChanged();
        
        try
        {
            // Use ImageToCodeService which uses gpt-4o vision model
            var result = await ImageToCode.GenerateCodeFromBase64Async(
                _codeImageBase64, 
                _codeImageMimeType, 
                _targetFramework
            );
            
            if (result.Success)
            {
                _generatedCode = result.Code ?? "";
                _codeLanguage = result.Language ?? GetLanguageHint(_targetFramework);
                
                // Auto-switch to split view for HTML-based frameworks
                if (_targetFramework is "HTML/CSS" or "Tailwind CSS")
                {
                    _codeViewMode = "split";
                }
            }
            else
            {
                _codeError = $"Conversion failed: {result.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Conversion failed: {ex.Message}";
        }
        
        _isConvertingToCode = false;
        StateHasChanged();
    }
    
    private async Task RunAnalysis()
    {
        if (string.IsNullOrEmpty(_codeImageBase64)) return;
        
        // If code generation is selected, use existing method
        if (_selectedAnalysis == "code")
        {
            await ConvertImageToCode();
            return;
        }
        
        // If code with ViewModel is selected, use special method
        if (_selectedAnalysis == "codeWithViewModel")
        {
            await GenerateCodeWithViewModel();
            return;
        }
        
        _isAnalyzing = true;
        _analysisResult = "";
        _codeError = "";
        ClearAnalysisResults();
        StateHasChanged();
        
        try
        {
            switch (_selectedAnalysis)
            {
                case "extractImages":
                    await RunImageExtractionAsync();
                    break;
                    
                case "describe":
                    var descResult = await VisionService.DescribeImageAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = descResult.Success ? descResult.Content ?? "" : $"Error: {descResult.ErrorMessage}";
                    break;
                    
                case "colors":
                    _colorAnalysis = await VisionService.ExtractColorPaletteAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_colorAnalysis.Success) _codeError = _colorAnalysis.ErrorMessage ?? "Failed to extract colors";
                    break;
                    
                case "typography":
                    _typographyAnalysis = await VisionService.ExtractTypographyAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_typographyAnalysis.Success) _codeError = _typographyAnalysis.ErrorMessage ?? "Failed to extract typography";
                    break;
                    
                case "layout":
                    _layoutAnalysis = await VisionService.ExtractLayoutAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_layoutAnalysis.Success) _codeError = _layoutAnalysis.ErrorMessage ?? "Failed to analyze layout";
                    break;
                    
                case "components":
                    _componentsAnalysis = await VisionService.ExtractUIComponentsAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_componentsAnalysis.Success) _codeError = _componentsAnalysis.ErrorMessage ?? "Failed to extract components";
                    break;
                    
                case "icons":
                    _iconsAnalysis = await VisionService.IdentifyIconsAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_iconsAnalysis.Success) _codeError = _iconsAnalysis.ErrorMessage ?? "Failed to identify icons";
                    break;
                    
                case "accessibility":
                    _accessibilityAnalysis = await VisionService.AnalyzeAccessibilityAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_accessibilityAnalysis.Success) _codeError = _accessibilityAnalysis.ErrorMessage ?? "Failed to analyze accessibility";
                    break;
                    
                case "improvements":
                    var impResult = await VisionService.SuggestImprovementsAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = impResult.Success ? impResult.Content ?? "" : $"Error: {impResult.ErrorMessage}";
                    break;
                    
                case "text":
                    var textResult = await VisionService.ExtractTextAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = textResult.Success ? textResult.Content ?? "" : $"Error: {textResult.ErrorMessage}";
                    break;
                    
                case "comprehensive":
                    _comprehensiveAnalysis = await VisionService.AnalyzeUIAsync(_codeImageBase64, _codeImageMimeType);
                    if (!_comprehensiveAnalysis.Success) _codeError = _comprehensiveAnalysis.ErrorMessage ?? "Failed to perform comprehensive analysis";
                    break;
                
                // ===== NEW ANALYSIS TYPES =====
                
                // Text & OCR
                case "handwriting":
                    var handwritingResult = await VisionService.ReadHandwritingAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = handwritingResult.Success ? $"Handwriting Text:\n{handwritingResult.RecognizedText}\n\nConfidence: {handwritingResult.Confidence:P0}" : $"Error: {handwritingResult.ErrorMessage}";
                    break;
                    
                case "table":
                    var tableResult = await VisionService.ExtractTableAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = tableResult.Success ? FormatTableResult(tableResult) : $"Error: {tableResult.ErrorMessage}";
                    break;
                    
                case "math":
                    var mathResult = await VisionService.ParseMathEquationAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = mathResult.Success ? $"LaTeX: {mathResult.Latex}\n\nPlain Text: {mathResult.PlainText}" : $"Error: {mathResult.ErrorMessage}";
                    break;
                
                // Document Analysis
                case "document":
                    var docResult = await VisionService.ParseDocumentAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = docResult.Success ? $"Document Type: {docResult.DocumentType}\n\nFields:\n{FormatDocumentFields(docResult)}" : $"Error: {docResult.ErrorMessage}";
                    break;
                    
                case "invoice":
                    if (AdvancedAI != null)
                    {
                        var invoiceResult = await AdvancedAI.AnalyzeInvoiceAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = invoiceResult.Success ? FormatInvoiceResult(invoiceResult) : $"Error: {invoiceResult.ErrorMessage}";
                    }
                    else
                    {
                        _analysisResult = "Document Intelligence service not configured";
                    }
                    break;
                    
                case "receipt":
                    if (AdvancedAI != null)
                    {
                        var receiptResult = await AdvancedAI.AnalyzeReceiptAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = receiptResult.Success ? FormatReceiptResult(receiptResult) : $"Error: {receiptResult.ErrorMessage}";
                    }
                    else
                    {
                        _analysisResult = "Document Intelligence service not configured";
                    }
                    break;
                    
                case "chart":
                    var chartResult = await VisionService.ExtractChartDataAsync(_codeImageBase64, _codeImageMimeType);
                    _analysisResult = chartResult.Success ? FormatChartResult(chartResult) : $"Error: {chartResult.ErrorMessage}";
                    break;
                
                // Advanced Analysis
                case "compare":
                    _analysisResult = "Please use the Compare Images feature with two images loaded.";
                    break;
                    
                case "askQuestion":
                    _analysisResult = "Enter your question about the image in the prompt field and click Analyze.";
                    break;
                
                // Image Processing (Azure Vision)
                case "removeBackground":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var bgResult = await AzureVision.RemoveBackgroundAsync(Convert.FromBase64String(_codeImageBase64));
                        if (bgResult.Success && bgResult.Base64Image != null)
                        {
                            _analysisResult = "Background removed successfully!";
                            _processedImageBase64 = bgResult.Base64Image;
                        }
                        else
                        {
                            _codeError = bgResult.ErrorMessage ?? "Failed to remove background";
                        }
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;
                    
                case "upscale":
                    if (AdvancedAI != null)
                    {
                        var upscaleResult = await AdvancedAI.UpscaleImageAsync(Convert.FromBase64String(_codeImageBase64), 2);
                        if (upscaleResult.Success && upscaleResult.Base64Image != null)
                        {
                            _analysisResult = $"Image upscaled from {upscaleResult.OriginalWidth}x{upscaleResult.OriginalHeight} to {upscaleResult.NewWidth}x{upscaleResult.NewHeight}";
                            _processedImageBase64 = upscaleResult.Base64Image;
                        }
                        else
                        {
                            _codeError = upscaleResult.ErrorMessage ?? "Failed to upscale image";
                        }
                    }
                    break;
                    
                case "styleTransfer":
                    if (AdvancedAI != null)
                    {
                        var styleResult = await AdvancedAI.ApplyStyleTransferAsync(Convert.FromBase64String(_codeImageBase64), "sepia");
                        if (styleResult.Success && styleResult.Base64Image != null)
                        {
                            _analysisResult = $"Style '{styleResult.AppliedStyle}' applied successfully!";
                            _processedImageBase64 = styleResult.Base64Image;
                        }
                        else
                        {
                            _codeError = styleResult.ErrorMessage ?? "Failed to apply style";
                        }
                    }
                    break;
                    
                case "segment":
                    if (AdvancedAI != null)
                    {
                        var segmentResult = await AdvancedAI.SegmentImageAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = segmentResult.Success ? $"Found {segmentResult.Segments?.Count ?? 0} segments" : $"Error: {segmentResult.ErrorMessage}";
                    }
                    break;
                    
                case "depthMap":
                    if (AdvancedAI != null)
                    {
                        var depthResult = await AdvancedAI.EstimateDepthAsync(Convert.FromBase64String(_codeImageBase64));
                        if (depthResult.Success && depthResult.Base64DepthMap != null)
                        {
                            _analysisResult = depthResult.Description ?? "Depth map generated";
                            _processedImageBase64 = depthResult.Base64DepthMap;
                        }
                        else
                        {
                            _codeError = depthResult.ErrorMessage ?? "Failed to estimate depth";
                        }
                    }
                    break;
                
                // Detection (Azure Vision)
                case "detectObjects":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var objResult = await AzureVision.DetectObjectsAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = objResult.Success ? FormatObjectDetectionResult(objResult) : $"Error: {objResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;
                    
                case "detectFaces":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var faceResult = await AzureVision.DetectFacesAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = faceResult.Success ? FormatFaceDetectionResult(faceResult) : $"Error: {faceResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;
                    
                case "detectPeople":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var peopleResult = await AzureVision.DetectPeopleAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = peopleResult.Success ? $"Detected {peopleResult.Regions?.Count ?? 0} people in the image" : $"Error: {peopleResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;
                    
                case "detectBrands":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var brandResult = await AzureVision.DetectBrandsAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = brandResult.Success ? FormatBrandDetectionResult(brandResult) : $"Error: {brandResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;
                    
                case "imageType":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var typeResult = await AzureVision.GetImageTypeAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = typeResult.Success ? $"Image Type: {typeResult.ImageType}\nClipArt: {typeResult.IsClipArt}\nLine Drawing: {typeResult.IsLineDrawing}" : $"Error: {typeResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;
                    
                case "adultContent":
                    if (AzureVision != null && AzureVision.IsConfigured)
                    {
                        var adultResult = await AzureVision.DetectAdultContentAsync(Convert.FromBase64String(_codeImageBase64));
                        _analysisResult = adultResult.Success ? $"Adult Content: {adultResult.IsAdultContent} ({adultResult.AdultScore:P0})\nRacy Content: {adultResult.IsRacyContent} ({adultResult.RacyScore:P0})\nGory Content: {adultResult.IsGoryContent} ({adultResult.GoreScore:P0})" : $"Error: {adultResult.ErrorMessage}";
                    }
                    else
                    {
                        _codeError = "Azure Vision service not configured";
                    }
                    break;

                case "extractIcons":
                case "extractLogos":
                    await RunImageExtractionAsync();
                    break;
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Analysis failed: {ex.Message}";
        }
        
        _isAnalyzing = false;
        StateHasChanged();
    }
    
    private async Task RunImageExtractionAsync()
    {
        var imageBytes = Convert.FromBase64String(_codeImageBase64);
        
        // Build extraction options
        var options = new ExtractionOptions
        {
            Mode = _cropMode switch
            {
                "AzureVision" => CropMode.AzureVision,
                "AzureVisionComprehensive" => CropMode.AzureVisionComprehensive,
                "AzureVisionPeople" => CropMode.AzureVisionPeople,
                "HybridPixelPerfect" => CropMode.HybridPixelPerfect,
                "SmartUICards" => CropMode.SmartUICards,
                "ContourDetection" => CropMode.ContourDetection,
                "FloodFillRegions" => CropMode.FloodFillRegions,
                "SmartDetect" => CropMode.SmartDetect,
                "Grid" => CropMode.Grid,
                "Sections" => CropMode.Sections,
                "Components" => CropMode.Components,
                "AIRegions" => CropMode.AIRegions,
                _ => CropMode.AzureVision
            },
            GridRows = _gridRows,
            GridColumns = _gridColumns,
            MinComponentSize = _minComponentSize,
            RefineWithEdgeDetection = _refineWithEdgeDetection,
            EdgeDetectionThreshold = _edgeDetectionThreshold,
            Padding = _extractionAddPadding ? 2 : 0,
            DetectOnly = _extractionDetectOnly,
            ExtractionType = _extractionType
        };
        
        // Handle detect-only mode for AI-based modes
        if (_extractionDetectOnly && (_cropMode == "SmartDetect" || _cropMode == "AIRegions"))
        {
            _imageRegionsResult = await ImageExtraction.IdentifyImageRegionsAsync(imageBytes, _codeImageMimeType);
            if (!_imageRegionsResult.Success)
            {
                _codeError = _imageRegionsResult.ErrorMessage ?? "Failed to identify image regions";
                return;
            }
            
            // Convert regions to extraction result for display
            _extractedImagesResult = new ImageExtractionResult
            {
                Success = true,
                TotalImagesFound = _imageRegionsResult.Regions?.Count ?? 0,
                AnalysisSummary = $"Detected {_imageRegionsResult.Regions?.Count ?? 0} regions (no cropping)",
                Images = _imageRegionsResult.Regions?.Select(r => new ExtractedImage
                {
                    Description = r.Description,
                    ImageType = r.ImageType,
                    BoundingBox = r.BoundingBox,
                    Confidence = r.Confidence,
                    SuggestedFilename = r.SuggestedFilename,
                    Width = r.BoundingBox?.Width ?? 0,
                    Height = r.BoundingBox?.Height ?? 0
                }).ToList()
            };
            return;
        }
        
        // Run extraction based on crop mode
        switch (_cropMode)
        {
            case "Grid":
                _extractedImagesResult = await ImageExtraction.ExtractGridAsync(imageBytes, _codeImageMimeType, _gridRows, _gridColumns);
                break;
                
            case "Sections":
                _extractedImagesResult = await ImageExtraction.ExtractSectionsAsync(imageBytes, _codeImageMimeType);
                break;
                
            case "Components":
                _extractedImagesResult = await ImageExtraction.ExtractComponentsAsync(imageBytes, _codeImageMimeType, _minComponentSize);
                break;
                
            case "SmartDetect":
                _extractedImagesResult = await ImageExtraction.ExtractWithOptionsAsync(imageBytes, _codeImageMimeType, options);
                break;
                
            case "AIRegions":
            default:
                // Use original extraction type-based logic
                switch (_extractionType)
                {
                    case "icons":
                        _extractedImagesResult = await ImageExtraction.ExtractIconsAsync(imageBytes, _codeImageMimeType);
                        break;
                    case "logos":
                        _extractedImagesResult = await ImageExtraction.ExtractLogosAsync(imageBytes, _codeImageMimeType);
                        break;
                    default:
                        _extractedImagesResult = await ImageExtraction.ExtractImagesAsync(imageBytes, _codeImageMimeType);
                        break;
                }
                break;
        }
        
        if (!_extractedImagesResult.Success)
        {
            _codeError = _extractedImagesResult.ErrorMessage ?? "Failed to extract images";
            return;
        }
        
        // Apply filters
        if (_extractedImagesResult.Images != null)
        {
            var filtered = _extractedImagesResult.Images.AsEnumerable();
            
            // Filter by type if not "all"
            if (_extractionType != "all" && _extractionType != "icons" && _extractionType != "logos")
            {
                filtered = filtered.Where(img => 
                    (img.ImageType?.ToLower() ?? "").Contains(_extractionType.ToLower()));
            }
            
            // Filter by size
            filtered = _extractionSizeFilter switch
            {
                "small" => filtered.Where(img => img.Width <= 64 && img.Height <= 64),
                "medium" => filtered.Where(img => (img.Width > 64 || img.Height > 64) && img.Width <= 256 && img.Height <= 256),
                "large" => filtered.Where(img => img.Width > 256 || img.Height > 256),
                "custom" => filtered.Where(img => 
                    img.Width >= _extractionMinSize && img.Height >= _extractionMinSize &&
                    img.Width <= _extractionMaxSize && img.Height <= _extractionMaxSize),
                _ => filtered
            };
            
            // Filter by confidence
            if (_extractionHighConfidenceOnly)
            {
                filtered = filtered.Where(img => img.Confidence >= 80);
            }
            
            var filteredList = filtered.ToList();
            _extractedImagesResult.Images = filteredList;
            _extractedImagesResult.TotalImagesFound = filteredList.Count;
            _extractedImagesResult.AnalysisSummary = $"Extracted {filteredList.Count} {GetExtractionTypeLabel()} images";
        }
    }
    
    private string GetExtractionTypeLabel()
    {
        return _extractionType switch
        {
            "icons" => "icon",
            "logos" => "logo/branding",
            "photos" => "photo",
            "illustrations" => "illustration",
            "charts" => "chart/diagram",
            "backgrounds" => "background",
            "avatars" => "avatar",
            _ => ""
        };
    }
    
    private string GetExtractionResultTitle()
    {
        if (_extractionDetectOnly)
            return "Detected Regions";
            
        return _cropMode switch
        {
            "AzureVision" => "☁️ Azure Vision 4.0 — Pixel-Accurate Extraction",
            "AzureVisionComprehensive" => "☁️ Azure Vision 4.0 — Comprehensive (All Features)",
            "AzureVisionPeople" => "☁️ Azure Vision 4.0 — People/Avatars",
            "HybridPixelPerfect" => "⚡ Hybrid — Azure Vision + GPT-4o + Edge",
            "SmartUICards" => "🖼️ SkiaSharp — UI Cards & Widgets",
            "ContourDetection" => "🖼️ SkiaSharp — Contour Detection",
            "FloodFillRegions" => "🖼️ SkiaSharp — Flood Fill Regions",
            "Grid" => $"🖼️ SkiaSharp — Grid Cells ({_gridRows}×{_gridColumns})",
            "Sections" => "🖼️ SkiaSharp — Page Sections",
            "Components" => "🖼️ SkiaSharp — UI Components",
            "SmartDetect" => "🤖 GPT-4o + Edge Refinement",
            "AIRegions" => "🤖 GPT-4o — AI Detected Regions",
            _ => "Extracted Images"
        };
    }
    
    private async Task CropAndDownloadRegion(BoundingBox bounds)
    {
        try
        {
            var imageBytes = Convert.FromBase64String(_codeImageBase64);
            var cropResult = await ImageExtraction.CropRegionAsync(imageBytes, _codeImageMimeType, bounds);
            
            if (cropResult.Success && cropResult.Base64Data != null)
            {
                var filename = $"cropped-{bounds.X}-{bounds.Y}-{bounds.Width}x{bounds.Height}.png";
                await DownloadImageBase64(cropResult.Base64Data, filename);
            }
            else
            {
                _codeError = cropResult.ErrorMessage ?? "Failed to crop region";
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Crop failed: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task DownloadImageBase64(string base64Data, string filename)
    {
        try
        {
            await JS.InvokeVoidAsync("downloadFile", $"data:image/png;base64,{base64Data}", filename);
        }
        catch (Exception ex)
        {
            _codeError = $"Download failed: {ex.Message}";
        }
    }
    
    private void ClearAnalysisResults()
    {
        _colorAnalysis = null;
        _typographyAnalysis = null;
        _layoutAnalysis = null;
        _componentsAnalysis = null;
        _iconsAnalysis = null;
        _accessibilityAnalysis = null;
        _comprehensiveAnalysis = null;
        _extractedImagesResult = null;
        _imageRegionsResult = null;
    }
    
    private string GetAnalysisButtonText()
    {
        if (_selectedAnalysis == "extractImages")
        {
            var modeLabel = _cropMode switch
            {
                "AzureVision" => "Azure Vision",
                "AzureVisionComprehensive" => "Azure Vision (Full)",
                "AzureVisionPeople" => "People/Avatars",
                "HybridPixelPerfect" => "Hybrid (Best)",
                "SmartUICards" => "UI Cards",
                "ContourDetection" => "Contours",
                "FloodFillRegions" => "Color Regions",
                "Grid" => $"Grid ({_gridRows}×{_gridColumns})",
                "Sections" => "Sections",
                "Components" => "Components",
                "SmartDetect" => "GPT-4o + Edge",
                "AIRegions" => _extractionType switch
                {
                    "all" => "GPT-4o All",
                    "icons" => "Icons",
                    "logos" => "Logos",
                    "photos" => "Photos",
                    "illustrations" => "Illustrations",
                    "charts" => "Charts",
                    "backgrounds" => "Backgrounds",
                    "avatars" => "Avatars",
                    _ => "Images"
                },
                _ => "Images"
            };
            return _extractionDetectOnly ? $"Detect {modeLabel}" : $"Extract {modeLabel}";
        }
        
        return _selectedAnalysis switch
        {
            "code" => "Generate Code",
            "codeWithViewModel" => "Generate Code + ViewModel",
            "describe" => "Describe Design",
            "colors" => "Extract Colors",
            "typography" => "Extract Typography",
            "layout" => "Analyze Layout",
            "components" => "Extract Components",
            "icons" => "Identify Icons",
            "accessibility" => "Run Accessibility Audit",
            "improvements" => "Get Suggestions",
            "text" => "Extract Text",
            "comprehensive" => "Run Full Analysis",
            _ => "Analyze"
        };
    }

    private string GetAnalysisButtonIcon() => _selectedAnalysis switch
    {
        "code" => "💻",
        "codeWithViewModel" => "📋",
        "extractImages" => "🖼️",
        "describe" => "📝",
        "colors" => "🎨",
        "typography" => "🔤",
        "layout" => "📐",
        "components" => "🧩",
        "icons" => "🎯",
        "accessibility" => "♿",
        "improvements" => "💡",
        "text" => "📜",
        "comprehensive" => "🔬",
        _ => "🚀"
    };

    private string GetAnalysisDisplayName() => _selectedAnalysis switch
    {
        "code" => "Generate Code",
        "codeWithViewModel" => "Generate Code + ViewModel",
        "extractImages" => "Extract All Images",
        "describe" => "Describe Design",
        "colors" => "Extract Color Palette",
        "typography" => "Extract Typography",
        "layout" => "Analyze Layout",
        "components" => "Extract UI Components",
        "icons" => "Identify Icons",
        "accessibility" => "Accessibility Audit",
        "improvements" => "Suggest Improvements",
        "text" => "Extract Text (OCR)",
        "comprehensive" => "Full UI Analysis",
        _ => "Analysis"
    };

    private string GetAnalysisDescription() => _selectedAnalysis switch
    {
        "code" => "Convert UI screenshot to production-ready code. Supports HTML/CSS, React, Vue, Blazor, SwiftUI, MAUI XAML, Angular.",
        "codeWithViewModel" => "Generate code with data binding. Extracts text content into a ViewModel/Model class for dynamic content.",
        "extractImages" => "Detect and extract all images, icons, logos, and graphics from a composite screenshot with AI precision.",
        "describe" => "Get a comprehensive description of UI design including layout, colors, components, and style.",
        "colors" => "Extract complete color palette: primary, secondary, accent, background, text colors and gradients.",
        "typography" => "Identify fonts, sizes, weights, line heights, and text styles used in the design.",
        "layout" => "Analyze layout structure: grid system, spacing, sections, breakpoints, and responsive patterns.",
        "components" => "Extract all UI components with their properties, styles, and hierarchy as structured data.",
        "icons" => "Identify icons and suggest matches from popular libraries: Heroicons, Material, Font Awesome.",
        "accessibility" => "WCAG accessibility audit: contrast ratios, text sizes, touch targets, and recommendations.",
        "improvements" => "Get AI suggestions to improve the UI design: UX, accessibility, visual hierarchy.",
        "text" => "OCR: Extract all visible text with position info. Supports multiple languages and fonts.",
        "comprehensive" => "Complete UI analysis: colors, typography, layout, components, icons, and accessibility combined.",
        _ => "Select an analysis type to see details."
    };

    private string GetServiceName() => _selectedAnalysis switch
    {
        "code" or "codeWithViewModel" or "describe" or "colors" or "typography" or "layout" or "components" or "icons" or "accessibility" or "improvements" or "comprehensive" or "text" => "GPT-4o Vision",
        "extractImages" => "GPT-4o + SkiaSharp",
        _ => "Azure AI"
    };

    private string GetServiceBadgeColor() => _selectedAnalysis switch
    {
        "code" or "codeWithViewModel" or "describe" or "colors" or "typography" or "layout" or "components" or "icons" or "accessibility" or "improvements" or "comprehensive" or "text" => "#8b5cf6",
        "extractImages" => "#10b981",
        _ => "#667eea"
    };

    private bool IsAzureVisionRequired() => _selectedAnalysis switch
    {
        "denseCaptions" or "singleCaption" or "smartCrops" or "tags" or "removeBackground" or "detectObjects" or "detectPeople" or "analyzeComprehensive" or "detectFaces" or "detectBrands" or "imageType" or "adultContent" or "imageCategory" => true,
        _ => false
    };

    private async Task CopyCodeToClipboard()
    {
        if (!string.IsNullOrEmpty(_generatedCode))
        {
            try
            {
                // Try modern clipboard API first
                await JS.InvokeVoidAsync("navigator.clipboard.writeText", _generatedCode);
                _codeCopied = true;
                await Task.Delay(100);
                StateHasChanged();
            }
            catch
            {
                try
                {
                    // Fallback to custom clipboard function
                    var success = await JS.InvokeAsync<bool>("copyToClipboard", _generatedCode);
                    _codeCopied = success;
                    StateHasChanged();
                }
                catch
                {
                    // Final fallback
                    try
                    {
                        var escapedText = JsonSerializer.Serialize(_generatedCode);
                        await JS.InvokeVoidAsync("eval", $@"
                            (function() {{
                                var textArea = document.createElement('textarea');
                                textArea.value = {escapedText};
                                textArea.style.position = 'fixed';
                                textArea.style.left = '-9999px';
                                document.body.appendChild(textArea);
                                textArea.focus();
                                textArea.select();
                                document.execCommand('copy');
                                document.body.removeChild(textArea);
                            }})();
                        ");
                        _codeCopied = true;
                        StateHasChanged();
                    }
                    catch
                    {
                        _codeCopied = false;
                        _codeError = "Failed to copy code to clipboard";
                        StateHasChanged();
                    }
                }
            }
            
            // Reset the copied flag after 2 seconds
            if (_codeCopied)
            {
                await Task.Delay(2000);
                _codeCopied = false;
                StateHasChanged();
            }
        }
    }
    
    private bool CanShowPreview()
    {
        // Only HTML-based frameworks can be previewed
        return _targetFramework is "HTML/CSS" or "Tailwind CSS";
    }
    
    private void RefreshPreview()
    {
        // Force re-render by triggering state change
        _previewKey = Guid.NewGuid().ToString();
        StateHasChanged();
    }
    
    private string _previewKey = "";
    
    private string GetPreviewDataUrl()
    {
        if (string.IsNullOrEmpty(_generatedCode)) 
            return "data:text/html,<html><body style='font-family:sans-serif;padding:20px;color:#666;'><h2>No preview available</h2><p>Generate HTML or Tailwind CSS code to see preview</p></body></html>";
        
        var html = GetPreviewHtml();
        var bytes = System.Text.Encoding.UTF8.GetBytes(html);
        var base64 = Convert.ToBase64String(bytes);
        // Add cache-busting parameter using preview key
        return $"data:text/html;charset=utf-8;base64,{base64}#{_previewKey}";
    }
    
    private void SetCodeViewMode()
    {
        _codeViewMode = "code";
    }
    
    private void SetPreviewViewMode()
    {
        _codeViewMode = "preview";
        StateHasChanged();
    }
    
    private void SetSplitViewMode()
    {
        _codeViewMode = "split";
        StateHasChanged();
    }
    
    private async Task OpenPreviewPopup()
    {
        if (string.IsNullOrEmpty(_generatedCode) || !CanShowPreview()) return;
        
        try
        {
            var htmlContent = GetPreviewHtml();
            var escapedHtml = System.Text.Json.JsonSerializer.Serialize(htmlContent);
            
            // Use JavaScript to open a new window and write content directly
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    try {{
                        var htmlContent = {escapedHtml};
                        
                        // Method 1: Open blank window and write content
                        var w = window.open('about:blank', '_blank', 'width=1024,height=768,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no');
                        
                        if (w) {{
                            w.document.open();
                            w.document.write(htmlContent);
                            w.document.close();
                            w.focus();
                            return;
                        }}
                        
                        // Method 2: Try data URL
                        var encoded = btoa(unescape(encodeURIComponent(htmlContent)));
                        var dataUrl = 'data:text/html;charset=utf-8;base64,' + encoded;
                        var w2 = window.open(dataUrl, '_blank');
                        
                        if (w2) {{
                            w2.focus();
                            return;
                        }}
                        
                        // Method 3: Download as fallback
                        alert('Could not open preview window. The file will be downloaded instead.');
                        var blob = new Blob([htmlContent], {{type: 'text/html'}});
                        var url = URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'preview.html';
                        a.click();
                        URL.revokeObjectURL(url);
                        
                    }} catch(e) {{
                        console.error('Preview error:', e);
                        alert('Could not open preview: ' + e.message);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Preview error: {ex.Message}");
        }
    }
    
    private async Task DownloadPreviewHtml()
    {
        if (string.IsNullOrEmpty(_generatedCode) || !CanShowPreview()) return;
        
        try
        {
            var htmlContent = GetPreviewHtml();
            var bytes = System.Text.Encoding.UTF8.GetBytes(htmlContent);
            var base64 = Convert.ToBase64String(bytes);
            
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    try {{
                        var base64 = '{base64}';
                        var binary = atob(base64);
                        var bytes = new Uint8Array(binary.length);
                        for (var i = 0; i < binary.length; i++) {{
                            bytes[i] = binary.charCodeAt(i);
                        }}
                        var blob = new Blob([bytes], {{ type: 'text/html' }});
                        var url = URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'preview-' + new Date().toISOString().slice(0,10) + '.html';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        setTimeout(function() {{ URL.revokeObjectURL(url); }}, 1000);
                    }} catch(e) {{
                        alert('Download failed: ' + e.message);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Download failed: {ex.Message}");
        }
    }
    
    private string GetPreviewHtml()
    {
        if (string.IsNullOrEmpty(_generatedCode)) return "<html><body><p>No code generated yet</p></body></html>";
        
        var htmlContent = _generatedCode.Trim();
        
        // Clean up code block markers if present
        if (htmlContent.StartsWith("```html", StringComparison.OrdinalIgnoreCase))
        {
            htmlContent = htmlContent.Substring(7);
        }
        else if (htmlContent.StartsWith("```"))
        {
            var firstNewline = htmlContent.IndexOf('\n');
            if (firstNewline > 0)
            {
                htmlContent = htmlContent.Substring(firstNewline + 1);
            }
        }
        if (htmlContent.EndsWith("```"))
        {
            htmlContent = htmlContent.Substring(0, htmlContent.Length - 3);
        }
        htmlContent = htmlContent.Trim();
        
        // If it already has a full HTML structure, return as-is
        if (htmlContent.Contains("<!DOCTYPE", StringComparison.OrdinalIgnoreCase) || 
            htmlContent.Contains("<html", StringComparison.OrdinalIgnoreCase))
        {
            return htmlContent;
        }
        
        // Otherwise wrap it in a proper HTML document
        return $@"<!DOCTYPE html>
<html lang=""en"">
<head>
    <meta charset=""UTF-8"">
    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
    <script src=""https://cdn.tailwindcss.com""></script>
    <style>
        * {{ box-sizing: border-box; }}
        body {{ 
            margin: 0; 
            padding: 16px; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            background: #ffffff;
        }}
    </style>
</head>
<body>
{htmlContent}
</body>
</html>";
    }
    
    private static string GetCodeSystemPrompt(string framework)
    {
        var basePrompt = """
            You are an expert frontend developer specializing in converting UI designs to code.
            Analyze the provided UI image and generate clean, well-structured, responsive code that 
            replicates it as closely as possible. Pay attention to:
            - Layout and spacing
            - Colors and gradients
            - Typography and font sizes
            - Border radius and shadows
            - Responsive design
            - Accessibility
            
            Output ONLY the code, no explanations or markdown formatting.
            """;

        return framework switch
        {
            "React" => basePrompt + "\nGenerate React functional components with inline styles or styled-components.",
            "Blazor" => basePrompt + "\nGenerate Blazor components (.razor) with scoped CSS.",
            "SwiftUI" => basePrompt + "\nGenerate SwiftUI views for iOS/macOS.",
            "MAUI XAML" => basePrompt + "\nGenerate .NET MAUI XAML with proper namespaces.",
            "Tailwind CSS" => basePrompt + "\nGenerate HTML with Tailwind CSS classes.",
            "Vue" => basePrompt + "\nGenerate Vue 3 components with Composition API.",
            _ => basePrompt + "\nGenerate semantic HTML5 with embedded CSS."
        };
    }
    
    private static string GetLanguageHint(string framework)
    {
        return framework switch
        {
            "React" => "jsx",
            "Blazor" => "razor",
            "SwiftUI" => "swift",
            "MAUI XAML" => "xml",
            "Vue" => "vue",
            "Tailwind CSS" => "html",
            _ => "html"
        };
    }
    
    private static string CleanCodeOutput(string code)
    {
        code = code.Trim();
        
        if (code.StartsWith("```"))
        {
            var firstNewline = code.IndexOf('\n');
            if (firstNewline > 0)
            {
                code = code[(firstNewline + 1)..];
            }
        }
        
        if (code.EndsWith("```"))
        {
            code = code[..^3];
        }
        
        return code.Trim();
    }
    
    // ViewModel Generation Methods
    private async Task GenerateCodeWithViewModel()
    {
        if (string.IsNullOrEmpty(_codeImageBase64)) return;
        
        _isConvertingToCode = true;
        _extractedTextJson = "";
        _generatedViewModel = "";
        _generatedRazorWithParams = "";
        _viewModelPreviewHtml = "";
        _codeError = "";
        _viewModelTab = "extracted";
        StateHasChanged();
        
        try
        {
            // Step 1: Extract all text/data from the image using VisionService
            var extractPrompt = @"
Analyze this UI image and extract ALL visible text, labels, numbers, and data values.
Return a JSON object where each key is a meaningful property name (camelCase) and each value is the text/number found.
Include: titles, labels, values, button text, status text, dates, numbers, percentages, etc.
Example format:
{
    ""pageTitle"": ""Dashboard"",
    ""userName"": ""John Doe"",
    ""progressValue"": 75,
    ""progressMax"": 100,
    ""statusText"": ""Active"",
    ""buttonText"": ""Submit"",
    ""dateValue"": ""January 2024""
}
Return ONLY valid JSON with actual values from the image.";
            
            var extractResult = await VisionService.AnalyzeImageAsync(_codeImageBase64, _codeImageMimeType, extractPrompt);
            
            if (!extractResult.Success)
            {
                _codeError = $"Text extraction failed: {extractResult.ErrorMessage}";
                _isConvertingToCode = false;
                StateHasChanged();
                return;
            }
            
            _extractedTextJson = CleanJsonOutput(extractResult.Content ?? "{}");
            StateHasChanged();
            
            // Step 2: Generate a ViewModel class from the extracted data
            _generatedViewModel = GenerateViewModelFromJson(_extractedTextJson);
            StateHasChanged();
            
            // Step 3: Generate Razor page with parameters
            var razorPrompt = $@"
Generate a Blazor Razor page that recreates this UI design.
The page should use a ViewModel parameter called 'Model' with these properties extracted from the image:
{_extractedTextJson}

Requirements:
1. Use [Parameter] public PageViewModel Model {{ get; set; }} = new();
2. Replace ALL hardcoded text with @Model.PropertyName
3. Use inline CSS styles (no external stylesheets)
4. Make it responsive and match the design closely
5. Include the @page directive at the top
6. Include the ViewModel class definition in a @code section or reference it

Return ONLY the complete Razor page code.";
            
            var razorResult = await VisionService.AnalyzeImageAsync(_codeImageBase64, _codeImageMimeType, razorPrompt);
            
            if (razorResult.Success)
            {
                _generatedRazorWithParams = CleanCodeOutput(razorResult.Content ?? "");
                
                // Generate preview HTML
                _viewModelPreviewHtml = GeneratePreviewHtml();
            }
            else
            {
                _codeError = $"Razor generation failed: {razorResult.ErrorMessage}";
            }
        }
        catch (Exception ex)
        {
            _codeError = $"Generation failed: {ex.Message}";
        }
        
        _isConvertingToCode = false;
        StateHasChanged();
    }
    
    private string CleanJsonOutput(string json)
    {
        json = json.Trim();
        if (json.StartsWith("```json")) json = json[7..];
        else if (json.StartsWith("```")) json = json[3..];
        if (json.EndsWith("```")) json = json[..^3];
        return json.Trim();
    }
    
    private string GenerateViewModelFromJson(string json)
    {
        try
        {
            using var doc = JsonDocument.Parse(json);
            var sb = new StringBuilder();
            
            sb.AppendLine("namespace YourApp.Models;");
            sb.AppendLine();
            sb.AppendLine("public class PageViewModel");
            sb.AppendLine("{");
            
            foreach (var prop in doc.RootElement.EnumerateObject())
            {
                var propName = char.ToUpper(prop.Name[0]) + prop.Name[1..];
                var propType = prop.Value.ValueKind switch
                {
                    JsonValueKind.Number => prop.Value.TryGetInt32(out _) ? "int" : "double",
                    JsonValueKind.True or JsonValueKind.False => "bool",
                    JsonValueKind.Array => "List<string>",
                    _ => "string"
                };
                
                var defaultValue = prop.Value.ValueKind switch
                {
                    JsonValueKind.Number => prop.Value.ToString(),
                    JsonValueKind.True => "true",
                    JsonValueKind.False => "false",
                    JsonValueKind.String => $"\"{prop.Value.GetString()?.Replace("\"", "\\\"")}\"",
                    _ => "\"\""
                };
                
                sb.AppendLine($"    public {propType} {propName} {{ get; set; }} = {defaultValue};");
            }
            
            sb.AppendLine("}");
            return sb.ToString();
        }
        catch
        {
            return "// Error generating ViewModel - check extracted JSON\npublic class PageViewModel { }";
        }
    }
    
    private string GeneratePreviewHtml()
    {
        // Try to convert Razor-like syntax to plain HTML for preview
        var html = _generatedRazorWithParams;
        
        // Remove @page directive
        html = System.Text.RegularExpressions.Regex.Replace(html, @"@page\s+""[^""]*""", "");
        
        // Remove @code section
        html = System.Text.RegularExpressions.Regex.Replace(html, @"@code\s*\{[\s\S]*\}", "", System.Text.RegularExpressions.RegexOptions.Singleline);
        
        // Try to replace @Model.Property with actual values from extracted JSON
        try
        {
            using var doc = JsonDocument.Parse(_extractedTextJson);
            foreach (var prop in doc.RootElement.EnumerateObject())
            {
                var propName = char.ToUpper(prop.Name[0]) + prop.Name[1..];
                var value = prop.Value.ToString();
                html = html.Replace($"@Model.{propName}", value);
                html = html.Replace($"@(Model.{propName})", value);
            }
        }
        catch { }
        
        // Remove remaining Razor syntax
        html = System.Text.RegularExpressions.Regex.Replace(html, @"@\w+[\.\w]*", "");
        html = System.Text.RegularExpressions.Regex.Replace(html, @"@\([^)]*\)", "");
        
        return $@"<!DOCTYPE html>
<html>
<head>
    <meta charset=""UTF-8"">
    <meta name=""viewport"" content=""width=device-width, initial-scale=1.0"">
    <style>* {{ box-sizing: border-box; }} body {{ margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }}</style>
</head>
<body>
{html}
</body>
</html>";
    }
    
    private async Task CopyExtractedText()
    {
        await CopyToClipboard(_extractedTextJson);
    }
    
    private async Task CopyViewModel()
    {
        await CopyToClipboard(_generatedViewModel);
    }
    
    private async Task CopyRazorCode()
    {
        await CopyToClipboard(_generatedRazorWithParams);
    }
    

    private async Task OpenViewModelPreview()
    {
        if (string.IsNullOrEmpty(_viewModelPreviewHtml)) return;
        
        try
        {
            var escapedHtml = System.Text.Json.JsonSerializer.Serialize(_viewModelPreviewHtml);
            
            // Use JavaScript to open a new window and write content directly
            await JS.InvokeVoidAsync("eval", $@"
                (function() {{
                    try {{
                        var htmlContent = {escapedHtml};
                        
                        // Method 1: Open blank window and write content directly
                        var w = window.open('', '_blank', 'width=600,height=800,scrollbars=yes,resizable=yes,menubar=no,toolbar=no,location=no');
                        
                        if (w) {{
                            w.document.open();
                            w.document.write(htmlContent);
                            w.document.close();
                            w.document.title = 'Preview';
                            w.focus();
                            return;
                        }}
                        
                        // Method 2: Try blob URL
                        var blob = new Blob([htmlContent], {{type: 'text/html;charset=utf-8'}});
                        var url = URL.createObjectURL(blob);
                        var w2 = window.open(url, '_blank', 'width=600,height=800');
                        
                        if (w2) {{
                            w2.focus();
                            // Clean up blob URL after a delay
                            setTimeout(function() {{ URL.revokeObjectURL(url); }}, 1000);
                            return;
                        }}
                        
                        // Method 3: Download as fallback
                        alert('Could not open preview window (popup may be blocked). The file will be downloaded instead.');
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = 'preview.html';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                    }} catch(e) {{
                        console.error('Preview error:', e);
                        alert('Could not open preview: ' + e.message);
                    }}
                }})();
            ");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Preview error: {ex.Message}");
        }
    }
    
    #region Service Info Modal
    
    private void ShowServiceInfoModal() => _showServiceInfoModal = true;
    
    private void ShowExtractionModeInfo() => _showServiceInfoModal = true;
    
    private void ShowApiCoverage() => _showServiceInfoModal = true;

    #endregion

    #region Splitter Drag Functionality
    
    private bool _splitterInitialized = false;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_splitterInitialized)
        {
            _splitterInitialized = true;
            // Inject splitter and drag-drop JavaScript
            await JS.InvokeVoidAsync("eval", @"
                // Splitter drag functionality
                window.initSplitterDrag = function(containerId, leftPaneId, splitterId) {
                    const container = document.getElementById(containerId);
                    const leftPane = document.getElementById(leftPaneId);
                    const splitter = document.getElementById(splitterId);
                    
                    if (!container || !leftPane || !splitter) return;
                    
                    let isDragging = false;
                    let startX = 0;
                    let startWidth = 0;
                    
                    splitter.addEventListener('mousedown', function(e) {
                        isDragging = true;
                        startX = e.clientX;
                        startWidth = leftPane.offsetWidth;
                        document.body.style.cursor = 'col-resize';
                        document.body.style.userSelect = 'none';
                        e.preventDefault();
                    });
                    
                    document.addEventListener('mousemove', function(e) {
                        if (!isDragging) return;
                        const dx = e.clientX - startX;
                        const containerWidth = container.offsetWidth;
                        let newWidth = startWidth + dx;
                        
                        // Constraints
                        const minWidth = 250;
                        const maxWidth = containerWidth * 0.6;
                        
                        if (newWidth < minWidth) newWidth = minWidth;
                        if (newWidth > maxWidth) newWidth = maxWidth;
                        
                        leftPane.style.width = newWidth + 'px';
                    });
                    
                    document.addEventListener('mouseup', function(e) {
                        if (isDragging) {
                            isDragging = false;
                            document.body.style.cursor = '';
                            document.body.style.userSelect = '';
                        }
                    });
                };
                
                // Store last dropped file for reading
                window._lastDroppedFile = null;
                
                // Global drag/drop handler to capture dropped files
                document.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                document.addEventListener('drop', function(e) {
                    e.preventDefault();
                    if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                        const file = e.dataTransfer.files[0];
                        if (file.type.startsWith('image/')) {
                            window._lastDroppedFile = file;
                        }
                    }
                });
                
                // Read dropped file and return base64
                window.readDroppedFile = function() {
                    return new Promise((resolve, reject) => {
                        const file = window._lastDroppedFile;
                        if (!file) {
                            resolve(null);
                            return;
                        }
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const base64 = e.target.result.split(',')[1];
                            resolve({
                                base64: base64,
                                mimeType: file.type,
                                fileName: file.name
                            });
                            window._lastDroppedFile = null;
                        };
                        reader.onerror = function() {
                            reject(new Error('Failed to read file'));
                            window._lastDroppedFile = null;
                        };
                        reader.readAsDataURL(file);
                    });
                };
                
                // Escape key handler for login cancellation
                window.loginEscapeHandler = null;
                window.setupLoginEscapeHandler = function(dotNetRef) {
                    if (window.loginEscapeHandler) {
                        document.removeEventListener('keydown', window.loginEscapeHandler);
                    }
                    window.loginEscapeHandler = function(e) {
                        if (e.key === 'Escape') {
                            dotNetRef.invokeMethodAsync('CancelLoginFromJs');
                        }
                    };
                    document.addEventListener('keydown', window.loginEscapeHandler);
                };
                window.removeLoginEscapeHandler = function() {
                    if (window.loginEscapeHandler) {
                        document.removeEventListener('keydown', window.loginEscapeHandler);
                        window.loginEscapeHandler = null;
                    }
                };
            ");
        }
    }
    
    private async Task StartSplitterDrag(MouseEventArgs e)
    {
        // Initialize splitter drag via JavaScript
        await JS.InvokeVoidAsync("initSplitterDrag", "splitContainer", "leftPane", "splitter");
    }

    #endregion

    #region Service Settings Dialog
    
    private void ShowServiceSettings() => _showServiceSettingsDialog = true;
    
    private void ShowServiceSettingsFromLogin()
    {
        // Cancel any ongoing login first
        Cancel();
        // Then show settings
        _showServiceSettingsDialog = true;
    }
    
    private async Task HandleServiceSettingsSaved(AzureOpenAISettings settings)
    {
        _serviceSettings = settings;
        // Settings are automatically saved to localStorage by the dialog
        // The app would need to restart or refresh services to use new settings
        StateHasChanged();
    }
    
    protected override async Task OnInitializedAsync()
    {
        // Start with settings from appsettings.json (injected via IOptions)
        _serviceSettings = new AzureOpenAISettings
        {
            SubscriptionId = AppSettings.Value.SubscriptionId,
            ResourceGroup = AppSettings.Value.ResourceGroup,
            AccountName = AppSettings.Value.AccountName,
            Endpoint = AppSettings.Value.Endpoint,
            DefaultDeployment = AppSettings.Value.DefaultDeployment,
            ImageDeployment = AppSettings.Value.ImageDeployment,
            VisionDeployment = AppSettings.Value.VisionDeployment,
            VisionEndpoint = AppSettings.Value.VisionEndpoint,
            VisionKey = AppSettings.Value.VisionKey,
            DocumentIntelligenceEndpoint = AppSettings.Value.DocumentIntelligenceEndpoint,
            DocumentIntelligenceKey = AppSettings.Value.DocumentIntelligenceKey,
            CustomVisionEndpoint = AppSettings.Value.CustomVisionEndpoint,
            CustomVisionKey = AppSettings.Value.CustomVisionKey,
            CustomVisionProjectId = AppSettings.Value.CustomVisionProjectId,
            VideoIndexerAccountId = AppSettings.Value.VideoIndexerAccountId,
            VideoIndexerLocation = AppSettings.Value.VideoIndexerLocation,
            VideoIndexerApiKey = AppSettings.Value.VideoIndexerApiKey,
            DalleDeployment = AppSettings.Value.DalleDeployment
        };
        
        // Then merge any localStorage overrides (user customizations)
        try
        {
            var json = await JS.InvokeAsync<string>("localStorage.getItem", "AzureAISettings");
            if (!string.IsNullOrEmpty(json))
            {
                var saved = System.Text.Json.JsonSerializer.Deserialize<AzureOpenAISettings>(json);
                if (saved != null)
                {
                    // Only override with localStorage values if they are not placeholder values
                    MergeLocalStorageSettings(saved);
                }
            }
        }
        catch
        {
            // Use appsettings.json values if localStorage fails
        }
    }
    
    private void MergeLocalStorageSettings(AzureOpenAISettings saved)
    {
        // Only override with saved values that are not empty/placeholder
        if (!string.IsNullOrEmpty(saved.Endpoint) && !saved.Endpoint.Contains("YOUR-"))
            _serviceSettings.Endpoint = saved.Endpoint;
        if (!string.IsNullOrEmpty(saved.SubscriptionId) && !saved.SubscriptionId.Contains("YOUR-"))
            _serviceSettings.SubscriptionId = saved.SubscriptionId;
        if (!string.IsNullOrEmpty(saved.ResourceGroup) && !saved.ResourceGroup.Contains("YOUR-"))
            _serviceSettings.ResourceGroup = saved.ResourceGroup;
        if (!string.IsNullOrEmpty(saved.AccountName) && !saved.AccountName.Contains("YOUR-"))
            _serviceSettings.AccountName = saved.AccountName;
        if (!string.IsNullOrEmpty(saved.DefaultDeployment))
            _serviceSettings.DefaultDeployment = saved.DefaultDeployment;
        if (!string.IsNullOrEmpty(saved.VisionDeployment))
            _serviceSettings.VisionDeployment = saved.VisionDeployment;
        if (!string.IsNullOrEmpty(saved.ImageDeployment))
            _serviceSettings.ImageDeployment = saved.ImageDeployment;
        if (!string.IsNullOrEmpty(saved.DalleDeployment))
            _serviceSettings.DalleDeployment = saved.DalleDeployment;
        if (!string.IsNullOrEmpty(saved.VisionEndpoint) && !saved.VisionEndpoint.Contains("YOUR-"))
            _serviceSettings.VisionEndpoint = saved.VisionEndpoint;
        if (!string.IsNullOrEmpty(saved.VisionKey) && !saved.VisionKey.Contains("YOUR-"))
            _serviceSettings.VisionKey = saved.VisionKey;
        if (!string.IsNullOrEmpty(saved.DocumentIntelligenceEndpoint) && !saved.DocumentIntelligenceEndpoint.Contains("YOUR-"))
            _serviceSettings.DocumentIntelligenceEndpoint = saved.DocumentIntelligenceEndpoint;
        if (!string.IsNullOrEmpty(saved.DocumentIntelligenceKey) && !saved.DocumentIntelligenceKey.Contains("YOUR-"))
            _serviceSettings.DocumentIntelligenceKey = saved.DocumentIntelligenceKey;
        if (!string.IsNullOrEmpty(saved.CustomVisionEndpoint) && !saved.CustomVisionEndpoint.Contains("YOUR-"))
            _serviceSettings.CustomVisionEndpoint = saved.CustomVisionEndpoint;
        if (!string.IsNullOrEmpty(saved.CustomVisionKey) && !saved.CustomVisionKey.Contains("YOUR-"))
            _serviceSettings.CustomVisionKey = saved.CustomVisionKey;
        if (!string.IsNullOrEmpty(saved.CustomVisionProjectId) && !saved.CustomVisionProjectId.Contains("YOUR-"))
            _serviceSettings.CustomVisionProjectId = saved.CustomVisionProjectId;
        if (!string.IsNullOrEmpty(saved.VideoIndexerAccountId) && !saved.VideoIndexerAccountId.Contains("YOUR-"))
            _serviceSettings.VideoIndexerAccountId = saved.VideoIndexerAccountId;
        if (!string.IsNullOrEmpty(saved.VideoIndexerLocation))
            _serviceSettings.VideoIndexerLocation = saved.VideoIndexerLocation;
        if (!string.IsNullOrEmpty(saved.VideoIndexerApiKey) && !saved.VideoIndexerApiKey.Contains("YOUR-"))
            _serviceSettings.VideoIndexerApiKey = saved.VideoIndexerApiKey;
    }

    #endregion
    
    #region Analysis Result Formatting Helpers
    
    private string FormatTableResult(TableExtractionResult result)
    {
        if (result.Headers == null || result.Rows == null) return "No table data found";
        
        var sb = new StringBuilder();
        sb.AppendLine($"Table: {result.RowCount} rows × {result.ColumnCount} columns\n");
        sb.AppendLine("Headers: " + string.Join(" | ", result.Headers));
        sb.AppendLine(new string('-', 50));
        foreach (var row in result.Rows)
        {
            sb.AppendLine(string.Join(" | ", row));
        }
        return sb.ToString();
    }
    
    private string FormatDocumentFields(DocumentParseResult result)
    {
        if (result.Fields == null) return "No fields extracted";
        
        var sb = new StringBuilder();
        foreach (var field in result.Fields)
        {
            sb.AppendLine($"• {field.Key}: {field.Value}");
        }
        return sb.ToString();
    }
    
    private string FormatInvoiceResult(InvoiceResult result)
    {
        var sb = new StringBuilder();
        sb.AppendLine("📄 INVOICE DETAILS\n");
        if (!string.IsNullOrEmpty(result.VendorName)) sb.AppendLine($"Vendor: {result.VendorName}");
        if (!string.IsNullOrEmpty(result.CustomerName)) sb.AppendLine($"Customer: {result.CustomerName}");
        if (!string.IsNullOrEmpty(result.InvoiceId)) sb.AppendLine($"Invoice #: {result.InvoiceId}");
        if (result.InvoiceDate.HasValue) sb.AppendLine($"Date: {result.InvoiceDate:d}");
        if (result.DueDate.HasValue) sb.AppendLine($"Due Date: {result.DueDate:d}");
        sb.AppendLine();
        if (result.SubTotal.HasValue) sb.AppendLine($"Subtotal: {result.SubTotal:C}");
        if (result.TotalTax.HasValue) sb.AppendLine($"Tax: {result.TotalTax:C}");
        if (result.Total.HasValue) sb.AppendLine($"TOTAL: {result.Total:C}");
        return sb.ToString();
    }
    
    private string FormatReceiptResult(ReceiptResult result)
    {
        var sb = new StringBuilder();
        sb.AppendLine("🧾 RECEIPT DETAILS\n");
        if (!string.IsNullOrEmpty(result.MerchantName)) sb.AppendLine($"Merchant: {result.MerchantName}");
        if (!string.IsNullOrEmpty(result.MerchantAddress)) sb.AppendLine($"Address: {result.MerchantAddress}");
        if (result.TransactionDate.HasValue) sb.AppendLine($"Date: {result.TransactionDate:g}");
        sb.AppendLine();
        if (result.SubTotal.HasValue) sb.AppendLine($"Subtotal: {result.SubTotal:C}");
        if (result.Tax.HasValue) sb.AppendLine($"Tax: {result.Tax:C}");
        if (result.Tip.HasValue) sb.AppendLine($"Tip: {result.Tip:C}");
        if (result.Total.HasValue) sb.AppendLine($"TOTAL: {result.Total:C}");
        return sb.ToString();
    }
    
    private string FormatChartResult(ChartDataResult result)
    {
        var sb = new StringBuilder();
        sb.AppendLine($"📈 Chart Type: {result.ChartType}");
        if (!string.IsNullOrEmpty(result.Title)) sb.AppendLine($"Title: {result.Title}");
        if (result.Labels?.Any() == true) sb.AppendLine($"Labels: {string.Join(", ", result.Labels)}");
        if (result.Series?.Any() == true)
        {
            sb.AppendLine("\nData Series:");
            foreach (var series in result.Series)
            {
                sb.AppendLine($"  {series.Name}: [{string.Join(", ", series.Values ?? new List<double>())}]");
            }
        }
        return sb.ToString();
    }
    
    private string FormatObjectDetectionResult(AzureVisionResult result)
    {
        if (result.Regions == null || !result.Regions.Any()) return "No objects detected";
        
        var sb = new StringBuilder();
        sb.AppendLine($"Detected {result.Regions.Count} objects:\n");
        foreach (var obj in result.Regions)
        {
            sb.AppendLine($"• {obj.Caption ?? obj.RegionType ?? "Object"} ({obj.Confidence:P0}) at [{obj.X}, {obj.Y}] {obj.Width}×{obj.Height}");
        }
        return sb.ToString();
    }
    
    private string FormatFaceDetectionResult(FaceDetectionResult result)
    {
        if (result.Faces == null || !result.Faces.Any()) return "No faces detected";
        
        var sb = new StringBuilder();
        sb.AppendLine($"Detected {result.Faces.Count} faces:\n");
        int i = 1;
        foreach (var face in result.Faces)
        {
            sb.AppendLine($"Face {i++}:");
            if (face.Age > 0) sb.AppendLine($"  Age: ~{face.Age}");
            if (!string.IsNullOrEmpty(face.Gender)) sb.AppendLine($"  Gender: {face.Gender}");
            sb.AppendLine($"  Location: [{face.X}, {face.Y}] {face.Width}×{face.Height}");
        }
        return sb.ToString();
    }
    
    private string FormatBrandDetectionResult(BrandDetectionResult result)
    {
        if (result.Brands == null || !result.Brands.Any()) return "No brands/logos detected";
        
        var sb = new StringBuilder();
        sb.AppendLine($"Detected {result.Brands.Count} brands:\n");
        foreach (var brand in result.Brands)
        {
            sb.AppendLine($"• {brand.Name} ({brand.Confidence:P0}) at [{brand.X}, {brand.Y}]");
        }
        return sb.ToString();
    }
    
    #endregion
}